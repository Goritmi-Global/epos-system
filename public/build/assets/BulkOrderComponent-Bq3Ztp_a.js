import{_ as ne,r as h,y as Q,o as se,c as R,E as oe,f as r,b as a,e as l,B as ie,m as _,i as f,d as B,w as J,t as u,u as U,F as x,g as D,k as I,v as E,S as O,q as g}from"./app-BoyYQDe8.js";import{s as re}from"./index-Dbc8WUb1.js";import{u as ae}from"./useFormatters-D_81Aa_M.js";import"./index-L2ub2HX8.js";import"./index-C31nZpoI.js";import"./index-CRQzX_M8.js";import"./index-DfVEt9cK.js";const ue={class:"modal fade",id:"bulkOrderModal",tabindex:"-1","aria-hidden":"true"},de={class:"modal-dialog modal-xl modal-dialog-centered"},ce={class:"modal-content rounded-4"},pe={class:"modal-body"},ve={class:"nav nav-tabs mb-4",role:"tablist"},me={class:"nav-item",role:"presentation"},_e={class:"nav-item",role:"presentation"},ye={key:0},fe={class:"mb-3"},be={key:0},he={key:1},ge={key:0,class:"text-danger"},Pe={class:"table-responsive"},ke={class:"table align-middle"},Ue=["onUpdate:modelValue","onInput"],Ie={key:0,class:"text-danger"},we=["onUpdate:modelValue","onChange","onFocus"],qe={value:null},xe=["value"],De=["onUpdate:modelValue","onInput"],Ve={key:0,class:"text-danger"},Se={key:0,class:"text-danger"},Ce=["onClick"],Ne={class:"text-end fw-bold mt-3"},Ee={key:1},Me={class:"table-responsive"},Fe={class:"table align-middle"},Be=["onUpdate:modelValue"],Oe=["value"],$e={key:0,class:"text-danger d-block"},Te=["onUpdate:modelValue","onInput"],Ae={key:0,class:"text-danger"},je=["onUpdate:modelValue","onChange","onFocus"],Le={value:null},ze=["value"],Qe=["onUpdate:modelValue","onInput"],Re={key:0,class:"text-danger"},Je={key:0,class:"text-danger"},Ze=["onClick"],Ge={class:"text-end fw-bold mt-3"},He={class:"modal-footer"},Ke=["disabled"],We={key:0},Xe={key:1},Ye=["disabled"],et={key:0},tt={key:1},lt={__name:"BulkOrderComponent",props:{suppliers:{type:Array,default:()=>[]},items:{type:Array,default:()=>[]}},emits:["refresh-data"],setup(V,{emit:Z}){const{formatCurrencySymbol:S,dateFmt:$}=ae(),T=V,M=h({}),A=Z,y=h("single"),w=h(null),C=h(!1),d=h({}),c=h([]),N=h(!1),b=h({}),p=h([]);Q(()=>T.items,t=>{c.value=t.map(n=>({...n,qty:0,unitPrice:0,expiry:null,subtotal:0,selected_derived_unit_id:null,selectedDerivedUnitInfo:null,derived_units:[]}))},{immediate:!0}),Q(()=>T.items,t=>{p.value=t.map(n=>({...n,qty:0,unitPrice:0,expiry:null,subtotal:0,supplier_id:n.preferred_supplier_id||n.supplier_id||null,selected_derived_unit_id:null,selectedDerivedUnitInfo:null,derived_units:[]}))},{immediate:!0}),se(()=>{feather.replace();const t=document.getElementById("bulkOrderModal");t&&(t.addEventListener("show.bs.modal",()=>{y.value="single"}),t.addEventListener("hide.bs.modal",()=>{y.value="single"}))});function F(t){let n=Number(t.qty)||0;const i=Number(t.unitPrice)||0;t.selected_derived_unit_id&&t.selectedDerivedUnitInfo&&(Number(t.selectedDerivedUnitInfo.conversion_factor),n=n),t.subtotal=n*i}function G(t){let n=Number(t.qty)||0;const i=Number(t.unitPrice)||0;t.selected_derived_unit_id&&t.selectedDerivedUnitInfo&&(Number(t.selectedDerivedUnitInfo.conversion_factor),n=n),t.subtotal=n*i}function j(t){t.qty<0&&(t.qty=0),F(t)}function L(t){if(t.unitPrice===null||t.unitPrice===void 0||t.unitPrice===""){t.unitPrice="",t.subtotal=0;return}t.unitPrice<0&&(t.unitPrice=0),F(t)}function H(t){c.value[t].qty=0,c.value[t].unitPrice=0,c.value[t].expiry=null,c.value[t].subtotal=0,c.value[t].selected_derived_unit_id=null,c.value[t].selectedDerivedUnitInfo=null,c.value[t].derived_units&&(c.value[t].derived_units=[])}function K(t){p.value[t].qty=0,p.value[t].unitPrice=0,p.value[t].expiry=null,p.value[t].subtotal=0,p.value[t].supplier_id=null,p.value[t].selected_derived_unit_id=null,p.value[t].selectedDerivedUnitInfo=null,p.value[t].derived_units&&(p.value[t].derived_units=[])}async function z(t){try{const n=t.unit_id??t.unitId??null;if(!n){t.derived_units=[];return}if(M.value[n]){t.derived_units=M.value[n];return}const i=await axios.get("/units",{params:{per_page:200}}),o=(i.data?.data??i.data??[]).filter(s=>s.base_unit_id!==null&&Number(s.base_unit_id)===Number(n));M.value[n]=o,t.derived_units=o}catch(n){console.error("loadDerivedUnits error:",n),t.derived_units=[]}}function W(t){t.selected_derived_unit_id?t.selectedDerivedUnitInfo=t.derived_units.find(n=>n.id===t.selected_derived_unit_id):t.selectedDerivedUnitInfo=null,F(t)}function X(t){t.selected_derived_unit_id?t.selectedDerivedUnitInfo=t.derived_units.find(n=>n.id===t.selected_derived_unit_id):t.selectedDerivedUnitInfo=null,G(t)}const Y=R(()=>c.value.reduce((t,n)=>t+(Number(n.subtotal)||0),0)),ee=R(()=>p.value.reduce((t,n)=>t+(Number(n.subtotal)||0),0));async function te(){d.value={},w.value||(d.value.supplier="Please select a supplier");const t=new Date().toISOString().split("T")[0],n=[];if(console.log("Raw bulkItems before processing:",JSON.parse(JSON.stringify(c.value))),c.value.forEach((e,o)=>{console.log(`Processing item ${o}:`,{id:e.id,name:e.name,qty:e.qty,unitPrice:e.unitPrice,selected_derived_unit_id:e.selected_derived_unit_id,selectedDerivedUnitInfo:e.selectedDerivedUnitInfo});const s=e.qty||e.unitPrice||e.expiry,v={};if(s){let m=Number(e.qty)||0;if(e.selected_derived_unit_id&&e.selectedDerivedUnitInfo){const q=Number(e.selectedDerivedUnitInfo.conversion_factor)||1;m=m*q,console.log(`Applied conversion: ${e.qty} * ${q} = ${m}`)}const P=e.unitPrice!==null&&e.unitPrice!==void 0&&e.unitPrice!==""?Number(e.unitPrice):0;console.log("Entered Price:",P,"Type:",typeof e.unitPrice,"Raw value:",e.unitPrice);const k=e.selectedDerivedUnitInfo&&P>0?Number((P/Number(e.selectedDerivedUnitInfo.conversion_factor)).toFixed(4)):P;if(console.log("Base Unit Price:",k),(!m||m<=0)&&(v.qty="Quantity is required"),(!P||P<=0)&&(v.unitPrice="Unit Price is required"),e.expiry?new Date(e.expiry)<new Date(t)&&(v.expiry="Expiry must be today or later"):v.expiry="Expiry date is required",Object.keys(v).length>0)d.value[o]=v;else{const q={product_id:e.id,quantity:m,unit_price:k,expiry:e.expiry};console.log("Pushing item to validItems:",q),n.push(q)}}}),console.log("Valid Items to submit:",n),!w.value){g.error("Please select a supplier");return}if(n.length===0){g.error("No valid items to submit");return}if(Object.keys(d.value).length>0){g.error("Please fix the highlighted errors");return}const i={supplier_id:w.value,purchase_date:t,status:"completed",items:n};console.log("Final Payload:",i),C.value=!0;try{await axios.post("/purchase-orders",i),g.success("Bulk order created successfully!"),A("refresh-data"),w.value=null,c.value.forEach(o=>{o.qty=0,o.unitPrice=0,o.expiry=null,o.subtotal=0,o.selected_derived_unit_id=null,o.selectedDerivedUnitInfo=null}),bootstrap.Modal.getInstance(document.getElementById("bulkOrderModal"))?.hide()}catch(e){console.error(e),g.error("Failed to save bulk order")}finally{C.value=!1}}async function le(){b.value={};const t=new Date().toISOString().split("T")[0],n={};if(p.value.forEach((i,e)=>{const o=i.qty||i.unitPrice||i.expiry,s={};if(o){i.supplier_id||(s.supplier_id="Supplier is required");let v=Number(i.qty)||0;if(i.selected_derived_unit_id&&i.selectedDerivedUnitInfo){const k=Number(i.selectedDerivedUnitInfo.conversion_factor)||1;v=v*k}const m=i.unitPrice!==null&&i.unitPrice!==void 0&&i.unitPrice!==""?Number(i.unitPrice):0,P=i.selectedDerivedUnitInfo&&m>0?Number((m/Number(i.selectedDerivedUnitInfo.conversion_factor)).toFixed(4)):m;if((!v||v<=0)&&(s.qty="Quantity is required"),(!m||m<=0)&&(s.unitPrice="Unit Price is required"),i.expiry?new Date(i.expiry)<new Date(t)&&(s.expiry="Expiry must be today or later"):s.expiry="Expiry date is required",Object.keys(s).length>0)b.value[e]=s;else{const k=i.supplier_id;n[k]||(n[k]=[]),n[k].push({product_id:i.id,quantity:v,unit_price:P,expiry:i.expiry})}}}),Object.keys(n).length===0){g.error("No valid items to submit");return}if(Object.keys(b.value).length>0){g.error("Please fix the highlighted errors");return}N.value=!0;try{for(const[e,o]of Object.entries(n)){const s={supplier_id:parseInt(e),purchase_date:t,status:"completed",items:o};await axios.post("/purchase-orders",s)}g.success("Multiple orders created successfully!"),A("refresh-data"),p.value.forEach(e=>{e.qty=0,e.unitPrice=0,e.expiry=null,e.subtotal=0,e.supplier_id=null,e.selected_derived_unit_id=null,e.selectedDerivedUnitInfo=null}),bootstrap.Modal.getInstance(document.getElementById("bulkOrderModal"))?.hide(),setTimeout(()=>{document.querySelectorAll(".modal-backdrop").forEach(e=>e.remove()),document.body.classList.remove("modal-open"),document.body.style.removeProperty("overflow"),document.body.style.removeProperty("padding-right")},100)}catch(i){console.error(i),g.error("Failed to save multiple orders")}finally{N.value=!1}}return(t,n)=>{const i=oe("VueDatePicker");return a(),r("div",ue,[l("div",de,[l("div",ce,[n[9]||(n[9]=ie('<div class="modal-header" data-v-aeedeabd><h5 class="modal-title fw-semibold" data-v-aeedeabd>Bulk Purchase</h5><button class="absolute top-2 right-2 p-2 rounded-full hover:bg-gray-100 transition transform hover:scale-110" data-bs-dismiss="modal" aria-label="Close" title="Close" data-v-aeedeabd><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" data-v-aeedeabd><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" data-v-aeedeabd></path></svg></button></div>',1)),l("div",pe,[l("ul",ve,[l("li",me,[l("button",{class:f(["nav-link",{active:y.value==="single"}]),onClick:n[0]||(n[0]=e=>y.value="single"),type:"button",role:"tab"}," Single Purchase ",2)]),l("li",_e,[l("button",{class:f(["nav-link",{active:y.value==="multiple"}]),onClick:n[1]||(n[1]=e=>y.value="multiple"),type:"button",role:"tab"}," Multiple Purchase ",2)])]),y.value==="single"?(a(),r("div",ye,[l("div",fe,[n[3]||(n[3]=l("label",{class:"form-label"},"Preferred Supplier",-1)),B(U(re),{modelValue:w.value,"onUpdate:modelValue":n[2]||(n[2]=e=>w.value=e),options:V.suppliers,filter:"",optionLabel:"name",optionValue:"id",placeholder:"Select Supplier",class:f(["w-100",{"is-invalid":d.value.supplier}]),appendTo:"self",autoZIndex:!0,baseZIndex:2e3},{value:J(e=>[e.value?(a(),r("div",be,u(V.suppliers.find(o=>o.id===e.value)?.name||"Select Supplier"),1)):(a(),r("span",he,u(e.placeholder),1))]),option:J(e=>[l("div",null,u(e.option.name),1)]),_:1},8,["modelValue","options","class"]),d.value.supplier?(a(),r("small",ge,u(d.value.supplier),1)):_("",!0)]),l("div",Pe,[l("table",ke,[n[5]||(n[5]=l("thead",null,[l("tr",null,[l("th",null,"Name"),l("th",null,"Category"),l("th",null,"Unit"),l("th",null,"Qty"),l("th",null,"Unit"),l("th",null,"Unit Price"),l("th",null,"Expiry"),l("th",null,"Subtotal"),l("th")])],-1)),l("tbody",null,[(a(!0),r(x,null,D(c.value,(e,o)=>(a(),r("tr",{key:e.id},[l("td",null,u(e.name),1),l("td",null,u(e.category?.name||"-"),1),l("td",null,u(e.unit_name),1),l("td",null,[I(l("input",{type:"number",min:"0","onUpdate:modelValue":s=>e.qty=s,class:f(["form-control",{"is-invalid":d.value[o]?.qty}]),onInput:s=>j(e)},null,42,Ue),[[E,e.qty,void 0,{number:!0}]]),d.value[o]?.qty?(a(),r("small",Ie,u(d.value[o].qty),1)):_("",!0)]),l("td",null,[I(l("select",{class:"form-select","onUpdate:modelValue":s=>e.selected_derived_unit_id=s,onChange:s=>W(e),onFocus:s=>z(e)},[l("option",qe,"Base ("+u(e.unit_name)+")",1),(a(!0),r(x,null,D(e.derived_units||[],s=>(a(),r("option",{key:s.id,value:s.id},u(s.name),9,xe))),128))],40,we),[[O,e.selected_derived_unit_id]])]),l("td",null,[I(l("input",{type:"number",min:"0","onUpdate:modelValue":s=>e.unitPrice=s,class:f(["form-control",{"is-invalid":d.value[o]?.unitPrice}]),onInput:s=>L(e)},null,42,De),[[E,e.unitPrice,void 0,{number:!0}]]),d.value[o]?.unitPrice?(a(),r("small",Ve,u(d.value[o].unitPrice),1)):_("",!0)]),l("td",null,[B(i,{modelValue:e.expiry,"onUpdate:modelValue":s=>e.expiry=s,format:U($),"min-date":new Date,enableTimePicker:!1,teleport:!1,placeholder:"Select date",class:f({"is-invalid":d.value[o]?.expiry})},null,8,["modelValue","onUpdate:modelValue","format","min-date","class"]),d.value[o]?.expiry?(a(),r("small",Se,u(d.value[o].expiry),1)):_("",!0)]),l("td",null,u(U(S)(e.subtotal.toFixed(2))),1),l("td",null,[l("button",{class:"btn btn-sm btn-outline-danger d-flex align-items-center justify-content-center",onClick:s=>H(o),title:"Clear",style:{width:"36px",height:"36px"}},[...n[4]||(n[4]=[l("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",fill:"currentColor",viewBox:"0 0 16 16"},[l("path",{"fill-rule":"evenodd",d:"M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"}),l("path",{d:"M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"})],-1)])],8,Ce)])]))),128))])])]),l("div",Ne," Total: "+u(U(S)(Y.value.toFixed(2))),1)])):_("",!0),y.value==="multiple"?(a(),r("div",Ee,[l("div",Me,[l("table",Fe,[n[8]||(n[8]=l("thead",null,[l("tr",null,[l("th",null,"Name"),l("th",null,"Category"),l("th",null,"Unit"),l("th",null,"Supplier"),l("th",null,"Qty"),l("th",null,"Unit"),l("th",null,"Unit Price"),l("th",null,"Expiry"),l("th",null,"Subtotal"),l("th")])],-1)),l("tbody",null,[(a(!0),r(x,null,D(p.value,(e,o)=>(a(),r("tr",{key:e.id},[l("td",null,u(e.name),1),l("td",null,u(e.category?.name||"-"),1),l("td",null,u(e.unit_name),1),l("td",null,[I(l("select",{"onUpdate:modelValue":s=>e.supplier_id=s,class:f(["form-select w-100",{"is-invalid":b.value[o]?.supplier_id}])},[n[6]||(n[6]=l("option",{value:"",disabled:"",hidden:""},"Select Supplier",-1)),(a(!0),r(x,null,D(V.suppliers,s=>(a(),r("option",{key:s.id,value:s.id},u(s.name),9,Oe))),128))],10,Be),[[O,e.supplier_id]]),b.value[o]?.supplier_id?(a(),r("small",$e,u(b.value[o].supplier_id),1)):_("",!0)]),l("td",null,[I(l("input",{type:"number",min:"0","onUpdate:modelValue":s=>e.qty=s,class:f(["form-control",{"is-invalid":d.value[o]?.qty}]),onInput:s=>j(e)},null,42,Te),[[E,e.qty,void 0,{number:!0}]]),d.value[o]?.qty?(a(),r("small",Ae,u(d.value[o].qty),1)):_("",!0)]),l("td",null,[I(l("select",{class:"form-select","onUpdate:modelValue":s=>e.selected_derived_unit_id=s,onChange:s=>X(e),onFocus:s=>z(e)},[l("option",Le,"Base ("+u(e.unit_name)+")",1),(a(!0),r(x,null,D(e.derived_units||[],s=>(a(),r("option",{key:s.id,value:s.id},u(s.name),9,ze))),128))],40,je),[[O,e.selected_derived_unit_id]])]),l("td",null,[I(l("input",{type:"number",min:"0","onUpdate:modelValue":s=>e.unitPrice=s,class:f(["form-control",{"is-invalid":d.value[o]?.unitPrice}]),onInput:s=>L(e)},null,42,Qe),[[E,e.unitPrice,void 0,{number:!0}]]),d.value[o]?.unitPrice?(a(),r("small",Re,u(d.value[o].unitPrice),1)):_("",!0)]),l("td",null,[B(i,{modelValue:e.expiry,"onUpdate:modelValue":s=>e.expiry=s,position:t.bottom,format:U($),"min-date":new Date,enableTimePicker:!1,teleport:t.body,placeholder:"Select date",class:f({"is-invalid":b.value[o]?.expiry})},null,8,["modelValue","onUpdate:modelValue","position","format","min-date","teleport","class"]),b.value[o]?.expiry?(a(),r("small",Je,u(b.value[o].expiry),1)):_("",!0)]),l("td",null,u(U(S)(e.subtotal.toFixed(2))),1),l("td",null,[l("button",{class:"btn btn-sm btn-outline-danger d-flex align-items-center justify-content-center",onClick:s=>K(o),title:"Clear",style:{width:"36px",height:"36px"}},[...n[7]||(n[7]=[l("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",fill:"currentColor",viewBox:"0 0 16 16"},[l("path",{"fill-rule":"evenodd",d:"M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"}),l("path",{d:"M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"})],-1)])],8,Ze)])]))),128))])])]),l("div",Ge," Total: "+u(U(S)(ee.value.toFixed(2))),1)])):_("",!0)]),l("div",He,[y.value==="single"?(a(),r("button",{key:0,class:"btn btn-primary rounded-pill px-4 py-2",disabled:C.value,onClick:te},[C.value?(a(),r("span",Xe,"Saving...")):(a(),r("span",We,"Save"))],8,Ke)):_("",!0),y.value==="multiple"?(a(),r("button",{key:1,class:"btn btn-primary rounded-pill px-4 py-2",disabled:N.value,onClick:le},[N.value?(a(),r("span",tt,"Saving...")):(a(),r("span",et,"Save"))],8,Ye)):_("",!0)])])])])}}},dt=ne(lt,[["__scopeId","data-v-aeedeabd"]]);export{dt as default};

import{_ as de,r as p,w as Q,c as V,o as oe,g as i,b as u,f as n,l as f,j as h,e as ie,u as x,t as a,F as P,i as w,m as I,v as E,T as L,s as y}from"./app-DiO9MVPc.js";import{s as ue}from"./index-CXGKxkIs.js";import{u as ae}from"./useFormatters-WSM0lB7P.js";import"./index-BJTn-VUn.js";import"./index-DJEzkRKq.js";import"./index-wEurNbc4.js";import"./index-DXxF4gsR.js";const ce={class:"modal fade",id:"addOrderModal",tabindex:"-1","aria-hidden":"true"},pe={class:"modal-dialog modal-xl modal-dialog-centered"},ve={class:"modal-content rounded-4"},_e={class:"modal-body"},fe={class:"nav nav-tabs mb-4",role:"tablist"},me={class:"nav-item",role:"presentation"},ye={class:"nav-item",role:"presentation"},be={key:0},he={class:"mb-3"},ge={key:0,class:"text-danger"},Ie={class:"table-responsive"},Ue={class:"table align-middle"},ke=["onUpdate:modelValue","onInput"],qe={key:0,class:"text-danger"},xe=["onUpdate:modelValue","onChange","onFocus"],Pe={value:null},we=["value"],Se=["onUpdate:modelValue","onInput"],De={key:0,class:"text-danger"},Ce=["onClick"],Ne={class:"text-end fw-bold mt-3"},Ve={key:1},Ee={class:"table-responsive"},Me={class:"table align-middle"},Oe=["onUpdate:modelValue"],Fe=["value"],je={key:0,class:"text-danger d-block"},Le=["onUpdate:modelValue","onInput"],Be={key:0,class:"text-danger"},$e=["onUpdate:modelValue","onChange","onFocus"],Ae={value:null},Te=["value"],ze=["onUpdate:modelValue","onInput"],Qe={key:0,class:"text-danger"},Re=["onClick"],Ze={class:"text-end fw-bold mt-3"},Ge={class:"modal-footer"},He=["disabled"],Je={key:0},Ke={key:1},We=["disabled"],Xe={key:0},Ye={key:1},et={__name:"OrderComponent",props:{suppliers:{type:Array,required:!0},items:{type:Array,required:!0}},emits:["refresh-data"],setup(M,{emit:R}){const{formatCurrencySymbol:S}=ae(),U=M,B=R,m=p("single"),$=p(""),b=p(null);p(!1);const o=p({});p("");const D=p(!1),O=p({});p(null);const C=p(!1),v=p({}),k=p([]);Q(()=>U.items,t=>{k.value=t.map(e=>({...e,qty:0,unitPrice:0,expiry:null,subtotal:0,supplier_id:e.preferred_supplier_id||e.supplier_id||null,selected_derived_unit_id:null,derived_units:[]}))},{immediate:!0}),Q(b,t=>{q.value.forEach(e=>{e.preferred_supplier_id!==t&&e.supplier_id!==t&&(e.qty=0,e.unitPrice=0,e.expiry=null,e.subtotal=0,e.selected_derived_unit_id=null,e.selectedDerivedUnitInfo=null)})}),oe(()=>{feather.replace();const t=document.getElementById("addOrderModal");t&&(t.addEventListener("show.bs.modal",()=>{m.value="single"}),t.addEventListener("hidden.bs.modal",()=>{document.body.classList.remove("modal-open"),document.body.style.overflow="",document.querySelectorAll(".modal-backdrop").forEach(l=>l.remove())}))});const q=V(()=>{const t=$.value.trim().toLowerCase();return t?U.items.filter(e=>("qty"in e||(e.qty=0),"unitPrice"in e||(e.unitPrice=0),"expiry"in e||(e.expiry=null),"subtotal"in e||(e.subtotal=0),"selected_derived_unit_id"in e||(e.selected_derived_unit_id=null),"selectedDerivedUnitInfo"in e||(e.selectedDerivedUnitInfo=null),"derived_units"in e||(e.derived_units=[]),[e.name,e.category?.name??"",e.unit_name??"",String(e.stock??"")].join(" ").toLowerCase().includes(t))):(U.items.forEach(e=>{"qty"in e||(e.qty=0),"unitPrice"in e||(e.unitPrice=0),"expiry"in e||(e.expiry=null),"subtotal"in e||(e.subtotal=0),"selected_derived_unit_id"in e||(e.selected_derived_unit_id=null),"selectedDerivedUnitInfo"in e||(e.selectedDerivedUnitInfo=null),"derived_units"in e||(e.derived_units=[])}),U.items)}),Z=V(()=>{const t=$.value.trim().toLowerCase();let e=U.items;return t&&(e=e.filter(l=>("qty"in l||(l.qty=0),"unitPrice"in l||(l.unitPrice=0),"expiry"in l||(l.expiry=null),"subtotal"in l||(l.subtotal=0),"selected_derived_unit_id"in l||(l.selected_derived_unit_id=null),"selectedDerivedUnitInfo"in l||(l.selectedDerivedUnitInfo=null),"derived_units"in l||(l.derived_units=[]),[l.name,l.category?.name??"",l.unit_name??"",String(l.stock??"")].join(" ").toLowerCase().includes(t)))),b.value?e.filter(l=>{const s=_=>_==null?"":String(_).trim(),r=s(l.preferred_supplier_id??l.preferredSupplierId),d=s(l.supplier_id??l.supplierId),c=s(b.value);return console.log("Preferred Supplier Id: ",r),console.log("Suppliers Id: ",d),r===c||d===c}):e});function F(t){let e=Number(t.qty)||0;const l=Number(t.unitPrice)||0;t.selected_derived_unit_id&&t.selectedDerivedUnitInfo&&(Number(t.selectedDerivedUnitInfo.conversion_factor),e=e),t.subtotal=e*l}function A(t){t.qty<0&&(t.qty=0),F(t)}function T(t){t.unitPrice<0&&(t.unitPrice=0),F(t)}function G(t){let e=Number(t.qty)||0;const l=Number(t.unitPrice)||0;t.selected_derived_unit_id&&t.selectedDerivedUnitInfo&&(Number(t.selectedDerivedUnitInfo.conversion_factor),e=e),t.subtotal=e*l}function H(t){t.qty=0,t.unitPrice=0,t.expiry=null,t.subtotal=0,t.selected_derived_unit_id=null,t.selectedDerivedUnitInfo=null,t.derived_units&&(t.derived_units=[]),le(t)}function J(t){t.qty=0,t.unitPrice=0,t.expiry=null,t.subtotal=0,t.supplier_id=null,t.selected_derived_unit_id=null,t.selectedDerivedUnitInfo=null,t.derived_units&&(t.derived_units=[]),ne(t)}const K=p([]),W=()=>{o.value={},q.value.forEach(t=>{t.selectedDerivedUnitInfo=null,t.selected_derived_unit_id=null}),K.value.forEach(t=>{t.selectedDerivedUnitInfo=null,t.selected_derived_unit_id=null})},N=t=>Math.round((Number(t)||0)*100)/100;p([]);const X=V(()=>N(q.value.reduce((t,e)=>t+Number(e.subtotal||0),0))),Y=V(()=>N(k.value.reduce((t,e)=>t+Number(e.subtotal||0),0)));async function z(t){try{const e=t.unit_id??t.unitId??null;if(!e){t.derived_units=[];return}if(O.value[e]){t.derived_units=O.value[e];return}const l=await axios.get("/units",{params:{per_page:200}}),r=(l.data?.data??l.data??[]).filter(d=>d.base_unit_id!==null&&Number(d.base_unit_id)===Number(e));O.value[e]=r,t.derived_units=r}catch(e){console.error("loadDerivedUnits error:",e),t.derived_units=[]}}function ee(t){t.selected_derived_unit_id?t.selectedDerivedUnitInfo=t.derived_units.find(e=>e.id===t.selected_derived_unit_id):t.selectedDerivedUnitInfo=null,F(t)}function te(t){t.selected_derived_unit_id?t.selectedDerivedUnitInfo=t.derived_units.find(e=>e.id===t.selected_derived_unit_id):t.selectedDerivedUnitInfo=null,G(t)}const le=(t,e=null)=>{o.value&&(!t||!t.id||(e?o.value[t.id]&&(delete o.value[t.id][e],Object.keys(o.value[t.id]).length===0&&delete o.value[t.id]):delete o.value[t.id]))},ne=(t,e=null)=>{v.value&&(!t||!t.id||(e?v.value[t.id]&&(delete v.value[t.id][e],Object.keys(v.value[t.id]).length===0&&delete v.value[t.id]):delete v.value[t.id]))};async function re(){if(o.value={},!b.value){o.value.supplier_id=["Please select a supplier."],y.error("Please select a supplier.");return}const t=new Date().toISOString().split("T")[0],e=[];if(q.value.forEach(s=>{const r=s.qty||s.unitPrice,d={};if(r){let c=Number(s.qty)||0;if(s.selected_derived_unit_id&&s.selectedDerivedUnitInfo){const g=Number(s.selectedDerivedUnitInfo.conversion_factor)||1;c=c*g}const _=Number(s.unitPrice)||0,j=s.selectedDerivedUnitInfo?N(_/Number(s.selectedDerivedUnitInfo.conversion_factor)):_;(!c||c<=0)&&(d.qty=["Quantity is required"]),(!_||_<=0)&&(d.unit_price=["Unit Price is required"]),Object.keys(d).length>0?o.value[s.id]=d:e.push({product_id:s.id,quantity:c,unit_price:j,expiry:s.expiry||null})}}),e.length===0){y.error("No valid items to submit");return}if(Object.keys(o.value).length>0){y.error("Please fix the highlighted errors");return}const l={supplier_id:b.value,purchase_date:t,status:"pending",items:e};D.value=!0;try{await axios.post("/purchase-orders",l),y.success("Purchase order created successfully!"),B("refresh-data"),b.value=null,q.value.forEach(d=>{d.qty=0,d.unitPrice=0,d.expiry=null,d.subtotal=0,d.selected_derived_unit_id=null,d.selectedDerivedUnitInfo=null});const s=document.getElementById("addOrderModal"),r=bootstrap.Modal.getInstance(s);r&&r.hide(),setTimeout(()=>{document.body.classList.remove("modal-open"),document.body.style.overflow="",document.body.style.paddingRight="",document.querySelectorAll(".modal-backdrop").forEach(c=>c.remove())},100)}catch(s){console.error(s),y.error("Failed to save order")}finally{D.value=!1}}async function se(){v.value={};const t=new Date().toISOString().split("T")[0],e={};if(k.value.forEach((l,s)=>{const r=l.qty||l.unitPrice,d={};if(r){l.supplier_id||(d.supplier_id=["Supplier is required"]);let c=Number(l.qty)||0;if(l.selected_derived_unit_id&&l.selectedDerivedUnitInfo){const g=Number(l.selectedDerivedUnitInfo.conversion_factor)||1;c=c*g}const _=Number(l.unitPrice)||0,j=l.selectedDerivedUnitInfo?N(_/Number(l.selectedDerivedUnitInfo.conversion_factor)):_;if((!c||c<=0)&&(d.qty=["Quantity is required"]),(!_||_<=0)&&(d.unit_price=["Unit Price is required"]),Object.keys(d).length>0)v.value[l.id]=d;else{const g=l.supplier_id;e[g]||(e[g]=[]),e[g].push({product_id:l.id,quantity:c,unit_price:j,expiry:l.expiry||null})}}}),Object.keys(e).length===0){y.error("No valid items to submit");return}if(Object.keys(v.value).length>0){y.error("Please fix the highlighted errors");return}C.value=!0;try{for(const[r,d]of Object.entries(e)){const c={supplier_id:parseInt(r),purchase_date:t,status:"pending",items:d};await axios.post("/purchase-orders",c)}y.success("Multiple orders created successfully!"),B("refresh-data"),k.value.forEach(r=>{r.qty=0,r.unitPrice=0,r.expiry=null,r.subtotal=0,r.supplier_id=null,r.selected_derived_unit_id=null,r.selectedDerivedUnitInfo=null});const l=document.getElementById("addOrderModal"),s=bootstrap.Modal.getInstance(l);s&&s.hide(),setTimeout(()=>{document.body.classList.remove("modal-open"),document.body.style.overflow="",document.body.style.paddingRight="",document.querySelectorAll(".modal-backdrop").forEach(d=>d.remove())},300)}catch(l){console.error(l),y.error("Failed to save multiple orders")}finally{C.value=!1}}return(t,e)=>(u(),i("div",ce,[n("div",pe,[n("div",ve,[n("div",{class:"modal-header"},[e[4]||(e[4]=n("h5",{class:"modal-title fw-semibold"},"Order",-1)),n("button",{class:"absolute top-2 right-2 p-2 rounded-full hover:bg-gray-100 transition transform hover:scale-110","data-bs-dismiss":"modal","aria-label":"Close",title:"Close",onClick:W},[...e[3]||(e[3]=[n("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-6 w-6 text-red-500",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor","stroke-width":"2"},[n("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M6 18L18 6M6 6l12 12"})],-1)])])]),n("div",_e,[n("ul",fe,[n("li",me,[n("button",{class:h(["nav-link",{active:m.value==="single"}]),onClick:e[0]||(e[0]=l=>m.value="single"),type:"button",role:"tab"}," Single Order ",2)]),n("li",ye,[n("button",{class:h(["nav-link",{active:m.value==="multiple"}]),onClick:e[1]||(e[1]=l=>m.value="multiple"),type:"button",role:"tab"}," Multiple Order ",2)])]),m.value==="single"?(u(),i("div",be,[n("div",he,[e[5]||(e[5]=n("label",{class:"form-label"},"Preferred Supplier",-1)),ie(x(ue),{modelValue:b.value,"onUpdate:modelValue":e[2]||(e[2]=l=>b.value=l),options:M.suppliers,optionLabel:"name",optionValue:"id",placeholder:"Select Supplier",class:h(["w-100",{"is-invalid":o.value.supplier_id}]),appendTo:"self",autoZIndex:!0,baseZIndex:2e3},null,8,["modelValue","options","class"]),o.value.supplier_id?(u(),i("small",ge,a(o.value.supplier_id[0]),1)):f("",!0)]),n("div",Ie,[n("table",Ue,[e[7]||(e[7]=n("thead",null,[n("tr",null,[n("th",null,"Name"),n("th",null,"Category"),n("th",null,"Unit"),n("th",null,"Stock"),n("th",null,"Qty"),n("th",null,"Unit"),n("th",null,"Unit Price"),n("th",null,"Subtotal"),n("th")])],-1)),n("tbody",null,[(u(!0),i(P,null,w(Z.value,(l,s)=>(u(),i("tr",{key:l.id},[n("td",null,a(l.name),1),n("td",null,a(l.category?.name||"-"),1),n("td",null,a(l.unit_name),1),n("td",null,a(l.stock),1),n("td",null,[I(n("input",{type:"number",min:"0","onUpdate:modelValue":r=>l.qty=r,class:h(["form-control",{"is-invalid":o.value[s]?.qty}]),onInput:r=>A(l)},null,42,ke),[[E,l.qty,void 0,{number:!0}]]),o.value[s]?.qty?(u(),i("small",qe,a(o.value[s].qty),1)):f("",!0)]),n("td",null,[I(n("select",{class:"form-select","onUpdate:modelValue":r=>l.selected_derived_unit_id=r,onChange:r=>ee(l),onFocus:r=>z(l)},[n("option",Pe,"Base ("+a(l.unit_name)+")",1),(u(!0),i(P,null,w(l.derived_units||[],r=>(u(),i("option",{key:r.id,value:r.id},a(r.name),9,we))),128))],40,xe),[[L,l.selected_derived_unit_id]])]),n("td",null,[I(n("input",{type:"number",min:"0","onUpdate:modelValue":r=>l.unitPrice=r,class:h(["form-control",{"is-invalid":o.value[s]?.unitPrice}]),onInput:r=>T(l)},null,42,Se),[[E,l.unitPrice,void 0,{number:!0}]]),o.value[s]?.unitPrice?(u(),i("small",De,a(o.value[s].unitPrice),1)):f("",!0)]),n("td",null,a(x(S)((l.subtotal||0).toFixed(2))),1),n("td",null,[n("button",{class:"btn btn-sm btn-outline-danger d-flex align-items-center justify-content-center",onClick:r=>H(l),title:"Clear",style:{width:"36px",height:"36px"}},[...e[6]||(e[6]=[n("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",fill:"currentColor",viewBox:"0 0 16 16"},[n("path",{"fill-rule":"evenodd",d:"M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"}),n("path",{d:"M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"})],-1)])],8,Ce)])]))),128))])])]),n("div",Ne," Total: "+a(x(S)(X.value.toFixed(2))),1)])):f("",!0),m.value==="multiple"?(u(),i("div",Ve,[n("div",Ee,[n("table",Me,[e[10]||(e[10]=n("thead",null,[n("tr",null,[n("th",null,"Name"),n("th",null,"Category"),n("th",null,"Unit"),n("th",null,"Supplier"),n("th",null,"Qty"),n("th",null,"Unit"),n("th",null,"Unit Price"),n("th",null,"Subtotal"),n("th")])],-1)),n("tbody",null,[(u(!0),i(P,null,w(k.value,(l,s)=>(u(),i("tr",{key:l.id},[n("td",null,a(l.name),1),n("td",null,a(l.category?.name||"-"),1),n("td",null,a(l.unit_name),1),n("td",null,[I(n("select",{"onUpdate:modelValue":r=>l.supplier_id=r,class:h(["form-select w-100",{"is-invalid":v.value[l.id]?.supplier_id}])},[e[8]||(e[8]=n("option",{value:"",disabled:"",hidden:""},"Select Supplier",-1)),(u(!0),i(P,null,w(M.suppliers,r=>(u(),i("option",{key:r.id,value:r.id},a(r.name),9,Fe))),128))],10,Oe),[[L,l.supplier_id]]),v.value[l.id]?.supplier_id?(u(),i("small",je,a(v.value[l.id].supplier_id[0]),1)):f("",!0)]),n("td",null,[I(n("input",{type:"number",min:"0","onUpdate:modelValue":r=>l.qty=r,class:h(["form-control",{"is-invalid":o.value[s]?.qty}]),onInput:r=>A(l)},null,42,Le),[[E,l.qty,void 0,{number:!0}]]),o.value[s]?.qty?(u(),i("small",Be,a(o.value[s].qty),1)):f("",!0)]),n("td",null,[I(n("select",{class:"form-select","onUpdate:modelValue":r=>l.selected_derived_unit_id=r,onChange:r=>te(l),onFocus:r=>z(l)},[n("option",Ae,"Base ("+a(l.unit_name)+")",1),(u(!0),i(P,null,w(l.derived_units||[],r=>(u(),i("option",{key:r.id,value:r.id},a(r.name),9,Te))),128))],40,$e),[[L,l.selected_derived_unit_id]])]),n("td",null,[I(n("input",{type:"number",min:"0","onUpdate:modelValue":r=>l.unitPrice=r,class:h(["form-control",{"is-invalid":o.value[s]?.unitPrice}]),onInput:r=>T(l)},null,42,ze),[[E,l.unitPrice,void 0,{number:!0}]]),o.value[s]?.unitPrice?(u(),i("small",Qe,a(o.value[s].unitPrice),1)):f("",!0)]),n("td",null,a(x(S)((l.subtotal||0).toFixed(2))),1),n("td",null,[n("button",{class:"btn btn-sm btn-outline-danger d-flex align-items-center justify-content-center",onClick:r=>J(l),title:"Clear",style:{width:"36px",height:"36px"}},[...e[9]||(e[9]=[n("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",fill:"currentColor",viewBox:"0 0 16 16"},[n("path",{"fill-rule":"evenodd",d:"M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"}),n("path",{d:"M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"})],-1)])],8,Re)])]))),128))])])]),n("div",Ze," Total: "+a(x(S)(Y.value.toFixed(2))),1)])):f("",!0)]),n("div",Ge,[m.value==="single"?(u(),i("button",{key:0,class:"btn btn-primary rounded-pill px-4 py-2",disabled:D.value,onClick:re},[D.value?(u(),i("span",Ke,"Saving...")):(u(),i("span",Je,"Save"))],8,He)):f("",!0),m.value==="multiple"?(u(),i("button",{key:1,class:"btn btn-primary rounded-pill px-4 py-2",disabled:C.value,onClick:se},[C.value?(u(),i("span",Ye,"Saving...")):(u(),i("span",Xe,"Save"))],8,We)):f("",!0)])])])]))}},it=de(et,[["__scopeId","data-v-42b3f0bc"]]);export{it as default};

import{_ as K,r as m,D as W,k as Y,j as J,g as y,o as h,b as t,a as S,x as j,y as L,f as I,d as V,i as M,F as k,v as Q,t as b,V as Z,R as ee,n as te,A,p as le,m as s}from"./app-DgHj6V6q.js";import{E as oe,a as se,X as ae,u as C,w as re}from"./xlsx-B5Xi98cQ.js";import{I as ne}from"./importFile-C9EmJvbV.js";import{P as ie}from"./plus-BS0M9IQ8.js";import{P as de}from"./pencil-DagjvPCE.js";const ce={class:"card border-0 shadow-lg rounded-4"},ue={class:"card-body"},me={class:"d-flex flex-wrap gap-2 justify-content-between align-items-center mb-3"},ge={class:"d-flex gap-2"},pe={class:"search-wrap"},fe={class:"dropdown"},ve={class:"dropdown-menu dropdown-menu-end shadow rounded-4 py-2"},ye={class:"table-responsive"},he={class:"table table-hover"},we={class:"fw-semibold"},be={class:"text-center"},xe={class:"d-inline-flex align-items-center gap-3"},Ae=["onClick"],Ce={key:0},_e={colspan:"3",class:"text-center text-muted py-4"},Se={class:"modal fade",id:"modalAllergyForm",tabindex:"-1","aria-hidden":"true"},ke={class:"modal-dialog modal-lg modal-dialog-centered"},De={class:"modal-content rounded-4"},Ee={class:"modal-header"},Ne={class:"modal-title"},Fe={class:"modal-body"},Ie={key:0,class:"text-danger"},$e={class:"col-md-2"},Pe=["disabled"],Te={__name:"AllergiesTab",setup(je){const g=m(""),x=m(!1),D=m(null),w=m(""),E=()=>{g.value="",i.value={}},N=W(()=>{const l=w.value.trim().toLowerCase();return l?n.value.filter(e=>e.name.toLowerCase().includes(l)):n.value}),O=()=>{x.value=!1,g.value=""},B=l=>{x.value=!0,D.value=l,g.value=l.name},R=async l=>{try{await A.delete(`/allergies/${l.id}`),n.value=n.value.filter(e=>e.id!==l.id),s.success("Allergy deleted successfully")}catch{s.error("Delete failed")}},f=m(!1),$=async()=>{if(!f.value){if(!g.value.trim()){s.error("Please enter an allergy name"),i.value={customAllergy:["Please enter an allergy name"]};return}if(x.value)try{f.value=!0;const{data:l}=await A.put(`/allergies/${D.value.id}`,{name:g.value.trim()}),e=n.value.findIndex(o=>o.id===D.value.id);e!==-1&&(n.value[e]=l),s.success("Allergy updated successfully"),await _(),E(),P("modalAllergyForm")}catch(l){l.response?.data?.errors?(i.value={},Object.entries(l.response.data.errors).forEach(([e,o])=>{o.forEach(r=>s.error(r)),i.value={customAllergy:o}})):s.error("Update failed")}finally{f.value=!1}else{const l=g.value.trim();if(n.value.some(o=>o.name.toLowerCase()===l.toLowerCase())){s.error(`Allergy "${l}" already exists`),i.value={customAllergy:["This allergy already exists"]};return}try{f.value=!0;const o=await A.post("/allergies",{allergies:[{name:l}]}),r=o.data?.allergies??o.data;Array.isArray(r)&&r.length&&(n.value=[...n.value,...r]),s.success("Allergy added successfully"),E(),P("modalAllergyForm"),await _()}catch(o){o.response?.data?.errors?Object.values(o.response.data.errors).forEach(r=>r.forEach(c=>s.error(c))):(console.error(o),s.error("Create failed"))}finally{f.value=!1}}}},P=l=>{const e=document.getElementById(l);if(!e)return;(window.bootstrap?.Modal.getInstance(e)||new window.bootstrap.Modal(e)).hide()},n=m([]),z=m(1),U=m(15),T=m(!1),i=m({}),_=async()=>{T.value=!0;try{const{data:l}=await A.get("/allergies",{params:{q:w.value,page:z.value,per_page:U.value}});n.value=l?.data??l?.allergies?.data??l??[],await le(),window.feather?.replace()}catch(l){console.error("Failed to fetch allergies",l)}finally{T.value=!1}},F=l=>{if(!n.value||n.value.length===0){s.error("No Allergies data to download");return}const e=w.value.trim()?N.value:n.value;if(e.length===0){s.error("No Allergies found to download");return}try{l==="pdf"?q(e):l==="excel"?G(e):l==="csv"?X(e):s.error("Invalid download type")}catch(o){console.error("Download failed:",o),s.error(`Download failed: ${o.message}`)}},X=l=>{try{const e=["Name"],o=l.map(u=>[`"${u.name||""}"`]),r=[e.join(","),...o.map(u=>u.join(","))].join(`
`),c=new Blob([r],{type:"text/csv;charset=utf-8;"}),p=URL.createObjectURL(c),d=document.createElement("a");d.setAttribute("href",p),d.setAttribute("download",`allergies_${new Date().toISOString().split("T")[0]}.csv`),document.body.appendChild(d),d.click(),document.body.removeChild(d),s.success("CSV downloaded successfully",{autoClose:2500})}catch(e){console.error("CSV generation error:",e),s.error(`CSV generation failed: ${e.message}`,{autoClose:5e3})}},q=l=>{try{const e=new oe("p","mm","a4");e.setFont("helvetica","bold"),e.setFontSize(18),e.text("Allergies Report",70,20),e.setFont("helvetica","normal"),e.setFontSize(10);const o=new Date().toLocaleString();e.text(`Generated on: ${o}`,14,30),e.text(`Total Allergies: ${l.length}`,14,36);const r=["Name"],c=l.map(d=>[d.name||""]);se(e,{head:[r],body:c,startY:45,styles:{fontSize:10,cellPadding:3,halign:"left",valign:"middle",lineColor:[220,220,220],lineWidth:.1},headStyles:{fillColor:[41,128,185],textColor:255,fontStyle:"bold"},alternateRowStyles:{fillColor:[245,245,245]},margin:{left:14,right:14},didDrawPage:d=>{const u=e.internal.getNumberOfPages(),a=e.internal.pageSize.height;e.setFontSize(8),e.text(`Page ${d.pageNumber} of ${u}`,14,a-10)}});const p=`allergies_${new Date().toISOString().split("T")[0]}.pdf`;e.save(p),s.success("PDF downloaded successfully",{autoClose:2500})}catch(e){console.error("PDF generation error:",e),s.error(`PDF generation failed: ${e.message}`,{autoClose:5e3})}},G=l=>{try{if(typeof ae>"u")throw new Error("XLSX library is not loaded");const e=l.map(u=>({Name:u.name||""})),o=C.book_new(),r=C.json_to_sheet(e);r["!cols"]=[{wch:25}],C.book_append_sheet(o,r,"Allergies");const c=[{Info:"Generated On",Value:new Date().toLocaleString()},{Info:"Total Records",Value:l.length},{Info:"Exported By",Value:"Allergies Management System"}],p=C.json_to_sheet(c);C.book_append_sheet(o,p,"Report Info");const d=`allergies_${new Date().toISOString().split("T")[0]}.xlsx`;re(o,d),s.success("Excel file downloaded successfully",{autoClose:2500})}catch(e){console.error("Excel generation error:",e),s.error(`Excel generation failed: ${e.message}`,{autoClose:5e3})}};Y(async()=>{await _(),window.feather?.replace()}),J(g,l=>{l&&i.value.customAllergy&&delete i.value.customAllergy});const H=l=>{if(console.log("Imported Data:",l),!Array.isArray(l)||l.length===0){s.error("File is empty.");return}l[0];const o=l.slice(1).filter(a=>Array.isArray(a)&&a.some(v=>String(v??"").trim()!==""));if(o.length===0){s.error("No data rows found the file is empty or contains only headers.");return}const r=o.map(a=>({name:String(a[0]??"").trim()})).filter(a=>a.name!=="");if(r.length===0){s.error("No valid allergy names found in the file.");return}const c=r.map(a=>a.name.toLowerCase()),p=c.filter((a,v)=>c.indexOf(a)!==v);if(p.length){const a=[...new Set(p)];s.error(`Duplicate entries found in file: ${a.join(", ")}`);return}const d=n.value.map(a=>a.name.toLowerCase()),u=r.filter(a=>d.includes(a.name.toLowerCase()));if(u.length>0){const a=u.map(v=>v.name).join(", ");s.error(`These allergies already exist in the database: ${a}`);return}A.post("/api/allergies/import",{allergies:r}).then(()=>{s.success("Allergies imported successfully"),_()}).catch(a=>{if(a?.response?.status===422&&a.response.data?.errors){i.value=a.response.data.errors;const v=a.response.data.message||"There may be duplication or validation errors in the data.";s.error(v,{autoClose:3e3})}else s.error("Import failed. Please try again.",{autoClose:3e3}),console.error(a)})};return(l,e)=>(h(),y(k,null,[t("div",ce,[t("div",ue,[t("div",me,[e[9]||(e[9]=t("h4",{class:"mb-0"},"Allergies",-1)),t("div",ge,[t("div",pe,[e[6]||(e[6]=t("i",{class:"bi bi-search"},null,-1)),j(t("input",{"onUpdate:modelValue":e[0]||(e[0]=o=>w.value=o),class:"form-control search-input",placeholder:"Search"},null,512),[[L,w.value]])]),t("button",{"data-bs-toggle":"modal","data-bs-target":"#modalAllergyForm",onClick:e[1]||(e[1]=()=>{O(),E(),i.value={}}),class:"d-flex align-items-center gap-1 btn-sm px-4 py-2 rounded-pill btn btn-primary text-white"},[S(V(ie),{class:"w-4 h-4"}),e[7]||(e[7]=I(" Add Allergy ",-1))]),S(ne,{label:"Import",sampleHeaders:["Name"],sampleData:[["Milk"],["Peanuts"],["Gluten"]],onOnImport:H}),t("div",fe,[e[8]||(e[8]=t("button",{class:"btn btn-outline-secondary btn-sm rounded-pill py-2 px-4 dropdown-toggle","data-bs-toggle":"dropdown"}," Export ",-1)),t("ul",ve,[t("li",null,[t("a",{class:"dropdown-item py-2",href:"javascript:;",onClick:e[2]||(e[2]=o=>F("pdf"))},"Export as PDF")]),t("li",null,[t("a",{class:"dropdown-item py-2",href:"javascript:;",onClick:e[3]||(e[3]=o=>F("excel"))},"Export as Excel")]),t("li",null,[t("a",{class:"dropdown-item py-2",href:"javascript:;",onClick:e[4]||(e[4]=o=>F("csv"))},"Export as CSV")])])])])]),t("div",ye,[t("table",he,[e[10]||(e[10]=t("thead",{class:"border-top small text-muted"},[t("tr",null,[t("th",null,"S. #"),t("th",null,"Allergy Name"),t("th",{class:"text-center"},"Action")])],-1)),t("tbody",null,[(h(!0),y(k,null,Q(N.value,(o,r)=>(h(),y("tr",{key:o.id},[t("td",null,b(r+1),1),t("td",we,b(o.name),1),t("td",be,[t("div",xe,[t("button",{"data-bs-toggle":"modal","data-bs-target":"#modalAllergyForm",onClick:()=>{B(o),i.value={}},title:"Edit",class:"p-2 rounded-full text-blue-600 hover:bg-blue-100"},[S(V(de),{class:"w-4 h-4"})],8,Ae),S(Z,{title:"Confirm Delete",message:`Are you sure you want to delete ${o.name}?`,showDeleteButton:!0,onConfirm:()=>{R(o)},onCancel:()=>{}},null,8,["message","onConfirm"])])])]))),128)),N.value.length===0?(h(),y("tr",Ce,[t("td",_e,b(w.value.trim()?"No allergies found matching your search.":"No allergies found."),1)])):M("",!0)])])])])]),t("div",Se,[t("div",ke,[t("div",De,[t("div",Ee,[t("h5",Ne,b(x.value?"Edit Allergy":"Add Allergy(s)"),1),e[11]||(e[11]=t("button",{class:"absolute top-2 right-2 p-2 rounded-full hover:bg-gray-100 transition transform hover:scale-110","data-bs-dismiss":"modal","aria-label":"Close",title:"Close"},[t("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-6 w-6 text-red-500",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor","stroke-width":"2"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M6 18L18 6M6 6l12 12"})])],-1))]),t("div",Fe,[t("div",null,[e[12]||(e[12]=t("label",{class:"form-label"},"Allergy Name",-1)),j(t("input",{"onUpdate:modelValue":e[5]||(e[5]=o=>g.value=o),class:te(["form-control",{"is-invalid":i.value.customAllergy}]),placeholder:"e.g., Vegan",onKeyup:ee($,["enter"])},null,34),[[L,g.value]]),i.value.customAllergy?(h(),y("span",Ie,b(i.value.customAllergy[0]),1)):M("",!0)]),t("div",$e,[t("button",{class:"btn btn-primary rounded-pill py-2 btn-sm w-100 mt-4",disabled:f.value,onClick:$},[f.value?(h(),y(k,{key:0},[e[13]||(e[13]=t("span",{class:"spinner-border spinner-border-sm me-2"},null,-1)),e[14]||(e[14]=I(" Saving... ",-1))],64)):(h(),y(k,{key:1},[I(b((x.value,"Save")),1)],64))],8,Pe)])])])])])],64))}},Re=K(Te,[["__scopeId","data-v-4273e43a"]]);export{Re as default};

import{_ as le,r as h,y as Q,o as ne,c as R,E as se,f as r,b as a,e as l,B as oe,m as _,i as f,d as B,u as U,t as u,F as x,g as D,k as I,v as N,T as O,q as g}from"./app-DMtB1k9Z.js";import{s as ie}from"./index-6n_iKpwB.js";import{u as re}from"./useFormatters-BAefhHg6.js";import"./index-Ds9HV7qR.js";import"./index-Bep5Ew2j.js";import"./index-CptKtDcN.js";import"./index-D3qxtxH9.js";const ae={class:"modal fade",id:"bulkOrderModal",tabindex:"-1","aria-hidden":"true"},ue={class:"modal-dialog modal-xl modal-dialog-centered"},de={class:"modal-content rounded-4"},ce={class:"modal-body"},ve={class:"nav nav-tabs mb-4",role:"tablist"},pe={class:"nav-item",role:"presentation"},me={class:"nav-item",role:"presentation"},_e={key:0},ye={class:"mb-3"},fe={key:0,class:"text-danger"},be={class:"table-responsive"},he={class:"table align-middle"},ge=["onUpdate:modelValue","onInput"],Pe={key:0,class:"text-danger"},ke=["onUpdate:modelValue","onChange","onFocus"],Ue={value:null},Ie=["value"],we=["onUpdate:modelValue","onInput"],qe={key:0,class:"text-danger"},xe={key:0,class:"text-danger"},De=["onClick"],Ve={class:"text-end fw-bold mt-3"},Se={key:1},Ce={class:"table-responsive"},Ne={class:"table align-middle"},Ee=["onUpdate:modelValue"],Me=["value"],Fe={key:0,class:"text-danger d-block"},Be=["onUpdate:modelValue","onInput"],Oe={key:0,class:"text-danger"},$e=["onUpdate:modelValue","onChange","onFocus"],Te={value:null},Ae=["value"],je=["onUpdate:modelValue","onInput"],Le={key:0,class:"text-danger"},ze={key:0,class:"text-danger"},Qe=["onClick"],Re={class:"text-end fw-bold mt-3"},Je={class:"modal-footer"},Ze=["disabled"],Ge={key:0},He={key:1},Ke=["disabled"],We={key:0},Xe={key:1},Ye={__name:"BulkOrderComponent",props:{suppliers:{type:Array,default:()=>[]},items:{type:Array,default:()=>[]}},emits:["refresh-data"],setup(E,{emit:J}){const{formatCurrencySymbol:V,dateFmt:$}=re(),T=E,M=h({}),A=J,y=h("single"),w=h(null),S=h(!1),d=h({}),c=h([]),C=h(!1),b=h({}),v=h([]);Q(()=>T.items,t=>{c.value=t.map(n=>({...n,qty:0,unitPrice:0,expiry:null,subtotal:0,selected_derived_unit_id:null,selectedDerivedUnitInfo:null,derived_units:[]}))},{immediate:!0}),Q(()=>T.items,t=>{v.value=t.map(n=>({...n,qty:0,unitPrice:0,expiry:null,subtotal:0,supplier_id:null,selected_derived_unit_id:null,selectedDerivedUnitInfo:null,derived_units:[]}))},{immediate:!0}),ne(()=>{feather.replace();const t=document.getElementById("bulkOrderModal");t&&(t.addEventListener("show.bs.modal",()=>{y.value="single"}),t.addEventListener("hide.bs.modal",()=>{y.value="single"}))});function F(t){let n=Number(t.qty)||0;const i=Number(t.unitPrice)||0;t.selected_derived_unit_id&&t.selectedDerivedUnitInfo&&(Number(t.selectedDerivedUnitInfo.conversion_factor),n=n),t.subtotal=n*i}function Z(t){let n=Number(t.qty)||0;const i=Number(t.unitPrice)||0;t.selected_derived_unit_id&&t.selectedDerivedUnitInfo&&(Number(t.selectedDerivedUnitInfo.conversion_factor),n=n),t.subtotal=n*i}function j(t){t.qty<0&&(t.qty=0),F(t)}function L(t){if(t.unitPrice===null||t.unitPrice===void 0||t.unitPrice===""){t.unitPrice="",t.subtotal=0;return}t.unitPrice<0&&(t.unitPrice=0),F(t)}function G(t){c.value[t].qty=0,c.value[t].unitPrice=0,c.value[t].expiry=null,c.value[t].subtotal=0,c.value[t].selected_derived_unit_id=null,c.value[t].selectedDerivedUnitInfo=null,c.value[t].derived_units&&(c.value[t].derived_units=[])}function H(t){v.value[t].qty=0,v.value[t].unitPrice=0,v.value[t].expiry=null,v.value[t].subtotal=0,v.value[t].supplier_id=null,v.value[t].selected_derived_unit_id=null,v.value[t].selectedDerivedUnitInfo=null,v.value[t].derived_units&&(v.value[t].derived_units=[])}async function z(t){try{const n=t.unit_id??t.unitId??null;if(!n){t.derived_units=[];return}if(M.value[n]){t.derived_units=M.value[n];return}const i=await axios.get("/units",{params:{per_page:200}}),o=(i.data?.data??i.data??[]).filter(s=>s.base_unit_id!==null&&Number(s.base_unit_id)===Number(n));M.value[n]=o,t.derived_units=o}catch(n){console.error("loadDerivedUnits error:",n),t.derived_units=[]}}function K(t){t.selected_derived_unit_id?t.selectedDerivedUnitInfo=t.derived_units.find(n=>n.id===t.selected_derived_unit_id):t.selectedDerivedUnitInfo=null,F(t)}function W(t){t.selected_derived_unit_id?t.selectedDerivedUnitInfo=t.derived_units.find(n=>n.id===t.selected_derived_unit_id):t.selectedDerivedUnitInfo=null,Z(t)}const X=R(()=>c.value.reduce((t,n)=>t+(Number(n.subtotal)||0),0)),Y=R(()=>v.value.reduce((t,n)=>t+(Number(n.subtotal)||0),0));async function ee(){d.value={},w.value||(d.value.supplier="Please select a supplier");const t=new Date().toISOString().split("T")[0],n=[];if(console.log("Raw bulkItems before processing:",JSON.parse(JSON.stringify(c.value))),c.value.forEach((e,o)=>{console.log(`Processing item ${o}:`,{id:e.id,name:e.name,qty:e.qty,unitPrice:e.unitPrice,selected_derived_unit_id:e.selected_derived_unit_id,selectedDerivedUnitInfo:e.selectedDerivedUnitInfo});const s=e.qty||e.unitPrice||e.expiry,p={};if(s){let m=Number(e.qty)||0;if(e.selected_derived_unit_id&&e.selectedDerivedUnitInfo){const q=Number(e.selectedDerivedUnitInfo.conversion_factor)||1;m=m*q,console.log(`Applied conversion: ${e.qty} * ${q} = ${m}`)}const P=e.unitPrice!==null&&e.unitPrice!==void 0&&e.unitPrice!==""?Number(e.unitPrice):0;console.log("Entered Price:",P,"Type:",typeof e.unitPrice,"Raw value:",e.unitPrice);const k=e.selectedDerivedUnitInfo&&P>0?Number((P/Number(e.selectedDerivedUnitInfo.conversion_factor)).toFixed(4)):P;if(console.log("Base Unit Price:",k),(!m||m<=0)&&(p.qty="Quantity is required"),(!P||P<=0)&&(p.unitPrice="Unit Price is required"),e.expiry?new Date(e.expiry)<new Date(t)&&(p.expiry="Expiry must be today or later"):p.expiry="Expiry date is required",Object.keys(p).length>0)d.value[o]=p;else{const q={product_id:e.id,quantity:m,unit_price:k,expiry:e.expiry};console.log("Pushing item to validItems:",q),n.push(q)}}}),console.log("Valid Items to submit:",n),!w.value){g.error("Please select a supplier");return}if(n.length===0){g.error("No valid items to submit");return}if(Object.keys(d.value).length>0){g.error("Please fix the highlighted errors");return}const i={supplier_id:w.value,purchase_date:t,status:"completed",items:n};console.log("Final Payload:",i),S.value=!0;try{await axios.post("/purchase-orders",i),g.success("Bulk order created successfully!"),A("refresh-data"),w.value=null,c.value.forEach(o=>{o.qty=0,o.unitPrice=0,o.expiry=null,o.subtotal=0,o.selected_derived_unit_id=null,o.selectedDerivedUnitInfo=null}),bootstrap.Modal.getInstance(document.getElementById("bulkOrderModal"))?.hide()}catch(e){console.error(e),g.error("Failed to save bulk order")}finally{S.value=!1}}async function te(){b.value={};const t=new Date().toISOString().split("T")[0],n={};if(v.value.forEach((i,e)=>{const o=i.qty||i.unitPrice||i.expiry,s={};if(o){i.supplier_id||(s.supplier_id="Supplier is required");let p=Number(i.qty)||0;if(i.selected_derived_unit_id&&i.selectedDerivedUnitInfo){const k=Number(i.selectedDerivedUnitInfo.conversion_factor)||1;p=p*k}const m=i.unitPrice!==null&&i.unitPrice!==void 0&&i.unitPrice!==""?Number(i.unitPrice):0,P=i.selectedDerivedUnitInfo&&m>0?Number((m/Number(i.selectedDerivedUnitInfo.conversion_factor)).toFixed(4)):m;if((!p||p<=0)&&(s.qty="Quantity is required"),(!m||m<=0)&&(s.unitPrice="Unit Price is required"),i.expiry?new Date(i.expiry)<new Date(t)&&(s.expiry="Expiry must be today or later"):s.expiry="Expiry date is required",Object.keys(s).length>0)b.value[e]=s;else{const k=i.supplier_id;n[k]||(n[k]=[]),n[k].push({product_id:i.id,quantity:p,unit_price:P,expiry:i.expiry})}}}),Object.keys(n).length===0){g.error("No valid items to submit");return}if(Object.keys(b.value).length>0){g.error("Please fix the highlighted errors");return}C.value=!0;try{for(const[e,o]of Object.entries(n)){const s={supplier_id:parseInt(e),purchase_date:t,status:"completed",items:o};await axios.post("/purchase-orders",s)}g.success("Multiple orders created successfully!"),A("refresh-data"),v.value.forEach(e=>{e.qty=0,e.unitPrice=0,e.expiry=null,e.subtotal=0,e.supplier_id=null,e.selected_derived_unit_id=null,e.selectedDerivedUnitInfo=null}),bootstrap.Modal.getInstance(document.getElementById("bulkOrderModal"))?.hide(),setTimeout(()=>{document.querySelectorAll(".modal-backdrop").forEach(e=>e.remove()),document.body.classList.remove("modal-open"),document.body.style.removeProperty("overflow"),document.body.style.removeProperty("padding-right")},100)}catch(i){console.error(i),g.error("Failed to save multiple orders")}finally{C.value=!1}}return(t,n)=>{const i=se("VueDatePicker");return a(),r("div",ae,[l("div",ue,[l("div",de,[n[9]||(n[9]=oe('<div class="modal-header" data-v-69475ac7><h5 class="modal-title fw-semibold" data-v-69475ac7>Bulk Purchase</h5><button class="absolute top-2 right-2 p-2 rounded-full hover:bg-gray-100 transition transform hover:scale-110" data-bs-dismiss="modal" aria-label="Close" title="Close" data-v-69475ac7><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" data-v-69475ac7><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" data-v-69475ac7></path></svg></button></div>',1)),l("div",ce,[l("ul",ve,[l("li",pe,[l("button",{class:f(["nav-link",{active:y.value==="single"}]),onClick:n[0]||(n[0]=e=>y.value="single"),type:"button",role:"tab"}," Single Purchase ",2)]),l("li",me,[l("button",{class:f(["nav-link",{active:y.value==="multiple"}]),onClick:n[1]||(n[1]=e=>y.value="multiple"),type:"button",role:"tab"}," Multiple Purchase ",2)])]),y.value==="single"?(a(),r("div",_e,[l("div",ye,[n[3]||(n[3]=l("label",{class:"form-label"},"Preferred Supplier",-1)),B(U(ie),{modelValue:w.value,"onUpdate:modelValue":n[2]||(n[2]=e=>w.value=e),options:E.suppliers,optionLabel:"name",optionValue:"id",placeholder:"Select Supplier",class:f(["w-100",{"is-invalid":d.value.supplier}]),appendTo:"self",autoZIndex:!0,baseZIndex:2e3},null,8,["modelValue","options","class"]),d.value.supplier?(a(),r("small",fe,u(d.value.supplier),1)):_("",!0)]),l("div",be,[l("table",he,[n[5]||(n[5]=l("thead",null,[l("tr",null,[l("th",null,"Name"),l("th",null,"Category"),l("th",null,"Unit"),l("th",null,"Qty"),l("th",null,"Unit"),l("th",null,"Unit Price"),l("th",null,"Expiry"),l("th",null,"Subtotal"),l("th")])],-1)),l("tbody",null,[(a(!0),r(x,null,D(c.value,(e,o)=>(a(),r("tr",{key:e.id},[l("td",null,u(e.name),1),l("td",null,u(e.category?.name||"-"),1),l("td",null,u(e.unit_name),1),l("td",null,[I(l("input",{type:"number",min:"0","onUpdate:modelValue":s=>e.qty=s,class:f(["form-control",{"is-invalid":d.value[o]?.qty}]),onInput:s=>j(e)},null,42,ge),[[N,e.qty,void 0,{number:!0}]]),d.value[o]?.qty?(a(),r("small",Pe,u(d.value[o].qty),1)):_("",!0)]),l("td",null,[I(l("select",{class:"form-select","onUpdate:modelValue":s=>e.selected_derived_unit_id=s,onChange:s=>K(e),onFocus:s=>z(e)},[l("option",Ue,"Base ("+u(e.unit_name)+")",1),(a(!0),r(x,null,D(e.derived_units||[],s=>(a(),r("option",{key:s.id,value:s.id},u(s.name),9,Ie))),128))],40,ke),[[O,e.selected_derived_unit_id]])]),l("td",null,[I(l("input",{type:"number",min:"0","onUpdate:modelValue":s=>e.unitPrice=s,class:f(["form-control",{"is-invalid":d.value[o]?.unitPrice}]),onInput:s=>L(e)},null,42,we),[[N,e.unitPrice,void 0,{number:!0}]]),d.value[o]?.unitPrice?(a(),r("small",qe,u(d.value[o].unitPrice),1)):_("",!0)]),l("td",null,[B(i,{modelValue:e.expiry,"onUpdate:modelValue":s=>e.expiry=s,format:U($),"min-date":new Date,enableTimePicker:!1,teleport:!1,placeholder:"Select date",class:f({"is-invalid":d.value[o]?.expiry})},null,8,["modelValue","onUpdate:modelValue","format","min-date","class"]),d.value[o]?.expiry?(a(),r("small",xe,u(d.value[o].expiry),1)):_("",!0)]),l("td",null,u(U(V)(e.subtotal.toFixed(2))),1),l("td",null,[l("button",{class:"btn btn-sm btn-outline-danger d-flex align-items-center justify-content-center",onClick:s=>G(o),title:"Clear",style:{width:"36px",height:"36px"}},[...n[4]||(n[4]=[l("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",fill:"currentColor",viewBox:"0 0 16 16"},[l("path",{"fill-rule":"evenodd",d:"M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"}),l("path",{d:"M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"})],-1)])],8,De)])]))),128))])])]),l("div",Ve," Total: "+u(U(V)(X.value.toFixed(2))),1)])):_("",!0),y.value==="multiple"?(a(),r("div",Se,[l("div",Ce,[l("table",Ne,[n[8]||(n[8]=l("thead",null,[l("tr",null,[l("th",null,"Name"),l("th",null,"Category"),l("th",null,"Unit"),l("th",null,"Supplier"),l("th",null,"Qty"),l("th",null,"Unit"),l("th",null,"Unit Price"),l("th",null,"Expiry"),l("th",null,"Subtotal"),l("th")])],-1)),l("tbody",null,[(a(!0),r(x,null,D(v.value,(e,o)=>(a(),r("tr",{key:e.id},[l("td",null,u(e.name),1),l("td",null,u(e.category?.name||"-"),1),l("td",null,u(e.unit_name),1),l("td",null,[I(l("select",{"onUpdate:modelValue":s=>e.supplier_id=s,class:f(["form-select w-100",{"is-invalid":b.value[o]?.supplier_id}])},[n[6]||(n[6]=l("option",{value:"",disabled:"",hidden:""},"Select Supplier",-1)),(a(!0),r(x,null,D(E.suppliers,s=>(a(),r("option",{key:s.id,value:s.id},u(s.name),9,Me))),128))],10,Ee),[[O,e.supplier_id]]),b.value[o]?.supplier_id?(a(),r("small",Fe,u(b.value[o].supplier_id),1)):_("",!0)]),l("td",null,[I(l("input",{type:"number",min:"0","onUpdate:modelValue":s=>e.qty=s,class:f(["form-control",{"is-invalid":d.value[o]?.qty}]),onInput:s=>j(e)},null,42,Be),[[N,e.qty,void 0,{number:!0}]]),d.value[o]?.qty?(a(),r("small",Oe,u(d.value[o].qty),1)):_("",!0)]),l("td",null,[I(l("select",{class:"form-select","onUpdate:modelValue":s=>e.selected_derived_unit_id=s,onChange:s=>W(e),onFocus:s=>z(e)},[l("option",Te,"Base ("+u(e.unit_name)+")",1),(a(!0),r(x,null,D(e.derived_units||[],s=>(a(),r("option",{key:s.id,value:s.id},u(s.name),9,Ae))),128))],40,$e),[[O,e.selected_derived_unit_id]])]),l("td",null,[I(l("input",{type:"number",min:"0","onUpdate:modelValue":s=>e.unitPrice=s,class:f(["form-control",{"is-invalid":d.value[o]?.unitPrice}]),onInput:s=>L(e)},null,42,je),[[N,e.unitPrice,void 0,{number:!0}]]),d.value[o]?.unitPrice?(a(),r("small",Le,u(d.value[o].unitPrice),1)):_("",!0)]),l("td",null,[B(i,{modelValue:e.expiry,"onUpdate:modelValue":s=>e.expiry=s,position:t.bottom,format:U($),"min-date":new Date,enableTimePicker:!1,teleport:t.body,placeholder:"Select date",class:f({"is-invalid":b.value[o]?.expiry})},null,8,["modelValue","onUpdate:modelValue","position","format","min-date","teleport","class"]),b.value[o]?.expiry?(a(),r("small",ze,u(b.value[o].expiry),1)):_("",!0)]),l("td",null,u(U(V)(e.subtotal.toFixed(2))),1),l("td",null,[l("button",{class:"btn btn-sm btn-outline-danger d-flex align-items-center justify-content-center",onClick:s=>H(o),title:"Clear",style:{width:"36px",height:"36px"}},[...n[7]||(n[7]=[l("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",fill:"currentColor",viewBox:"0 0 16 16"},[l("path",{"fill-rule":"evenodd",d:"M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"}),l("path",{d:"M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"})],-1)])],8,Qe)])]))),128))])])]),l("div",Re," Total: "+u(U(V)(Y.value.toFixed(2))),1)])):_("",!0)]),l("div",Je,[y.value==="single"?(a(),r("button",{key:0,class:"btn btn-primary rounded-pill px-4 py-2",disabled:S.value,onClick:ee},[S.value?(a(),r("span",He,"Saving...")):(a(),r("span",Ge,"Save"))],8,Ze)):_("",!0),y.value==="multiple"?(a(),r("button",{key:1,class:"btn btn-primary rounded-pill px-4 py-2",disabled:C.value,onClick:te},[C.value?(a(),r("span",Xe,"Saving...")):(a(),r("span",We,"Save"))],8,Ke)):_("",!0)])])])])}}},rt=le(Ye,[["__scopeId","data-v-69475ac7"]]);export{rt as default};

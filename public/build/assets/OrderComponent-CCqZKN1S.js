import{_ as se,r as c,y as re,o as ie,c as j,f as d,b as o,e as l,m as _,i as h,d as de,u as x,t as u,F as q,g as P,k as g,v as V,T as B,q as y}from"./app-u4EpCMHn.js";import{s as oe}from"./index-BwP6ujoC.js";import{u as ue}from"./useFormatters-DnVeH_xR.js";import"./index-DFkaF8Nf.js";import"./index-CmKjO1oz.js";import"./index-BCOYSgqC.js";import"./index-GZ1nUkqY.js";const ae={class:"modal fade",id:"addOrderModal",tabindex:"-1","aria-hidden":"true"},ce={class:"modal-dialog modal-xl modal-dialog-centered"},ve={class:"modal-content rounded-4"},pe={class:"modal-body"},_e={class:"nav nav-tabs mb-4",role:"tablist"},fe={class:"nav-item",role:"presentation"},me={class:"nav-item",role:"presentation"},ye={key:0},he={class:"mb-3"},be={key:0,class:"text-danger"},ge={class:"table-responsive"},Ue={class:"table align-middle"},Ie=["onUpdate:modelValue","onInput"],ke={key:0,class:"text-danger"},xe=["onUpdate:modelValue","onChange","onFocus"],qe={value:null},Pe=["value"],we=["onUpdate:modelValue","onInput"],Ce={key:0,class:"text-danger"},De=["onClick"],Se={class:"text-end fw-bold mt-3"},Ne={key:1},Ve={class:"table-responsive"},Me={class:"table align-middle"},Oe=["onUpdate:modelValue"],Ee=["value"],Fe={key:0,class:"text-danger d-block"},je=["onUpdate:modelValue","onInput"],Be={key:0,class:"text-danger"},$e=["onUpdate:modelValue","onChange","onFocus"],Ae={value:null},Le=["value"],Te=["onUpdate:modelValue","onInput"],ze={key:0,class:"text-danger"},Qe=["onClick"],Re={class:"text-end fw-bold mt-3"},Ze={class:"modal-footer"},Ge=["disabled"],He={key:0},Je={key:1},Ke=["disabled"],We={key:0},Xe={key:1},Ye={__name:"OrderComponent",props:{suppliers:{type:Array,required:!0},items:{type:Array,required:!0}},emits:["refresh-data"],setup(M,{emit:z}){const{formatCurrencySymbol:w}=ue(),C=M,$=z,f=c("single"),Q=c(""),U=c(null);c(!1);const i=c({});c("");const D=c(!1),O=c({});c(null);const S=c(!1),v=c({}),I=c([]);re(()=>C.items,e=>{I.value=e.map(t=>({...t,qty:0,unitPrice:0,expiry:null,subtotal:0,supplier_id:null,selected_derived_unit_id:null,derived_units:[]}))},{immediate:!0}),ie(()=>{feather.replace();const e=document.getElementById("addOrderModal");e&&e.addEventListener("show.bs.modal",()=>{f.value="single"})});const k=j(()=>{const e=Q.value.trim().toLowerCase();return e?C.items.filter(t=>("qty"in t||(t.qty=0),"unitPrice"in t||(t.unitPrice=0),"expiry"in t||(t.expiry=null),"subtotal"in t||(t.subtotal=0),"selected_derived_unit_id"in t||(t.selected_derived_unit_id=null),"selectedDerivedUnitInfo"in t||(t.selectedDerivedUnitInfo=null),"derived_units"in t||(t.derived_units=[]),[t.name,t.category?.name??"",t.unit_name??"",String(t.stock??"")].join(" ").toLowerCase().includes(e))):(C.items.forEach(t=>{"qty"in t||(t.qty=0),"unitPrice"in t||(t.unitPrice=0),"expiry"in t||(t.expiry=null),"subtotal"in t||(t.subtotal=0),"selected_derived_unit_id"in t||(t.selected_derived_unit_id=null),"selectedDerivedUnitInfo"in t||(t.selectedDerivedUnitInfo=null),"derived_units"in t||(t.derived_units=[])}),C.items)});function E(e){let t=Number(e.qty)||0;const n=Number(e.unitPrice)||0;e.selected_derived_unit_id&&e.selectedDerivedUnitInfo&&(Number(e.selectedDerivedUnitInfo.conversion_factor),t=t),e.subtotal=t*n}function A(e){e.qty<0&&(e.qty=0),E(e)}function L(e){e.unitPrice<0&&(e.unitPrice=0),E(e)}function R(e){let t=Number(e.qty)||0;const n=Number(e.unitPrice)||0;e.selected_derived_unit_id&&e.selectedDerivedUnitInfo&&(Number(e.selectedDerivedUnitInfo.conversion_factor),t=t),e.subtotal=t*n}function Z(e){e.qty=0,e.unitPrice=0,e.expiry=null,e.subtotal=0,e.selected_derived_unit_id=null,e.selectedDerivedUnitInfo=null,e.derived_units&&(e.derived_units=[]),ee(e)}function G(e){e.qty=0,e.unitPrice=0,e.expiry=null,e.subtotal=0,e.supplier_id=null,e.selected_derived_unit_id=null,e.selectedDerivedUnitInfo=null,e.derived_units&&(e.derived_units=[]),te(e)}const H=c([]),J=()=>{i.value={},k.value.forEach(e=>{e.selectedDerivedUnitInfo=null,e.selected_derived_unit_id=null}),H.value.forEach(e=>{e.selectedDerivedUnitInfo=null,e.selected_derived_unit_id=null})},N=e=>Math.round((Number(e)||0)*100)/100;c([]);const K=j(()=>N(k.value.reduce((e,t)=>e+Number(t.subtotal||0),0))),W=j(()=>N(I.value.reduce((e,t)=>e+Number(t.subtotal||0),0)));async function T(e){try{const t=e.unit_id??e.unitId??null;if(!t){e.derived_units=[];return}if(O.value[t]){e.derived_units=O.value[t];return}const n=await axios.get("/units",{params:{per_page:200}}),s=(n.data?.data??n.data??[]).filter(a=>a.base_unit_id!==null&&Number(a.base_unit_id)===Number(t));O.value[t]=s,e.derived_units=s}catch(t){console.error("loadDerivedUnits error:",t),e.derived_units=[]}}function X(e){e.selected_derived_unit_id?e.selectedDerivedUnitInfo=e.derived_units.find(t=>t.id===e.selected_derived_unit_id):e.selectedDerivedUnitInfo=null,E(e)}function Y(e){e.selected_derived_unit_id?e.selectedDerivedUnitInfo=e.derived_units.find(t=>t.id===e.selected_derived_unit_id):e.selectedDerivedUnitInfo=null,R(e)}const ee=(e,t=null)=>{i.value&&(!e||!e.id||(t?i.value[e.id]&&(delete i.value[e.id][t],Object.keys(i.value[e.id]).length===0&&delete i.value[e.id]):delete i.value[e.id]))},te=(e,t=null)=>{v.value&&(!e||!e.id||(t?v.value[e.id]&&(delete v.value[e.id][t],Object.keys(v.value[e.id]).length===0&&delete v.value[e.id]):delete v.value[e.id]))};async function le(){if(i.value={},!U.value){i.value.supplier_id=["Please select a supplier."],y.error("Please select a supplier.");return}const e=new Date().toISOString().split("T")[0],t=[];if(k.value.forEach(r=>{const s=r.qty||r.unitPrice,a={};if(s){let p=Number(r.qty)||0;if(r.selected_derived_unit_id&&r.selectedDerivedUnitInfo){const b=Number(r.selectedDerivedUnitInfo.conversion_factor)||1;p=p*b}const m=Number(r.unitPrice)||0,F=r.selectedDerivedUnitInfo?N(m/Number(r.selectedDerivedUnitInfo.conversion_factor)):m;(!p||p<=0)&&(a.qty=["Quantity is required"]),(!m||m<=0)&&(a.unit_price=["Unit Price is required"]),Object.keys(a).length>0?i.value[r.id]=a:t.push({product_id:r.id,quantity:p,unit_price:F,expiry:r.expiry||null})}}),t.length===0){y.error("No valid items to submit");return}if(Object.keys(i.value).length>0){y.error("Please fix the highlighted errors");return}const n={supplier_id:U.value,purchase_date:e,status:"pending",items:t};D.value=!0;try{await axios.post("/purchase-orders",n),y.success("Purchase order created successfully!"),$("refresh-data"),U.value=null,k.value.forEach(s=>{s.qty=0,s.unitPrice=0,s.expiry=null,s.subtotal=0,s.selected_derived_unit_id=null,s.selectedDerivedUnitInfo=null}),bootstrap.Modal.getInstance(document.getElementById("addOrderModal"))?.hide()}catch(r){console.error(r),y.error("Failed to save order")}finally{D.value=!1}}async function ne(){v.value={};const e=new Date().toISOString().split("T")[0],t={};if(I.value.forEach((n,r)=>{const s=n.qty||n.unitPrice,a={};if(s){n.supplier_id||(a.supplier_id=["Supplier is required"]);let p=Number(n.qty)||0;if(n.selected_derived_unit_id&&n.selectedDerivedUnitInfo){const b=Number(n.selectedDerivedUnitInfo.conversion_factor)||1;p=p*b}const m=Number(n.unitPrice)||0,F=n.selectedDerivedUnitInfo?N(m/Number(n.selectedDerivedUnitInfo.conversion_factor)):m;if((!p||p<=0)&&(a.qty=["Quantity is required"]),(!m||m<=0)&&(a.unit_price=["Unit Price is required"]),Object.keys(a).length>0)v.value[n.id]=a;else{const b=n.supplier_id;t[b]||(t[b]=[]),t[b].push({product_id:n.id,quantity:p,unit_price:F,expiry:n.expiry||null})}}}),Object.keys(t).length===0){y.error("No valid items to submit");return}if(Object.keys(v.value).length>0){y.error("Please fix the highlighted errors");return}S.value=!0;try{for(const[r,s]of Object.entries(t)){const a={supplier_id:parseInt(r),purchase_date:e,status:"pending",items:s};await axios.post("/purchase-orders",a)}y.success("Multiple orders created successfully!"),$("refresh-data"),I.value.forEach(r=>{r.qty=0,r.unitPrice=0,r.expiry=null,r.subtotal=0,r.supplier_id=null,r.selected_derived_unit_id=null,r.selectedDerivedUnitInfo=null}),bootstrap.Modal.getInstance(document.getElementById("addOrderModal"))?.hide()}catch(n){console.error(n),y.error("Failed to save multiple orders")}finally{S.value=!1}}return(e,t)=>(o(),d("div",ae,[l("div",ce,[l("div",ve,[l("div",{class:"modal-header"},[t[4]||(t[4]=l("h5",{class:"modal-title fw-semibold"},"Order",-1)),l("button",{class:"absolute top-2 right-2 p-2 rounded-full hover:bg-gray-100 transition transform hover:scale-110","data-bs-dismiss":"modal","aria-label":"Close",title:"Close",onClick:J},[...t[3]||(t[3]=[l("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-6 w-6 text-red-500",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor","stroke-width":"2"},[l("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M6 18L18 6M6 6l12 12"})],-1)])])]),l("div",pe,[l("ul",_e,[l("li",fe,[l("button",{class:h(["nav-link",{active:f.value==="single"}]),onClick:t[0]||(t[0]=n=>f.value="single"),type:"button",role:"tab"}," Single Order ",2)]),l("li",me,[l("button",{class:h(["nav-link",{active:f.value==="multiple"}]),onClick:t[1]||(t[1]=n=>f.value="multiple"),type:"button",role:"tab"}," Multiple Order ",2)])]),f.value==="single"?(o(),d("div",ye,[l("div",he,[t[5]||(t[5]=l("label",{class:"form-label"},"Preferred Supplier",-1)),de(x(oe),{modelValue:U.value,"onUpdate:modelValue":t[2]||(t[2]=n=>U.value=n),options:M.suppliers,optionLabel:"name",optionValue:"id",placeholder:"Select Supplier",class:h(["w-100",{"is-invalid":i.value.supplier_id}]),appendTo:"self",autoZIndex:!0,baseZIndex:2e3},null,8,["modelValue","options","class"]),i.value.supplier_id?(o(),d("small",be,u(i.value.supplier_id[0]),1)):_("",!0)]),l("div",ge,[l("table",Ue,[t[7]||(t[7]=l("thead",null,[l("tr",null,[l("th",null,"Name"),l("th",null,"Category"),l("th",null,"Unit"),l("th",null,"Stock"),l("th",null,"Qty"),l("th",null,"Unit"),l("th",null,"Unit Price"),l("th",null,"Subtotal"),l("th")])],-1)),l("tbody",null,[(o(!0),d(q,null,P(k.value,(n,r)=>(o(),d("tr",{key:n.id},[l("td",null,u(n.name),1),l("td",null,u(n.category?.name||"-"),1),l("td",null,u(n.unit_name),1),l("td",null,u(n.stock),1),l("td",null,[g(l("input",{type:"number",min:"0","onUpdate:modelValue":s=>n.qty=s,class:h(["form-control",{"is-invalid":i.value[r]?.qty}]),onInput:s=>A(n)},null,42,Ie),[[V,n.qty,void 0,{number:!0}]]),i.value[r]?.qty?(o(),d("small",ke,u(i.value[r].qty),1)):_("",!0)]),l("td",null,[g(l("select",{class:"form-select","onUpdate:modelValue":s=>n.selected_derived_unit_id=s,onChange:s=>X(n),onFocus:s=>T(n)},[l("option",qe,"Base ("+u(n.unit_name)+")",1),(o(!0),d(q,null,P(n.derived_units||[],s=>(o(),d("option",{key:s.id,value:s.id},u(s.name),9,Pe))),128))],40,xe),[[B,n.selected_derived_unit_id]])]),l("td",null,[g(l("input",{type:"number",min:"0","onUpdate:modelValue":s=>n.unitPrice=s,class:h(["form-control",{"is-invalid":i.value[r]?.unitPrice}]),onInput:s=>L(n)},null,42,we),[[V,n.unitPrice,void 0,{number:!0}]]),i.value[r]?.unitPrice?(o(),d("small",Ce,u(i.value[r].unitPrice),1)):_("",!0)]),l("td",null,u(x(w)((n.subtotal||0).toFixed(2))),1),l("td",null,[l("button",{class:"btn btn-sm btn-outline-danger d-flex align-items-center justify-content-center",onClick:s=>Z(n),title:"Clear",style:{width:"36px",height:"36px"}},[...t[6]||(t[6]=[l("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",fill:"currentColor",viewBox:"0 0 16 16"},[l("path",{"fill-rule":"evenodd",d:"M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"}),l("path",{d:"M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"})],-1)])],8,De)])]))),128))])])]),l("div",Se," Total: "+u(x(w)(K.value.toFixed(2))),1)])):_("",!0),f.value==="multiple"?(o(),d("div",Ne,[l("div",Ve,[l("table",Me,[t[10]||(t[10]=l("thead",null,[l("tr",null,[l("th",null,"Name"),l("th",null,"Category"),l("th",null,"Unit"),l("th",null,"Supplier"),l("th",null,"Qty"),l("th",null,"Unit"),l("th",null,"Unit Price"),l("th",null,"Subtotal"),l("th")])],-1)),l("tbody",null,[(o(!0),d(q,null,P(I.value,(n,r)=>(o(),d("tr",{key:n.id},[l("td",null,u(n.name),1),l("td",null,u(n.category?.name||"-"),1),l("td",null,u(n.unit_name),1),l("td",null,[g(l("select",{"onUpdate:modelValue":s=>n.supplier_id=s,class:h(["form-select w-100",{"is-invalid":v.value[n.id]?.supplier_id}])},[t[8]||(t[8]=l("option",{value:"",disabled:"",hidden:""},"Select Supplier",-1)),(o(!0),d(q,null,P(M.suppliers,s=>(o(),d("option",{key:s.id,value:s.id},u(s.name),9,Ee))),128))],10,Oe),[[B,n.supplier_id]]),v.value[n.id]?.supplier_id?(o(),d("small",Fe,u(v.value[n.id].supplier_id[0]),1)):_("",!0)]),l("td",null,[g(l("input",{type:"number",min:"0","onUpdate:modelValue":s=>n.qty=s,class:h(["form-control",{"is-invalid":i.value[r]?.qty}]),onInput:s=>A(n)},null,42,je),[[V,n.qty,void 0,{number:!0}]]),i.value[r]?.qty?(o(),d("small",Be,u(i.value[r].qty),1)):_("",!0)]),l("td",null,[g(l("select",{class:"form-select","onUpdate:modelValue":s=>n.selected_derived_unit_id=s,onChange:s=>Y(n),onFocus:s=>T(n)},[l("option",Ae,"Base ("+u(n.unit_name)+")",1),(o(!0),d(q,null,P(n.derived_units||[],s=>(o(),d("option",{key:s.id,value:s.id},u(s.name),9,Le))),128))],40,$e),[[B,n.selected_derived_unit_id]])]),l("td",null,[g(l("input",{type:"number",min:"0","onUpdate:modelValue":s=>n.unitPrice=s,class:h(["form-control",{"is-invalid":i.value[r]?.unitPrice}]),onInput:s=>L(n)},null,42,Te),[[V,n.unitPrice,void 0,{number:!0}]]),i.value[r]?.unitPrice?(o(),d("small",ze,u(i.value[r].unitPrice),1)):_("",!0)]),l("td",null,u(x(w)((n.subtotal||0).toFixed(2))),1),l("td",null,[l("button",{class:"btn btn-sm btn-outline-danger d-flex align-items-center justify-content-center",onClick:s=>G(n),title:"Clear",style:{width:"36px",height:"36px"}},[...t[9]||(t[9]=[l("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",fill:"currentColor",viewBox:"0 0 16 16"},[l("path",{"fill-rule":"evenodd",d:"M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"}),l("path",{d:"M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"})],-1)])],8,Qe)])]))),128))])])]),l("div",Re," Total: "+u(x(w)(W.value.toFixed(2))),1)])):_("",!0)]),l("div",Ze,[f.value==="single"?(o(),d("button",{key:0,class:"btn btn-primary rounded-pill px-4 py-2",disabled:D.value,onClick:le},[D.value?(o(),d("span",Je,"Saving...")):(o(),d("span",He,"Save"))],8,Ge)):_("",!0),f.value==="multiple"?(o(),d("button",{key:1,class:"btn btn-primary rounded-pill px-4 py-2",disabled:S.value,onClick:ne},[S.value?(o(),d("span",Xe,"Saving...")):(o(),d("span",We,"Save"))],8,Ke)):_("",!0)])])])]))}},dt=se(Ye,[["__scopeId","data-v-b959f0a6"]]);export{dt as default};

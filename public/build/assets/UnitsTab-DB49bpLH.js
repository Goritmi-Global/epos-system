import{_ as se,r as f,c as z,y as q,o as oe,f as r,b as i,d as S,e as t,u as A,h as ne,m as k,k as E,v as B,l as y,F as D,g as X,t as c,C as le,S as re,Y as H,i as M,T as ie,p as F,n as de,q as n}from"./app-CRMeeo4o.js";import{E as ue,a as ce,X as me,u as N,w as ve}from"./xlsx-1zor7sG0.js";import{I as pe}from"./importFile-Cfd1V3Gj.js";import{P as fe}from"./plus-uqwpwfA1.js";import{P as be}from"./pencil-BqQZuu2t.js";import"./createLucideIcon-Dj58dWNk.js";const ge={class:"card border-0 shadow-lg rounded-4"},he={class:"card-body"},_e={class:"d-flex flex-wrap gap-2 justify-content-between align-items-center mb-3"},ye={class:"d-flex gap-2"},we={class:"search-wrap"},xe={class:"dropdown"},Ue={class:"dropdown-menu dropdown-menu-end shadow rounded-4 py-2"},Ce={class:"table-responsive"},ke={class:"table table-hover"},Se={key:0},Ee={class:"fw-semibold"},De={class:"fw-semibold"},Fe={class:"fw-semibold"},Pe={class:"text-center"},Ne={class:"d-inline-flex align-items-center gap-3"},Le=["onClick"],Te={key:0},Ie={colspan:"5",class:"text-center text-muted py-4"},$e={key:0,class:"mt-4 d-flex justify-content-between align-items-center"},Ve={class:"text-muted small"},je={class:"modal fade",id:"modalUnitForm",tabindex:"-1","aria-hidden":"true"},Ae={class:"modal-dialog modal-lg modal-dialog-centered"},Be={class:"modal-content rounded-4"},Me={class:"modal-header"},Oe={class:"modal-title"},Re={class:"modal-body"},ze={class:"mb-3 d-flex gap-3 align-items-center"},qe={class:"form-check-label"},Xe={class:"form-check-label"},He={class:"text-muted d-block mt-1"},Ge={key:0},We={key:0,class:"text-danger"},Ye={key:1,class:"mt-3"},Je={key:0,class:"alert alert-warning"},Ke=["value"],Qe={key:2,class:"text-danger"},Ze={key:3,class:"text-danger"},et={class:"col-md-2 mt-4"},tt=["disabled"],at={__name:"UnitsTab",setup(st){const P=f(!1),I=f(null),m=f(""),v=f("base"),_=f(null),b=f(null),w=f(""),O=z(()=>d.value.filter(s=>!s.base_unit_id)),L=()=>{m.value="",l.value={},v.value="base",_.value=null,b.value=null},$=z(()=>{const s=w.value.trim().toLowerCase();return s?d.value.filter(e=>e.name.toLowerCase().includes(s)):d.value}),G=()=>{P.value=!1,m.value=""},W=s=>{P.value=!0,I.value=s,m.value=s.name,v.value=s.base_unit_id?"derived":"base",_.value=s.base_unit_id,b.value=s.conversion_factor},Y=async s=>{try{l.value={},await F.delete(`/units/${s.id}`),d.value=d.value.filter(e=>e.id!==s.id),n.success("Unit deleted successfully")}catch(e){e.response&&e.response.data&&e.response.data.message?(l.value.delete=e.response.data.message,n.error(e.response.data.message)):(l.value.delete="An unexpected error occurred while deleting the unit.",n.error("Delete failed"))}},h=f(!1),J=async()=>{if(!h.value){if(!m.value.trim()){n.error("Please fill out the field can't save an empty field."),l.value={name:["Please fill out the field can't save an empty field"]};return}if(P.value){if(v.value==="derived"){if(!_.value){n.error("Please select a base unit"),l.value={base_unit_id:["Base unit is required for derived units"]};return}if(!b.value||b.value<=0){n.error("Please enter a valid conversion factor"),l.value={conversion_factor:["Conversion factor must be greater than 0"]};return}}try{h.value=!0;const s={name:m.value.trim(),base_unit_id:v.value==="derived"?Number(_.value):null,conversion_factor:v.value==="derived"?Number(b.value):null},{data:e}=await F.put(`/units/${I.value.id}`,s),a=d.value.findIndex(o=>o.id===I.value.id);a!==-1&&(d.value[a]=e),n.success("Unit updated successfully"),await x(),L(),V("modalUnitForm")}catch(s){s.response?.data?.errors?(l.value={},Object.entries(s.response.data.errors).forEach(([e,a])=>{a.forEach(p=>n.error(p));const o=e.includes(".")?"name":e;l.value[o]=a})):n.error("Update failed")}finally{h.value=!1}}else{if(d.value.some(e=>e.name.toLowerCase()===m.value.trim().toLowerCase())){n.error(`Unit "${m.value.trim()}" already exists. Please use a different name or edit the existing unit.`),l.value={name:[`Unit "${m.value.trim()}" already exists`]};return}if(v.value==="derived"){if(!_.value){n.error("Please select a base unit"),l.value={base_unit_id:["Base unit is required"]};return}if(!b.value||b.value<=0){n.error("Please enter a valid conversion factor"),l.value={conversion_factor:["Conversion factor must be greater than 0"]};return}const e={name:m.value.trim(),base_unit_id:_.value,conversion_factor:b.value};try{h.value=!0;const a=await F.post("/units",{units:[e]}),o=a.data?.units??a.data;Array.isArray(o)&&o.length&&(d.value=[...d.value,...o]),n.success("Derived unit added successfully"),L(),V("modalUnitForm"),await x()}catch(a){a.response?.data?.errors?(l.value={},Object.entries(a.response.data.errors).forEach(([o,p])=>{p.forEach(u=>n.error(u));const U=o.includes(".name")?"name":o.includes(".base_unit_id")?"base_unit_id":o.includes(".conversion_factor")?"conversion_factor":o;l.value[U]=p})):(console.error(a),n.error("Create failed"))}finally{h.value=!1}}else{const e={name:m.value.trim(),base_unit_id:null,conversion_factor:null};try{h.value=!0;const a=await F.post("/units",{units:[e]}),o=a.data?.units??a.data;Array.isArray(o)&&o.length&&(d.value=[...d.value,...o]),n.success("Unit added successfully"),L(),V("modalUnitForm"),await x()}catch(a){a.response?.data?.errors?Object.values(a.response.data.errors).forEach(o=>o.forEach(p=>n.error(p))):(console.error(a),n.error("Create failed"))}finally{h.value=!1}}}}},V=s=>{const e=document.getElementById(s);if(!e)return;(window.bootstrap?.Modal.getInstance(e)||new window.bootstrap.Modal(e)).hide()},d=f([]),g=f({current_page:1,last_page:1,per_page:10,total:0,from:0,to:0,links:[]}),T=f(!1),l=f({}),x=async(s=null)=>{T.value=!0;try{const{data:e}=await F.get("/units",{params:{q:w.value,page:s||g.value.current_page,per_page:g.value.per_page}});d.value=e.data||[],g.value={current_page:e.current_page,last_page:e.last_page,per_page:e.per_page,total:e.total,from:e.from,to:e.to,links:e.links},await de(),window.feather?.replace()}catch(e){console.error("Failed to fetch units",e),n.error("Failed to load units")}finally{T.value=!1}},K=s=>{if(!s)return;const a=new URLSearchParams(s.split("?")[1]).get("page");a&&x(parseInt(a))};let R=null;q(w,()=>{clearTimeout(R),R=setTimeout(()=>{g.value.current_page=1,x(1)},500)});const j=s=>{if(!d.value||d.value.length===0){n.error("No Units data to download");return}const e=w.value.trim()?$.value:d.value;if(e.length===0){n.error("No Units found to download");return}try{s==="pdf"?Z(e):s==="excel"?ee(e):s==="csv"?Q(e):n.error("Invalid download type")}catch(a){console.error("Download failed:",a),n.error(`Download failed: ${a.message}`)}},Q=s=>{try{const e=["Name"],a=s.map(C=>[`"${C.name||""}"`]),o=[e.join(","),...a.map(C=>C.join(","))].join(`
`),p=new Blob([o],{type:"text/csv;charset=utf-8;"}),U=URL.createObjectURL(p),u=document.createElement("a");u.setAttribute("href",U),u.setAttribute("download",`units_${new Date().toISOString().split("T")[0]}.csv`),document.body.appendChild(u),u.click(),document.body.removeChild(u),n.success("CSV downloaded successfully")}catch(e){console.error("CSV generation error:",e),n.error(`CSV generation failed: ${e.message}`,{autoClose:5e3})}},Z=s=>{try{const e=new ue("p","mm","a4");e.setFontSize(20),e.setFont("helvetica","bold"),e.text("Units Report",14,20),e.setFontSize(10),e.setFont("helvetica","normal");const a=new Date().toLocaleString();e.text(`Generated on: ${a}`,14,28),e.text(`Total Units: ${s.length}`,14,34);const o=["Name"],p=s.map(u=>[u.name||""]);ce(e,{head:[o],body:p,startY:40,styles:{fontSize:10,cellPadding:3,halign:"left",lineColor:[0,0,0],lineWidth:.1},headStyles:{fillColor:[41,128,185],textColor:255,fontStyle:"bold"},alternateRowStyles:{fillColor:[240,240,240]},margin:{left:14,right:14},didDrawPage:u=>{const C=e.internal.getNumberOfPages(),ae=e.internal.pageSize.height;e.setFontSize(8),e.text(`Page ${u.pageNumber} of ${C}`,u.settings.margin.left,ae-10)}});const U=`units_${new Date().toISOString().split("T")[0]}.pdf`;e.save(U),n.success("PDF downloaded successfully")}catch(e){console.error("PDF generation error:",e),n.error(`PDF generation failed: ${e.message}`,{autoClose:5e3})}},ee=s=>{try{if(typeof me>"u")throw new Error("XLSX library is not loaded");const e=s.map(C=>({Name:C.name||""})),a=N.book_new(),o=N.json_to_sheet(e);o["!cols"]=[{wch:25}],N.book_append_sheet(a,o,"Units");const p=[{Info:"Generated On",Value:new Date().toLocaleString()},{Info:"Total Units",Value:s.length},{Info:"Exported By",Value:"Units Management System"}],U=N.json_to_sheet(p);N.book_append_sheet(a,U,"Report Info");const u=`units_${new Date().toISOString().split("T")[0]}.xlsx`;ve(a,u),n.success("Excel file downloaded successfully",{autoClose:2500})}catch(e){console.error("Excel generation error:",e),n.error(`Excel generation failed: ${e.message}`,{autoClose:5e3})}};oe(async()=>{await x(),window.feather?.replace()}),q(m,s=>{s&&l.value.name&&delete l.value.name});const te=s=>{if(!s||s.length<=1){n.error("The file is empty",{autoClose:3e3});return}s[0];const a=s.slice(1).map(o=>({name:o[0]||""}));F.post("/api/units/import",{units:a}).then(()=>{n.success("Units imported successfully"),x()}).catch(o=>{o?.response?.status===422&&o.response.data?.errors&&(l.value=o.response.data.errors,n.error("There may be some duplication in data",{autoClose:3e3}))})};return(s,e)=>(i(),r(D,null,[S(A(ne),{title:"Unit"}),t("div",ge,[t("div",he,[t("div",_e,[e[13]||(e[13]=t("h4",{class:"mb-0"},"Units",-1)),t("div",ye,[t("div",we,[e[10]||(e[10]=t("i",{class:"bi bi-search"},null,-1)),E(t("input",{"onUpdate:modelValue":e[0]||(e[0]=a=>w.value=a),class:"form-control search-input",placeholder:"Search"},null,512),[[B,w.value]])]),t("button",{"data-bs-toggle":"modal","data-bs-target":"#modalUnitForm",onClick:e[1]||(e[1]=()=>{G(),L(),l.value={}}),class:"d-flex align-items-center gap-1 px-4 btn-sm py-2 rounded-pill btn btn-primary text-white"},[S(A(fe),{class:"w-4 h-4"}),e[11]||(e[11]=y(" Add Unit ",-1))]),S(pe,{label:"Import",sampleHeaders:["Name"],sampleData:[["Example Unit 1"],["Example Unit 2"]],onOnImport:te}),t("div",xe,[e[12]||(e[12]=t("button",{class:"btn btn-outline-secondary btn-sm py-2 rounded-pill px-4 dropdown-toggle","data-bs-toggle":"dropdown"}," Export ",-1)),t("ul",Ue,[t("li",null,[t("a",{class:"dropdown-item py-2",href:"javascript:;",onClick:e[2]||(e[2]=a=>j("pdf"))},"Export as PDF")]),t("li",null,[t("a",{class:"dropdown-item py-2",href:"javascript:;",onClick:e[3]||(e[3]=a=>j("excel"))},"Export as Excel")]),t("li",null,[t("a",{class:"dropdown-item py-2",href:"javascript:;",onClick:e[4]||(e[4]=a=>j("csv"))}," Export as CSV ")])])])])]),t("div",Ce,[t("table",ke,[e[15]||(e[15]=t("thead",{class:"border-top small text-muted"},[t("tr",null,[t("th",null,"S. #"),t("th",null,"Unit Name"),t("th",null,"Derived From"),t("th",null,"Conversion Factor"),t("th",{class:"text-center"},"Action")])],-1)),t("tbody",null,[T.value?(i(),r("tr",Se,[...e[14]||(e[14]=[t("td",{colspan:"5",class:"text-center py-5"},[t("div",{class:"spinner-border text-primary",role:"status"},[t("span",{class:"visually-hidden"},"Loading...")]),t("p",{class:"text-muted mt-2 mb-0"},"Loading units...")],-1)])])):(i(),r(D,{key:1},[(i(!0),r(D,null,X($.value,(a,o)=>(i(),r("tr",{key:a.id},[t("td",null,c(g.value.from+o),1),t("td",Ee,c(a.name),1),t("td",De,c(a?.base_unit?.name),1),t("td",Fe,c(a.base_unit_id?a.conversion_factor:"-"),1),t("td",Pe,[t("div",Ne,[t("button",{"data-bs-toggle":"modal","data-bs-target":"#modalUnitForm",onClick:()=>{W(a),l.value={}},title:"Edit",class:"p-2 rounded-full text-blue-600 hover:bg-blue-100"},[S(A(be),{class:"w-4 h-4"})],8,Le),S(le,{title:"Confirm Delete",message:`Are you sure you want to delete ${a.name}?`,showDeleteButton:!0,onConfirm:()=>{Y(a)},onCancel:()=>{}},null,8,["message","onConfirm"])])])]))),128)),$.value.length===0?(i(),r("tr",Te,[t("td",Ie,c(w.value.trim()?"No units found matching your search.":"No units found."),1)])):k("",!0)],64))])])]),!T.value&&g.value.last_page>1?(i(),r("div",$e,[t("div",Ve," Showing "+c(g.value.from)+" to "+c(g.value.to)+" of "+c(g.value.total)+" entries ",1),S(re,{pagination:g.value.links,isApiDriven:!0,onPageChanged:K},null,8,["pagination"])])):k("",!0)])]),t("div",je,[t("div",Ae,[t("div",Be,[t("div",Me,[t("h5",Oe,c(P.value?"Edit Unit":"Add Unit(s)"),1),e[16]||(e[16]=t("button",{class:"absolute top-2 right-2 p-2 rounded-full hover:bg-gray-100 transition transform hover:scale-110","data-bs-dismiss":"modal","aria-label":"Close",title:"Close"},[t("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-6 w-6 text-red-500",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor","stroke-width":"2"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M6 18L18 6M6 6l12 12"})])],-1))]),t("div",Re,[t("div",ze,[t("label",qe,[E(t("input",{type:"radio",class:"form-check-input me-2",value:"base","onUpdate:modelValue":e[5]||(e[5]=a=>v.value=a)},null,512),[[H,v.value]]),e[17]||(e[17]=y(" Base Unit ",-1))]),t("label",Xe,[E(t("input",{type:"radio",class:"form-check-input me-2",value:"derived","onUpdate:modelValue":e[6]||(e[6]=a=>v.value=a)},null,512),[[H,v.value]]),e[18]||(e[18]=y(" Derived Unit ",-1))])]),t("div",null,[e[24]||(e[24]=t("label",{class:"form-label"},"Unit Name",-1)),E(t("input",{"onUpdate:modelValue":e[7]||(e[7]=a=>m.value=a),class:M(["form-control",{"is-invalid":l.value.name}]),placeholder:"e.g., Millilitre (ml)"},null,2),[[B,m.value]]),t("small",He,[v.value==="derived"?(i(),r("span",Ge,` ⚠️ Enter a NEW unit name (e.g., "ml" if base is "L"). Don't use existing unit names. `)):k("",!0)]),l.value.name?(i(),r("div",We,c(l.value.name[0]),1)):k("",!0),v.value==="derived"?(i(),r("div",Ye,[e[20]||(e[20]=t("div",{class:"alert alert-info"},[t("strong",null,"Example:"),y(' If you want to create "Millilitre (ml)" from "Litre (L)":'),t("br"),y(' • Select "Litre (L)" as base unit'),t("br"),y(" • Enter conversion: 0.001 (because 1 ml = 0.001 L) ")],-1)),e[21]||(e[21]=t("label",{class:"form-label"},"Base Unit",-1)),O.value.length===0?(i(),r("div",Je," No base units available. Please create base units first before creating derived units. ")):E((i(),r("select",{key:1,"onUpdate:modelValue":e[8]||(e[8]=a=>_.value=a),class:M(["form-select",{"is-invalid":l.value.base_unit_id}])},[e[19]||(e[19]=t("option",{value:null,disabled:""},"Select base unit",-1)),(i(!0),r(D,null,X(O.value,a=>(i(),r("option",{key:a.id,value:a.id},c(a.name),9,Ke))),128))],2)),[[ie,_.value]]),l.value.base_unit_id?(i(),r("div",Qe,c(l.value.base_unit_id[0]),1)):k("",!0),e[22]||(e[22]=t("label",{class:"form-label mt-3"},"Conversion Factor",-1)),E(t("input",{type:"number",step:"any","onUpdate:modelValue":e[9]||(e[9]=a=>b.value=a),class:M(["form-control",{"is-invalid":l.value.conversion_factor}]),placeholder:"e.g., 0.001"},null,2),[[B,b.value,void 0,{number:!0}]]),e[23]||(e[23]=t("small",{class:"text-muted d-block mt-1"},"How many base units = 1 of this unit (e.g., 1 ml = 0.001 L)",-1)),l.value.conversion_factor?(i(),r("div",Ze,c(l.value.conversion_factor[0]),1)):k("",!0)])):k("",!0)]),t("div",et,[t("button",{class:"btn btn-primary rounded-pill py-2 btn-sm w-100",disabled:h.value,onClick:J},[h.value?(i(),r(D,{key:0},[e[25]||(e[25]=t("span",{class:"spinner-border spinner-border-sm me-2"},null,-1)),e[26]||(e[26]=y("Saving... ",-1))],64)):(i(),r(D,{key:1},[y(c((P.value,"Save")),1)],64))],8,tt)])])])])])],64))}},ut=se(at,[["__scopeId","data-v-ed92c8d9"]]);export{ut as default};

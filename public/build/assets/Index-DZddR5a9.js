import{_ as J,r as C,o as V,n as Z,c as g,I as ee,a as te,b as v,w as L,d as B,e as t,u as y,h as ae,t as d,k as M,f as w,v as oe,l as se,F as E,g as j,S as ne,m as re,q as h}from"./app-TGxiLcAW.js";import{_ as le}from"./Master-J2bJ-NOm.js";import{u as de}from"./useFormatters-C4x7YHWO.js";import{F as ie}from"./FilterModal-CczHNVxc.js";import{E as ue,a as ce,X as me,u as N,w as pe}from"./xlsx-CYRbBo-W.js";import"./index-DCqcadVw.js";import"./createLucideIcon-Bh-SXUX4.js";import"./index-2u1IeWL4.js";import"./index-C29vjDIk.js";import"./sun-C9h6XzSk.js";const ye={class:"page-wrapper"},he={class:"row g-3"},be={class:"col-6 col-md-4"},fe={class:"card border-0 shadow-sm rounded-4"},ve={class:"card-body d-flex align-items-center justify-content-between"},we={class:"mb-0 fw-bold"},ge={class:"col-6 col-md-4"},_e={class:"card border-0 shadow-sm rounded-4"},xe={class:"card-body d-flex align-items-center justify-content-between"},De={class:"mb-0 fw-bold"},Ce={class:"col-12 col-md-4"},Ne={class:"card border-0 shadow-sm rounded-4"},Te={class:"card-body d-flex align-items-center justify-content-between"},Pe={class:"mb-0 fw-bold"},Fe={class:"card border-0 shadow-lg rounded-4 mt-3"},Se={class:"card-body"},Ie={class:"d-flex flex-wrap gap-2 justify-content-between align-items-center mb-3"},$e={class:"d-flex flex-wrap gap-2 align-items-center"},ke={class:"search-wrap"},Ae={key:1,class:"form-control search-input",placeholder:"Search by Order ID",disabled:"",type:"text"},Oe={class:"col-md-6"},Ve=["onUpdate:modelValue"],Le=["value"],Be={class:"dropdown"},Me={class:"dropdown-menu dropdown-menu-end shadow rounded-4 py-2"},Ee={class:"table-responsive"},je={class:"table table-hover align-middle",style:{"min-height":"320px"}},Re={class:"text-success"},ze={class:"text-success"},Ge={class:"text-success"},He={class:"text-capitalize"},Ue={key:0},We={__name:"Index",setup(Xe){const{formatCurrencySymbol:b,dateFmt:T}=de(),_=C([]),R=async()=>{try{const o=await axios.get("/api/orders/all");_.value=o.data.data}catch(o){console.error("Error fetching orders:",o)}};V(async()=>{x.value="",$.value=Date.now(),await Z(),setTimeout(()=>{k.value=!0;const o=document.getElementById(F);o&&(o.value="",x.value="")},100),R()});const x=C(""),$=C(Date.now()),F=`search-${Math.random().toString(36).substr(2,9)}`,k=C(!1),r=C({sortBy:"",paymentType:"",dateFrom:"",dateTo:"",priceMin:null,priceMax:null}),P=g(()=>_.value.map(o=>{const e=Array.isArray(o.promo)&&o.promo.length>0?o.promo[0]:null;return{orderId:o.id,customer:o.customer_name,user:o.user?.name||"—",type:o.payment?.payment_type||"—",serviceCharges:Number(o.service_charges||0),deliveryCharges:Number(o.delivery_charges||0),tax:Number(o.tax||0),amountReceived:Number(o.sub_total||0),promoDiscount:e?Number(e.discount_amount||0):0,salesDiscount:Number(o.sales_discount||0),approvedDiscount:Number(o.approved_discounts||0),grandTotal:Number(o.total_amount||0),promoName:e?e.promo_name:"—",paidAt:o.payment?.payment_date||null,status:o.status}})),A=g(()=>{const o=x.value.trim().toLowerCase();let e=[...P.value];if(o&&(e=e.filter(a=>[String(a.orderId),a.customer||"",a.user||"",a.type||"",String(a.grandTotal),X(a.paidAt)].join(" ").toLowerCase().includes(o))),r.value.paymentType&&(e=e.filter(a=>(a.type??"").toLowerCase()===r.value.paymentType.toLowerCase())),r.value.priceMin!==null&&r.value.priceMin!==""&&(e=e.filter(a=>(Number(a.grandTotal)||0)>=Number(r.value.priceMin))),r.value.priceMax!==null&&r.value.priceMax!==""&&(e=e.filter(a=>(Number(a.grandTotal)||0)<=Number(r.value.priceMax))),r.value.dateFrom&&(e=e.filter(a=>{if(!a.paidAt)return!1;const s=new Date(a.paidAt),c=new Date(r.value.dateFrom);return c.setHours(0,0,0,0),s>=c})),r.value.dateTo&&(e=e.filter(a=>{if(!a.paidAt)return!1;const s=new Date(a.paidAt),c=new Date(r.value.dateTo);return c.setHours(23,59,59,999),s<=c})),r.value.sortBy)switch(e=[...e],r.value.sortBy){case"date_desc":e.sort((a,s)=>new Date(s.paidAt)-new Date(a.paidAt));break;case"date_asc":e.sort((a,s)=>new Date(a.paidAt)-new Date(s.paidAt));break;case"amount_desc":e.sort((a,s)=>Number(s.grandTotal)-Number(a.grandTotal));break;case"amount_asc":e.sort((a,s)=>Number(a.grandTotal)-Number(s.grandTotal));break;case"order_asc":e.sort((a,s)=>Number(a.orderId)-Number(s.orderId));break;case"order_desc":e.sort((a,s)=>Number(s.orderId)-Number(a.orderId));break}return e}),z=o=>{r.value={...r.value,...o}},G=()=>{r.value={sortBy:"",paymentType:"",dateFrom:"",dateTo:"",priceMin:null,priceMax:null}},O=g(()=>({sortOptions:[{value:"date_desc",label:"Date: Newest First"},{value:"date_asc",label:"Date: Oldest First"},{value:"amount_desc",label:"Amount: High to Low"},{value:"amount_asc",label:"Amount: Low to High"},{value:"order_asc",label:"Order ID: Low to High"},{value:"order_desc",label:"Order ID: High to Low"}],paymentTypeOptions:[{value:"Cash",label:"Cash"},{value:"Card",label:"Card"},{value:"Split",label:"Split"},{value:"QR",label:"QR"},{value:"Bank",label:"Bank"}]})),H=g(()=>P.value.length),U=g(()=>{const o=new Date,e=new Date(o.getFullYear(),o.getMonth(),o.getDate()),a=new Date(o.getFullYear(),o.getMonth(),o.getDate()+1);return P.value.filter(s=>{if(!s.paidAt)return!1;const c=new Date(s.paidAt);return c>=e&&c<a}).length}),W=g(()=>P.value.reduce((o,e)=>o+Number(e.amount||0),0));function X(o){return o?new Date(o).toLocaleString("en-GB",{day:"2-digit",month:"short",year:"numeric",hour:"numeric",minute:"2-digit",hour12:!0}):"—"}V(()=>window.feather?.replace()),ee(()=>window.feather?.replace());const S=o=>{if(!_.value||_.value.length===0){h.error("No payment data to download");return}const e=_.value.filter(a=>a.payment);if(e.length===0){h.error("No payments found to download");return}try{o==="pdf"?q(e):o==="excel"?Q(e):o==="csv"?Y(e):h.error("Invalid download type")}catch(a){console.error("Download failed:",a),h.error(`Download failed: ${a.message}`)}},Y=o=>{try{const e=["Order ID","Date","Customer","Order Type","Payment Type","Amount Received","Cash Amount","Card Amount","Card Brand","Last 4 Digits","Currency","Order Total","Status"],a=o.map(m=>{const p=m.payment||{};return[`"${m.id||""}"`,`"${T(m.created_at)}"`,`"${m.customer_name||"Walk In"}"`,`"${m.type?.order_type||"-"}"`,`"${p.payment_type||"-"}"`,`"${Number(p.amount_received||0).toFixed(2)}"`,`"${Number(p.cash_amount||0).toFixed(2)}"`,`"${Number(p.card_amount||0).toFixed(2)}"`,`"${p.brand||"-"}"`,`"${p.last_digits||"-"}"`,`"${p.currency_code||"GBP"}"`,`"${Number(m.total_amount||0).toFixed(2)}"`,`"${m.status||""}"`]}),s=[e.join(","),...a.map(m=>m.join(","))].join(`
`),c=new Blob([s],{type:"text/csv;charset=utf-8;"}),D=URL.createObjectURL(c),f=document.createElement("a");f.setAttribute("href",D),f.setAttribute("download",`Payments_${new Date().toISOString().split("T")[0]}.csv`),document.body.appendChild(f),f.click(),document.body.removeChild(f),h.success("Payments CSV downloaded successfully")}catch(e){console.error("CSV generation error:",e),h.error(`CSV generation failed: ${e.message}`)}},q=o=>{try{const e=new ue("l","mm","a4");e.setFontSize(18),e.setFont("helvetica","bold"),e.text("Payments Report",14,20),e.setFontSize(10),e.setFont("helvetica","normal");const a=new Date().toLocaleString();e.text(`Generated on: ${a}`,14,28),e.text(`Total Payments: ${o.length}`,14,34);const s=o.reduce((l,u)=>l+Number(u.total_amount||0),0),c=o.reduce((l,u)=>l+Number(u.payment?.cash_amount||0),0),D=o.reduce((l,u)=>l+Number(u.payment?.card_amount||0),0);e.text(`Total Revenue: £${s.toFixed(2)}`,14,40),e.text(`Cash: £${c.toFixed(2)} | Card: £${D.toFixed(2)}`,14,46);const f=["Order ID","Date","Customer","Order Type","Payment Type","Amount","Cash","Card","Brand","Status"],m=o.map(l=>{const u=l.payment||{};return[l.id||"",T(l.created_at),l.customer_name||"Walk In",l.type?.order_type||"-",u.payment_type||"-",`£${Number(u.amount_received||0).toFixed(2)}`,`£${Number(u.cash_amount||0).toFixed(2)}`,`£${Number(u.card_amount||0).toFixed(2)}`,u.brand||"-",l.status||""]});ce(e,{head:[f],body:m,startY:52,styles:{fontSize:8,cellPadding:2,halign:"left",lineColor:[0,0,0],lineWidth:.1},headStyles:{fillColor:[41,128,185],textColor:255,fontStyle:"bold"},alternateRowStyles:{fillColor:[245,245,245]},margin:{left:14,right:14},didDrawPage:l=>{const u=e.internal.getNumberOfPages(),I=e.internal.pageSize.height;e.setFontSize(8),e.text(`Page ${l.pageNumber} of ${u}`,l.settings.margin.left,I-10)}});const p=`Payments_${new Date().toISOString().split("T")[0]}.pdf`;e.save(p),h.success("Payments PDF downloaded successfully")}catch(e){console.error("PDF generation error:",e),h.error(`PDF generation failed: ${e.message}`)}},Q=o=>{try{if(typeof me>"u")throw new Error("XLSX library is not loaded");const e=o.map(n=>{const i=n.payment||{};return{"Order ID":n.id||"",Date:T(n.created_at),Time:n.created_at,Customer:n.customer_name||"Walk In","Order Type":n.type?.order_type||"-","Table Number":n.type?.table_number||"-","Payment Type":i.payment_type||"-","Amount Received":Number(i.amount_received||0).toFixed(2),"Cash Amount":Number(i.cash_amount||0).toFixed(2),"Card Amount":Number(i.card_amount||0).toFixed(2),"Card Brand":i.brand||"-","Last 4 Digits":i.last_digits||"-","Exp Month":i.exp_month||"-","Exp Year":i.exp_year||"-",Currency:i.currency_code||"GBP","Order Total":Number(n.total_amount||0).toFixed(2),Status:n.status||"","Refund Status":i.refund_status||"None"}}),a=N.book_new(),s=N.json_to_sheet(e);s["!cols"]=[{wch:10},{wch:12},{wch:15},{wch:20},{wch:12},{wch:12},{wch:12},{wch:15},{wch:12},{wch:12},{wch:12},{wch:12},{wch:10},{wch:10},{wch:10},{wch:12},{wch:10},{wch:15}],N.book_append_sheet(a,s,"Payments");const c=o.reduce((n,i)=>n+Number(i.total_amount||0),0),D=o.reduce((n,i)=>n+Number(i.payment?.cash_amount||0),0),f=o.reduce((n,i)=>n+Number(i.payment?.card_amount||0),0),m=o.filter(n=>n.payment?.payment_type?.toLowerCase()==="cash").length,p=o.filter(n=>n.payment?.payment_type?.toLowerCase()==="card").length,l=o.filter(n=>n.payment?.payment_type?.toLowerCase()==="split").length,u=[{Info:"Generated On",Value:new Date().toLocaleString()},{Info:"Total Payments",Value:o.length},{Info:"Total Revenue",Value:`£${c.toFixed(2)}`},{Info:"Total Cash",Value:`£${D.toFixed(2)}`},{Info:"Total Card",Value:`£${f.toFixed(2)}`},{Info:"Cash Payments Count",Value:m},{Info:"Card Payments Count",Value:p},{Info:"Split Payments Count",Value:l},{Info:"Exported By",Value:"Payment Management System"}],I=N.json_to_sheet(u);N.book_append_sheet(a,I,"Summary");const K=`Payments_${new Date().toISOString().split("T")[0]}.xlsx`;pe(a,K),h.success("Payments Excel file downloaded successfully")}catch(e){console.error("Excel generation error:",e),h.error(`Excel generation failed: ${e.message}`)}};return(o,e)=>(v(),te(le,null,{default:L(()=>[B(y(ae),{title:"Payment"}),t("div",ye,[e[20]||(e[20]=t("h4",{class:"fw-semibold mb-3"},"Overall Payments",-1)),t("div",he,[t("div",be,[t("div",fe,[t("div",ve,[t("div",null,[t("h3",we,d(H.value),1),e[6]||(e[6]=t("p",{class:"text-muted mb-0 small"},"Total Payments",-1))]),e[7]||(e[7]=t("div",{class:"rounded-circle p-3 bg-primary-subtle text-primary d-flex align-items-center justify-content-center",style:{width:"56px",height:"56px"}},[t("i",{class:"bi bi-list-check fs-4"})],-1))])])]),t("div",ge,[t("div",_e,[t("div",xe,[t("div",null,[t("h3",De,d(U.value),1),e[8]||(e[8]=t("p",{class:"text-muted mb-0 small"},"Today's Payments",-1))]),e[9]||(e[9]=t("div",{class:"rounded-circle p-3 bg-success-subtle text-success d-flex align-items-center justify-content-center",style:{width:"56px",height:"56px"}},[t("i",{class:"bi bi-calendar-day fs-4"})],-1))])])]),t("div",Ce,[t("div",Ne,[t("div",Te,[t("div",null,[t("h3",Pe,d(y(b)(W.value,"GBP")),1),e[10]||(e[10]=t("p",{class:"text-muted mb-0 small"},"Total Amount",-1))]),e[11]||(e[11]=t("div",{class:"rounded-circle p-3 bg-warning-subtle text-warning d-flex align-items-center justify-content-center",style:{width:"56px",height:"56px"}},[t("i",{class:"bi bi-currency-pound fs-4"})],-1))])])])]),t("div",Fe,[t("div",Se,[t("div",Ie,[e[17]||(e[17]=t("h5",{class:"mb-0 fw-semibold"},"Payments",-1)),t("div",$e,[t("div",ke,[e[12]||(e[12]=t("i",{class:"bi bi-search"},null,-1)),e[13]||(e[13]=t("input",{type:"email",name:"email",autocomplete:"email",style:{position:"absolute",left:"-9999px",width:"1px",height:"1px"},tabindex:"-1","aria-hidden":"true"},null,-1)),k.value?M((v(),w("input",{id:F,"onUpdate:modelValue":e[0]||(e[0]=a=>x.value=a),key:$.value,class:"form-control search-input",placeholder:"Search by Order ID",type:"search",autocomplete:"new-password",name:F,role:"presentation",onFocus:e[1]||(e[1]=(...a)=>o.handleFocus&&o.handleFocus(...a))},null,32)),[[oe,x.value]]):(v(),w("input",Ae))]),B(ie,{modelValue:r.value,"onUpdate:modelValue":e[2]||(e[2]=a=>r.value=a),title:"Payments","modal-id":"paymentFilterModal","modal-size":"modal-lg","sort-options":O.value.sortOptions,"show-price-range":!0,"show-date-range":!0,"show-stock-status":!1,"price-label":"Amount Range",onApply:z,onClear:G},{customFilters:L(({filters:a})=>[t("div",Oe,[e[15]||(e[15]=t("label",{class:"form-label fw-semibold text-dark"},[t("i",{class:"fas fa-credit-card me-2 text-muted"}),se("Payment Type ")],-1)),M(t("select",{"onUpdate:modelValue":s=>a.paymentType=s,class:"form-select"},[e[14]||(e[14]=t("option",{value:""},"All",-1)),(v(!0),w(E,null,j(O.value.paymentTypeOptions,s=>(v(),w("option",{key:s.value,value:s.value},d(s.label),9,Le))),128))],8,Ve),[[ne,a.paymentType]])])]),_:1},8,["modelValue","sort-options"]),t("div",Be,[e[16]||(e[16]=t("button",{class:"btn btn-outline-secondary rounded-pill px-4 dropdown-toggle","data-bs-toggle":"dropdown"}," Export ",-1)),t("ul",Me,[t("li",null,[t("a",{class:"dropdown-item py-2",href:"javascript:;",onClick:e[3]||(e[3]=a=>S("pdf"))}," Export as PDF ")]),t("li",null,[t("a",{class:"dropdown-item py-2",href:"javascript:;",onClick:e[4]||(e[4]=a=>S("excel"))}," Export as Excel ")]),t("li",null,[t("a",{class:"dropdown-item py-2",href:"javascript:;",onClick:e[5]||(e[5]=a=>S("csv"))}," Export as CSV ")])])])])]),t("div",Ee,[t("table",je,[e[19]||(e[19]=t("thead",{class:"border-top small text-muted"},[t("tr",null,[t("th",null,"S. #"),t("th",null,"Order ID"),t("th",null,"Actual Payment"),t("th",null,"Promo Name"),t("th",null,"Promo Discount"),t("th",null,"Sales Discount"),t("th",null,"Approved Discount"),t("th",null,"Tax"),t("th",null,"Service Charges"),t("th",null,"Delivery Charges"),t("th",null,"Grand Total"),t("th",null,"Payment Date"),t("th",null,"Payment Type")])],-1)),t("tbody",null,[(v(!0),w(E,null,j(A.value,(a,s)=>(v(),w("tr",{key:a.orderId},[t("td",null,d(s+1),1),t("td",null,d(a.orderId),1),t("td",null,d(y(b)(a.amountReceived)),1),t("td",null,d(a.promoName),1),t("td",Re,d(a.promoDiscount?y(b)(a.promoDiscount):"—"),1),t("td",ze,d(a.salesDiscount?y(b)(a.salesDiscount):"—"),1),t("td",Ge,d(a.approvedDiscount?y(b)(a.approvedDiscount):"—"),1),t("td",null,d(y(b)(a.tax)),1),t("td",null,d(y(b)(a.serviceCharges)),1),t("td",null,d(y(b)(a.deliveryCharges)),1),t("td",null,d(y(b)(a.grandTotal)),1),t("td",null,d(y(T)(a.paidAt)),1),t("td",He,d(a.type),1)]))),128)),A.value.length===0?(v(),w("tr",Ue,[...e[18]||(e[18]=[t("td",{colspan:"13",class:"text-center text-muted py-4"}," No payments found. ",-1)])])):re("",!0)])])])])])])]),_:1}))}},st=J(We,[["__scopeId","data-v-453cdcd4"]]);export{st as default};

import{_ as ae,r as _,o as U,n as oe,c as P,I as se,w as le,a as ne,b as v,d as z,e as I,f as t,u as p,h as re,t as i,g as h,l as G,m as H,v as ie,p as ue,F as A,i as W,T as de,P as ce,s as y}from"./app-CYYlfszq.js";import{_ as me}from"./Master-B6Go9fCb.js";import{u as pe}from"./useFormatters-RJKnQoSm.js";import{F as ve}from"./FilterModal-C-YUVCAT.js";import{E as ye,a as _e,X as he,u as S,w as ge}from"./xlsx-CrmoAxyJ.js";import{s as be}from"./index-B7NINf2j.js";import"./index-C-KxnP12.js";import"./createLucideIcon-D217t_iT.js";import"./index-DJNrC0mS.js";import"./index-Dz-aUUP8.js";import"./sun-B21gpqoz.js";import"./index-BzmJYhwS.js";import"./index-B3Pqd2wp.js";import"./index-BxpxhNZZ.js";import"./index-BuSNz9fi.js";const fe={class:"page-wrapper"},xe={class:"row g-3"},we={class:"col-6 col-md-4"},Fe={class:"card border-0 shadow-sm rounded-4"},De={class:"card-body d-flex align-items-center justify-content-between"},Te={class:"mb-0 fw-bold"},Pe={class:"col-6 col-md-4"},Ne={class:"card border-0 shadow-sm rounded-4"},Se={class:"card-body d-flex align-items-center justify-content-between"},Ce={class:"mb-0 fw-bold"},$e={class:"col-12 col-md-4"},Ie={class:"card border-0 shadow-sm rounded-4"},ke={class:"card-body d-flex align-items-center justify-content-between"},Me={class:"mb-0 fw-bold"},Oe={class:"card border-0 shadow-lg rounded-4 mt-3"},Ve={class:"card-body"},Ae={class:"d-flex flex-wrap gap-2 justify-content-between align-items-center mb-3"},Re={class:"d-flex flex-wrap gap-2 align-items-center"},Be={class:"search-wrap"},Ee={key:1,class:"form-control search-input",placeholder:"Search by Order ID",disabled:"",type:"text"},je={class:"col-md-6"},Le=["onUpdate:modelValue"],Ue=["value"],ze={class:"table-responsive"},Ge={class:"table table-hover align-middle"},He={key:0},We={class:"text-success"},Xe={class:"text-success"},qe={class:"text-success"},Ye={class:"text-capitalize"},Qe={key:0},Ke={key:0,class:"mt-4 d-flex justify-content-between align-items-center"},Je={class:"text-muted small"},Ze={__name:"Index",setup(et){const{formatCurrencySymbol:g,dateFmt:C}=pe(),T=_([]),x=_(!1),$=_({total_payments:0,todays_payments:0,total_amount:0}),m=_({current_page:1,last_page:1,per_page:10,total:0,from:0,to:0,links:[]}),k=_(null),X=[{label:"PDF",value:"pdf"},{label:"Excel",value:"excel"},{label:"CSV",value:"csv"}],q=a=>{a.value&&(J(a.value),k.value=null)},N=async(a=null)=>{x.value=!0;try{const e={q:w.value,page:a||m.value.current_page,per_page:m.value.per_page,sort_by:r.value.sortBy||"",payment_type:r.value.paymentType||"",date_from:r.value.dateFrom||"",date_to:r.value.dateTo||"",price_min:r.value.priceMin||"",price_max:r.value.priceMax||""};Object.keys(e).forEach(s=>{(e[s]===void 0||e[s]==="")&&delete e[s]});const o=await axios.get("/api/payments/all",{params:e});T.value=o.data.data.map(s=>{const l=s.order||{};return{id:l.id,customer_name:l.customer_name,promo:l.promo,service_charges:l.service_charges,delivery_charges:l.delivery_charges,tax:l.tax,sub_total:l.sub_total,sales_discount:l.sales_discount,approved_discounts:l.approved_discounts,total_amount:l.total_amount,status:l.status,type:l.type,payment_type:s.payment_type,amount_received:s.amount_received,payment_date:s.payment_date,user:s.user}}),o.data.stats&&($.value=o.data.stats),m.value={current_page:o.data.current_page,last_page:o.data.last_page,per_page:o.data.per_page,total:o.data.total,from:o.data.from,to:o.data.to,links:o.data.links}}catch(e){console.error("Error fetching payments:",e),T.value=[],y.error("Failed to load payments")}finally{x.value=!1}},Y=a=>{if(!a)return;const o=new URLSearchParams(a.split("?")[1]).get("page");o&&N(parseInt(o))};U(async()=>{w.value="",R.value=Date.now(),await oe(),setTimeout(()=>{B.value=!0;const e=document.getElementById(M);e&&(e.value="",w.value="")},100),N();const a=document.getElementById("paymentFilterModal");a&&a.addEventListener("hidden.bs.modal",()=>{f.value={sortBy:r.value.sortBy||"",paymentType:r.value.paymentType||"",dateFrom:r.value.dateFrom||"",dateTo:r.value.dateTo||"",priceMin:r.value.priceMin||null,priceMax:r.value.priceMax||null}})});const w=_(""),R=_(Date.now()),M=`search-${Math.random().toString(36).substr(2,9)}`,B=_(!1),f=_({sortBy:"",paymentType:"",dateFrom:"",dateTo:"",priceMin:null,priceMax:null}),r=_({sortBy:"",paymentType:"",dateFrom:"",dateTo:"",priceMin:null,priceMax:null}),O=P(()=>T.value.map(a=>{const e=Array.isArray(a.promo)&&a.promo.length>0?a.promo[0]:null;return{orderId:a.id,customer:a.customer_name,user:a.user?.name||"—",type:a.payment_type||"—",serviceCharges:Number(a.service_charges||0),deliveryCharges:Number(a.delivery_charges||0),tax:Number(a.tax||0),amountReceived:Number(a.amount_received||0),promoDiscount:e?Number(e.discount_amount||0):0,salesDiscount:Number(a.sales_discount||0),approvedDiscount:Number(a.approved_discounts||0),grandTotal:Number(a.total_amount||0),promoName:e?e.promo_name:"—",paidAt:a.payment_date||null,status:a.status}})),E=P(()=>O.value),Q=a=>{f.value={...f.value,...a},r.value={...f.value},m.value.current_page=1,N(1),bootstrap.Modal.getInstance(document.getElementById("paymentFilterModal"))?.hide(),console.log("Filters applied:",f.value)},K=()=>{f.value={sortBy:"",paymentType:"",dateFrom:"",dateTo:"",priceMin:null,priceMax:null},r.value={sortBy:"",paymentType:"",dateFrom:"",dateTo:"",priceMin:null,priceMax:null},m.value.current_page=1,m.value.per_page=10,N(1),console.log("Filters cleared")},j=P(()=>({sortOptions:[{value:"date_desc",label:"Date: Newest First"},{value:"date_asc",label:"Date: Oldest First"},{value:"amount_desc",label:"Amount: High to Low"},{value:"amount_asc",label:"Amount: Low to High"},{value:"order_asc",label:"Order ID: Low to High"},{value:"order_desc",label:"Order ID: High to Low"}],paymentTypeOptions:[{value:"Cash",label:"Cash"},{value:"Card",label:"Card"},{value:"Split",label:"Split"},{value:"QR",label:"QR"},{value:"Bank",label:"Bank"}]}));P(()=>O.value.length),P(()=>{const a=new Date,e=new Date(a.getFullYear(),a.getMonth(),a.getDate()),o=new Date(a.getFullYear(),a.getMonth(),a.getDate()+1);return T.value.filter(s=>{if(!s.created_at||!s.payment)return!1;const l=new Date(s.created_at);return l>=e&&l<o}).length}),P(()=>O.value.reduce((a,e)=>a+Number(e.grandTotal||0),0)),U(()=>window.feather?.replace()),se(()=>window.feather?.replace());let L=null;le(w,()=>{clearTimeout(L),L=setTimeout(()=>{m.value.current_page=1,N(1)},500)});const J=async a=>{if(!T.value||T.value.length===0){y.error("No payment data to download");return}try{x.value=!0;const e={q:w.value,sort_by:r.value.sortBy||"",payment_type:r.value.paymentType||"",date_from:r.value.dateFrom||"",date_to:r.value.dateTo||"",price_min:r.value.priceMin||"",price_max:r.value.priceMax||"",export:"all"};Object.keys(e).forEach(l=>{(e[l]===void 0||e[l]==="")&&delete e[l]});const s=(await axios.get("/api/payments/all",{params:e})).data.data.map(l=>{const c=l.order||{};return{id:c.id,customer_name:c.customer_name,promo:c.promo,service_charges:c.service_charges,delivery_charges:c.delivery_charges,tax:c.tax,sub_total:c.sub_total,sales_discount:c.sales_discount,approved_discounts:c.approved_discounts,total_amount:c.total_amount,status:c.status,type:c.type,payment_type:l.payment_type,amount_received:l.amount_received,payment_date:l.payment_date,user:l.user}});if(s.length===0){y.error("No payments found to download");return}a==="pdf"?ee(s):a==="excel"?te(s):a==="csv"?Z(s):y.error("Invalid download type")}catch(e){console.error("Download failed:",e),y.error(`Download failed: ${e.message}`)}finally{x.value=!1}},Z=a=>{try{const e=["Order ID","Date","Customer","Payment Type","Amount Received","Promo Discount","Sales Discount","Approved Discount","Tax","Service Charges","Delivery Charges","Grand Total","Status"],o=a.map(u=>[`"${u.id||""}"`,`"${C(u.payment_date)}"`,`"${u.customer_name||"Walk In"}"`,`"${u.payment_type||"-"}"`,`"${Number(u.amount_received||0).toFixed(2)}"`,`"${Number(u.promo?.[0]?.discount_amount||0).toFixed(2)}"`,`"${Number(u.sales_discount||0).toFixed(2)}"`,`"${Number(u.approved_discounts||0).toFixed(2)}"`,`"${Number(u.tax||0).toFixed(2)}"`,`"${Number(u.service_charges||0).toFixed(2)}"`,`"${Number(u.delivery_charges||0).toFixed(2)}"`,`"${Number(u.total_amount||0).toFixed(2)}"`,`"${u.status||""}"`]),s=[e.join(","),...o.map(u=>u.join(","))].join(`
`),l=new Blob([s],{type:"text/csv;charset=utf-8;"}),c=URL.createObjectURL(l),b=document.createElement("a");b.setAttribute("href",c),b.setAttribute("download",`Payments_${new Date().toISOString().split("T")[0]}.csv`),document.body.appendChild(b),b.click(),document.body.removeChild(b),y.success("Payments CSV downloaded successfully")}catch(e){console.error("CSV generation error:",e),y.error(`CSV generation failed: ${e.message}`)}},ee=a=>{try{const e=new ye("l","mm","a4");e.setFontSize(18),e.setFont("helvetica","bold"),e.text("Payments Report",14,20),e.setFontSize(10),e.setFont("helvetica","normal");const o=new Date().toLocaleString();e.text(`Generated on: ${o}`,14,28),e.text(`Total Payments: ${a.length}`,14,34);const s=a.reduce((d,F)=>d+Number(F.total_amount||0),0),l=a.reduce((d,F)=>d+Number(F.amount_received||0),0);e.text(`Total Revenue: £${s.toFixed(2)}`,14,40),e.text(`Total Received: £${l.toFixed(2)}`,14,46);const c=["Order ID","Date","Customer","Payment Type","Amount Received","Promo Disc.","Sales Disc.","Tax","Grand Total","Status"],b=a.map(d=>[d.id||"",C(d.payment_date),d.customer_name||"Walk In",d.payment_type||"-",`£${Number(d.amount_received||0).toFixed(2)}`,`£${Number(d.promo?.[0]?.discount_amount||0).toFixed(2)}`,`£${Number(d.sales_discount||0).toFixed(2)}`,`£${Number(d.tax||0).toFixed(2)}`,`£${Number(d.total_amount||0).toFixed(2)}`,d.status||""]);_e(e,{head:[c],body:b,startY:52,styles:{fontSize:8,cellPadding:2,halign:"left",lineColor:[0,0,0],lineWidth:.1},headStyles:{fillColor:[41,128,185],textColor:255,fontStyle:"bold"},alternateRowStyles:{fillColor:[245,245,245]},margin:{left:14,right:14},didDrawPage:d=>{const F=e.internal.getNumberOfPages(),V=e.internal.pageSize.height;e.setFontSize(8),e.text(`Page ${d.pageNumber} of ${F}`,d.settings.margin.left,V-10)}});const u=`Payments_${new Date().toISOString().split("T")[0]}.pdf`;e.save(u),y.success("Payments PDF downloaded successfully")}catch(e){console.error("PDF generation error:",e),y.error(`PDF generation failed: ${e.message}`)}},te=a=>{try{if(typeof he>"u")throw new Error("XLSX library is not loaded");const e=a.map(n=>({"Order ID":n.id||"",Date:C(n.payment_date),Customer:n.customer_name||"Walk In","Order Type":n.type||"-","Payment Type":n.payment_type||"-","Amount Received":Number(n.amount_received||0).toFixed(2),"Promo Name":n.promo?.[0]?.promo_name||"-","Promo Discount":Number(n.promo?.[0]?.discount_amount||0).toFixed(2),"Sales Discount":Number(n.sales_discount||0).toFixed(2),"Approved Discount":Number(n.approved_discounts||0).toFixed(2),Tax:Number(n.tax||0).toFixed(2),"Service Charges":Number(n.service_charges||0).toFixed(2),"Delivery Charges":Number(n.delivery_charges||0).toFixed(2),"Grand Total":Number(n.total_amount||0).toFixed(2),Status:n.status||"",User:n.user?.name||"—"})),o=S.book_new(),s=S.json_to_sheet(e);s["!cols"]=[{wch:10},{wch:12},{wch:20},{wch:12},{wch:12},{wch:15},{wch:20},{wch:15},{wch:15},{wch:15},{wch:10},{wch:15},{wch:15},{wch:12},{wch:10},{wch:15}],S.book_append_sheet(o,s,"Payments");const l=a.reduce((n,D)=>n+Number(D.total_amount||0),0),c=a.reduce((n,D)=>n+Number(D.amount_received||0),0),b=a.reduce((n,D)=>n+Number(D.promo?.[0]?.discount_amount||0),0),u=a.reduce((n,D)=>n+Number(D.sales_discount||0),0),d=[{Info:"Generated On",Value:new Date().toLocaleString()},{Info:"Total Payments",Value:a.length},{Info:"Total Revenue",Value:`£${l.toFixed(2)}`},{Info:"Total Amount Received",Value:`£${c.toFixed(2)}`},{Info:"Total Promo Discounts",Value:`£${b.toFixed(2)}`},{Info:"Total Sales Discounts",Value:`£${u.toFixed(2)}`},{Info:"Exported By",Value:"Payment Management System"}],F=S.json_to_sheet(d);S.book_append_sheet(o,F,"Summary");const V=`Payments_${new Date().toISOString().split("T")[0]}.xlsx`;ge(o,V),y.success("Payments Excel file downloaded successfully")}catch(e){console.error("Excel generation error:",e),y.error(`Excel generation failed: ${e.message}`)}};return(a,e)=>(v(),ne(me,null,{default:z(()=>[I(p(re),{title:"Payment"}),t("div",fe,[e[18]||(e[18]=t("h4",{class:"fw-semibold mb-3"},"Overall Payments",-1)),t("div",xe,[t("div",we,[t("div",Fe,[t("div",De,[t("div",null,[t("h3",Te,i($.value.total_payments),1),e[4]||(e[4]=t("p",{class:"text-muted mb-0 small"},"Total Payments",-1))]),e[5]||(e[5]=t("div",{class:"rounded-circle p-3 bg-primary-subtle text-primary d-flex align-items-center justify-content-center",style:{width:"56px",height:"56px"}},[t("i",{class:"bi bi-list-check fs-4"})],-1))])])]),t("div",Pe,[t("div",Ne,[t("div",Se,[t("div",null,[t("h3",Ce,i($.value.todays_payments),1),e[6]||(e[6]=t("p",{class:"text-muted mb-0 small"},"Today's Payments",-1))]),e[7]||(e[7]=t("div",{class:"rounded-circle p-3 bg-success-subtle text-success d-flex align-items-center justify-content-center",style:{width:"56px",height:"56px"}},[t("i",{class:"bi bi-calendar-day fs-4"})],-1))])])]),t("div",$e,[t("div",Ie,[t("div",ke,[t("div",null,[t("h3",Me,i(p(g)($.value.total_amount,"GBP")),1),e[8]||(e[8]=t("p",{class:"text-muted mb-0 small"},"Total Amount",-1))]),e[9]||(e[9]=t("div",{class:"rounded-circle p-3 bg-warning-subtle text-warning d-flex align-items-center justify-content-center",style:{width:"56px",height:"56px"}},[t("i",{class:"bi bi-currency-pound fs-4"})],-1))])])])]),t("div",Oe,[t("div",Ve,[t("div",Ae,[e[14]||(e[14]=t("h5",{class:"mb-0 fw-semibold"},"Payments",-1)),t("div",Re,[t("div",Be,[e[10]||(e[10]=t("i",{class:"bi bi-search"},null,-1)),e[11]||(e[11]=t("input",{type:"email",name:"email",autocomplete:"email",style:{position:"absolute",left:"-9999px",width:"1px",height:"1px"},tabindex:"-1","aria-hidden":"true"},null,-1)),B.value?H((v(),h("input",{id:M,"onUpdate:modelValue":e[0]||(e[0]=o=>w.value=o),key:R.value,class:"form-control search-input",placeholder:"Search by Order ID",type:"search",autocomplete:"new-password",name:M,role:"presentation",onFocus:e[1]||(e[1]=(...o)=>a.handleFocus&&a.handleFocus(...o))},null,32)),[[ie,w.value]]):(v(),h("input",Ee))]),I(ve,{modelValue:f.value,"onUpdate:modelValue":e[2]||(e[2]=o=>f.value=o),title:"Payments","modal-id":"paymentFilterModal","modal-size":"modal-lg","sort-options":j.value.sortOptions,"show-price-range":!0,"show-date-range":!0,"show-stock-status":!1,"price-label":"Amount Range",onApply:Q,onClear:K},{customFilters:z(({filters:o})=>[t("div",je,[e[13]||(e[13]=t("label",{class:"form-label fw-semibold text-dark"},[t("i",{class:"fas fa-credit-card me-2 text-muted"}),ue("Payment Type ")],-1)),H(t("select",{"onUpdate:modelValue":s=>o.paymentType=s,class:"form-select"},[e[12]||(e[12]=t("option",{value:""},"All",-1)),(v(!0),h(A,null,W(j.value.paymentTypeOptions,s=>(v(),h("option",{key:s.value,value:s.value},i(s.label),9,Ue))),128))],8,Le),[[de,o.paymentType]])])]),_:1},8,["modelValue","sort-options"]),I(p(be),{modelValue:k.value,"onUpdate:modelValue":e[3]||(e[3]=o=>k.value=o),options:X,optionLabel:"label",optionValue:"value",placeholder:"Export",class:"export-dropdown",onChange:q},null,8,["modelValue"])])]),t("div",ze,[t("table",Ge,[e[17]||(e[17]=t("thead",{class:"border-top small text-muted"},[t("tr",null,[t("th",null,"S. #"),t("th",null,"Order ID"),t("th",null,"Actual Payment"),t("th",null,"Promo Name"),t("th",null,"Promo Discount"),t("th",null,"Sales Discount"),t("th",null,"Approved Discount"),t("th",null,"Tax"),t("th",null,"Service Charges"),t("th",null,"Delivery Charges"),t("th",null,"Grand Total"),t("th",null,"Payment Date"),t("th",null,"Payment Type")])],-1)),t("tbody",null,[x.value?(v(),h("tr",He,[...e[15]||(e[15]=[t("td",{colspan:"11",class:"text-center py-5"},[t("div",{class:"d-flex flex-column align-items-center justify-content-center"},[t("div",{class:"spinner-border mb-3",role:"status",style:{color:"#1B1670",width:"3rem",height:"3rem","border-width":"0.3em"}},[t("span",{class:"visually-hidden"},"Loading...")]),t("div",{class:"fw-semibold text-muted"},"Loading Payments...")])],-1)])])):(v(),h(A,{key:1},[(v(!0),h(A,null,W(E.value,(o,s)=>(v(),h("tr",{key:o.orderId},[t("td",null,i((m.value.current_page-1)*m.value.per_page+s+1),1),t("td",null,i(o.orderId),1),t("td",null,i(p(g)(o.amountReceived)),1),t("td",null,i(o.promoName),1),t("td",We,i(o.promoDiscount?p(g)(o.promoDiscount):"—"),1),t("td",Xe,i(o.salesDiscount?p(g)(o.salesDiscount):"—"),1),t("td",qe,i(o.approvedDiscount?p(g)(o.approvedDiscount):"—"),1),t("td",null,i(p(g)(o.tax)),1),t("td",null,i(p(g)(o.serviceCharges)),1),t("td",null,i(p(g)(o.deliveryCharges)),1),t("td",null,i(p(g)(o.grandTotal)),1),t("td",null,i(p(C)(o.paidAt)),1),t("td",Ye,i(o.type),1)]))),128)),!x.value&&E.value.length===0?(v(),h("tr",Qe,[...e[16]||(e[16]=[t("td",{colspan:"13",class:"text-center text-muted py-4"}," No payments found. ",-1)])])):G("",!0)],64))])])]),!x.value&&m.value.last_page>1?(v(),h("div",Ke,[t("div",Je," Showing "+i(m.value.from)+" to "+i(m.value.to)+" of "+i(m.value.total)+" items ",1),I(ce,{pagination:m.value.links,isApiDriven:!0,onPageChanged:Y},null,8,["pagination"])])):G("",!0)])])])]),_:1}))}},_t=ae(Ze,[["__scopeId","data-v-44b30167"]]);export{_t as default};

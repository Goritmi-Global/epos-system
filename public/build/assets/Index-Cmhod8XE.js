import{_ as X,r as u,c as K,o as G,z as Q,g as n,b as i,e as Y,f as e,u as Z,h as ee,j as L,t as o,l as c,F as b,i as h,K as P,p as g}from"./app-CYYlfszq.js";const te={class:"page-wrapper"},se={class:"container-fluid px-4"},le={class:"d-flex justify-content-between align-items-center py-2"},ae={class:"d-flex align-items-center gap-2"},oe={class:"small fw-semibold"},ne={class:"d-flex align-items-center gap-3"},ie={class:"small fw-bold"},re={class:"small"},ce={class:"container-fluid px-3 py-3"},de={class:"row gx-3"},ue={class:"col-lg-8"},ve={class:"products-scroll"},me={key:0,class:"alert alert-light text-center",style:{"align-items":"center",display:"flex","flex-direction":"column","justify-content":"center",height:"520px"}},_e={class:"category-header"},ge={class:"category-title"},pe={class:"category-count"},be={class:"row g-3"},fe={class:"product-image"},he=["src","alt"],ye={class:"product-info"},Ce={key:0,class:"product-meta"},ke={class:"text-muted"},xe={key:1,class:"product-addons"},we={class:"col-lg-4"},Te={class:"cart-sticky"},Ie={class:"cart"},Se={class:"cart-header"},Ee={class:"order-type"},Ne={class:"ot-pill active"},Pe={class:"cart-body"},Fe={class:"mb-3"},Ve={key:0,class:"row g-2"},De={class:"col-6"},Oe={class:"form-control form-control-sm bg-light"},Ae={class:"col-6"},Je={class:"form-control form-control-sm bg-light"},je={key:1},Re={class:"form-control form-control-sm bg-light"},qe={class:"cart-lines"},Le={key:0,class:"empty"},Ue=["src"],$e={class:"cart-item-details"},He={class:"cart-item-name"},Me={class:"cart-item-meta"},ze={key:0,class:"sale-badge"},Be={key:1,class:"variant-badge"},We={key:2,class:"addon-count"},Xe={key:3,class:"promo-badge"},Ke={class:"cart-item-qty"},Ge={class:"cart-item-price"},Qe={class:"cart-totals"},Ye={class:"total-row"},Ze={key:0,class:"total-row"},et={class:"text-info"},tt={key:1,class:"total-row"},st={key:2,class:"total-row"},lt={key:3,class:"total-row text-danger"},at={key:4,class:"total-row text-success"},ot={class:"total-row total-final"},nt={key:0,class:"cart-note"},it={class:"note-content"},rt={class:"cart-footer"},ct=3e3,dt=5e3,ut={__name:"Index",props:{terminalId:{type:String,required:!0}},setup(F){const V=F,r=u({items:[],customer:"Walk In",orderType:"Dine In",table:null,subtotal:0,tax:0,serviceCharges:0,deliveryCharges:0,saleDiscount:0,promoDiscount:0,total:0,note:"",appliedPromos:[]}),U=u([]),D=u([]),O=u({}),y=u({}),w=u(new Date().toLocaleTimeString()),_=u("Connecting..."),$=u(null),T=u(0),f=u(!1),m=u(0),I=u(!0);let C=null,S=null;const H=()=>m.value===0?200:m.value===1?500:m.value===2?1e3:2e3,M=async()=>{if(!(f.value||!I.value))try{const s=new AbortController,t=setTimeout(()=>s.abort(),ct),a=await fetch(`/api/pos/terminal/${V.terminalId}/version`,{signal:s.signal,headers:{"X-Requested-With":"XMLHttpRequest",Accept:"application/json"},cache:"no-store"});if(clearTimeout(t),!a.ok)throw new Error(`HTTP ${a.status}`);const l=await a.json();l.version!==T.value&&(console.log(`ðŸ”„ Version: ${T.value} â†’ ${l.version}`),await k()),_.value="Connected",m.value=0}catch(s){m.value++,s.name==="AbortError"?console.warn("âš ï¸ Version check timeout"):console.error("âŒ Version check failed:",s.message),_.value="Connection Error",m.value>=3&&!f.value&&(console.log("ðŸ”„ Fallback: Fetching state"),await k()),E()}},k=async()=>{if(f.value){console.log("â³ Already fetching...");return}f.value=!0,console.log("ðŸ“¡ Fetching terminal state...");try{const s=new AbortController,t=setTimeout(()=>s.abort(),dt),a=await fetch(`/api/pos/terminal/${V.terminalId}/state`,{signal:s.signal,headers:{"X-Requested-With":"XMLHttpRequest",Accept:"application/json"},cache:"no-store"});if(clearTimeout(t),!a.ok)throw new Error(`HTTP ${a.status}`);const l=await a.json();if(console.log("ðŸ“¦ Received:",{version:l.version,cartItems:l.cart?.items?.length||0,categories:l.ui?.menuCategories?.length||0,items:l.ui?.menuItems?.length||0}),l.success){if(l.cart&&(r.value=JSON.parse(JSON.stringify(l.cart)),console.log("âœ… Cart updated:",r.value.items.length,"items")),l.ui){const d=l.ui;U.value=JSON.parse(JSON.stringify(d.menuCategories||[])),D.value=JSON.parse(JSON.stringify(d.menuItems||[])),O.value=JSON.parse(JSON.stringify(d.selectedCardVariant||{})),y.value=JSON.parse(JSON.stringify(d.selectedCardAddons||{}))}$.value=l.timestamp,T.value=l.version,_.value="Connected",m.value=0,console.log("âœ… State updated - v"+l.version)}}catch(s){m.value++,s.name==="AbortError"?console.warn("âš ï¸ State fetch timeout"):console.error("âŒ Failed to fetch state:",s.message),_.value="Connection Error",E()}finally{f.value=!1}},E=()=>{N(),A()},A=()=>{k();const s=H();C=setInterval(()=>{M()},s)},N=()=>{C&&(clearInterval(C),C=null)},J=()=>{I.value=!document.hidden,I.value?(m.value=0,k(),E()):N()},v=s=>`Â£${(parseFloat(s)||0).toFixed(2)}`,j=K(()=>{const s={};return D.value.forEach(t=>{const a=t.category?.id||"uncategorized",l=t.category?.name||"Uncategorized";s[a]||(s[a]={id:a,name:l,products:[]}),s[a].products.push({id:t.id,title:t.name,img:t.image_url||"/assets/img/default.png",price:Number(t.price),label_color:t.label_color||"#1B1670",description:t.description,variants:t.variants??[],addon_groups:t.addon_groups??[]})}),Object.values(s)}),R=s=>{if(!s.variants||s.variants.length===0)return null;const t=O.value[s.id];return s.variants.find(a=>a.id===t)||s.variants[0]},z=(s,t=!1)=>{if(!s)return 0;const a=s.is_saleable??s?.menu_item?.is_saleable,l=s.resale_type??s?.menu_item?.resale_type,d=s.resale_value??s?.menu_item?.resale_value,p=parseFloat(s.price||0);return!a||!l||!d?0:l==="flat"?parseFloat(d):l==="percentage"?p*parseFloat(d)/100:0},q=(s,t=!1)=>{const a=parseFloat(s.price||0),l=z(s,t);return Math.max(0,a-l)},B=s=>{const t=R(s);let a=t?q(t,!0):q(s,!1);const l=y.value[s.id]||{};let d=0;return Object.values(l).forEach(p=>{Array.isArray(p)&&p.forEach(x=>{d+=Number(x.price||0)})}),a+d},W=s=>!r.value.appliedPromos||r.value.appliedPromos.length===0?!1:r.value.appliedPromos.some(t=>!t.applied_to_items||t.applied_to_items.length===0?!0:t.applied_to_items.includes(s.id));return G(()=>{S=setInterval(()=>{w.value=new Date().toLocaleTimeString()},1e3),document.addEventListener("visibilitychange",J),A()}),Q(()=>{N(),S&&clearInterval(S),document.removeEventListener("visibilitychange",J)}),(s,t)=>(i(),n(b,null,[Y(Z(ee),{title:"Customer Display"}),e("div",te,[e("div",{class:L(["connection-bar",_.value==="Connected"?"connected":"disconnected"])},[e("div",se,[e("div",le,[e("div",ae,[e("span",{class:L(["status-dot",_.value==="Connected"?"active":""])},null,2),e("span",oe,o(_.value),1)]),e("div",ne,[e("span",ie,o(w.value),1),e("span",re,"Terminal: "+o(F.terminalId),1)])])])],2),e("div",ce,[e("div",de,[e("div",ue,[e("div",ve,[j.value.length===0?(i(),n("div",me,[...t[0]||(t[0]=[e("i",{class:"bi bi-basket fs-1 text-muted d-block mb-2"},null,-1),e("p",{class:"mb-0 text-muted"},"No menu items available",-1)])])):c("",!0),(i(!0),n(b,null,h(j.value,a=>(i(),n("div",{key:a.id,class:"category-section mb-4"},[e("div",_e,[e("h4",ge,o(a.name),1),e("div",pe,o(a.products.length)+" items",1)]),e("div",be,[(i(!0),n(b,null,h(a.products,l=>(i(),n("div",{class:"col-12 col-md-6 col-xl-2",key:l.id},[e("div",{class:"product-card",style:P({borderColor:l.label_color})},[e("div",fe,[e("img",{src:l.img,alt:l.title},null,8,he),e("span",{class:"product-price",style:P({background:l.label_color})},o(v(B(l))),5)]),e("div",ye,[e("h6",{class:"product-title",style:P({color:l.label_color})},o(l.title),5),l.variants&&l.variants.length>0?(i(),n("div",Ce,[e("small",ke,[t[1]||(t[1]=e("i",{class:"bi bi-layers"},null,-1)),g(" "+o(R(l)?.name||l.variants[0].name),1)])])):c("",!0),y.value[l.id]?(i(),n("div",xe,[(i(!0),n(b,null,h(y.value[l.id],(d,p)=>(i(),n("div",{key:p},[(i(!0),n(b,null,h(d,x=>(i(),n("span",{key:x.id,class:"addon-badge"}," +"+o(x.name),1))),128))]))),128))])):c("",!0)])],4)]))),128))])]))),128))])]),e("div",we,[e("div",Te,[e("div",Ie,[e("div",Se,[e("div",Ee,[e("div",Ne,o(r.value.orderType),1)])]),e("div",Pe,[e("div",Fe,[r.value.orderType==="Dine In"?(i(),n("div",Ve,[e("div",De,[t[2]||(t[2]=e("label",{class:"form-label small"},"Table",-1)),e("div",Oe,o(r.value.table?.name||"Select Table"),1)]),e("div",Ae,[t[3]||(t[3]=e("label",{class:"form-label small"},"Customer",-1)),e("div",Je,o(r.value.customer),1)])])):(i(),n("div",je,[t[4]||(t[4]=e("label",{class:"form-label small"},"Customer",-1)),e("div",Re,o(r.value.customer),1)]))]),e("div",qe,[r.value.items.length===0?(i(),n("div",Le,[...t[5]||(t[5]=[e("i",{class:"bi bi-cart-x fs-2 text-muted"},null,-1),e("p",{class:"mb-0 mt-2 small text-muted"},"Cart is empty",-1)])])):c("",!0),(i(!0),n(b,null,h(r.value.items,(a,l)=>(i(),n("div",{key:l,class:"cart-item"},[e("img",{src:a.img||"/assets/img/default.png",class:"cart-item-img"},null,8,Ue),e("div",$e,[e("div",He,o(a.title),1),e("div",Me,[a.resale_discount_per_item>0?(i(),n("span",ze,[t[6]||(t[6]=e("i",{class:"bi bi-star-fill"},null,-1)),g(" -"+o(v(a.resale_discount_per_item)),1)])):c("",!0),a.variant_name?(i(),n("span",Be,o(a.variant_name),1)):c("",!0),a.addons&&a.addons.length>0?(i(),n("span",We,[t[7]||(t[7]=e("i",{class:"bi bi-plus-circle"},null,-1)),g(" "+o(a.addons.length),1)])):c("",!0),W(a)?(i(),n("span",Xe,[...t[8]||(t[8]=[e("i",{class:"bi bi-tag-fill"},null,-1)])])):c("",!0)])]),e("div",Ke,"Ã—"+o(a.qty),1),e("div",Ge,o(v(a.price)),1)]))),128))]),e("div",Qe,[e("div",Ye,[t[9]||(t[9]=e("span",null,"Subtotal",-1)),e("b",null,o(v(r.value.subtotal)),1)]),r.value.tax>0?(i(),n("div",Ze,[t[10]||(t[10]=e("span",null,[e("i",{class:"bi bi-receipt text-info"}),g(" Tax")],-1)),e("b",et,o(v(r.value.tax)),1)])):c("",!0),r.value.serviceCharges>0?(i(),n("div",tt,[t[11]||(t[11]=e("span",null,"Service",-1)),e("b",null,o(v(r.value.serviceCharges)),1)])):c("",!0),r.value.deliveryCharges>0?(i(),n("div",st,[t[12]||(t[12]=e("span",null,"Delivery",-1)),e("b",null,o(v(r.value.deliveryCharges)),1)])):c("",!0),r.value.saleDiscount>0?(i(),n("div",lt,[t[13]||(t[13]=e("span",null,[e("i",{class:"bi bi-tag"}),g(" Sale Discount")],-1)),e("b",null,"-"+o(v(r.value.saleDiscount)),1)])):c("",!0),r.value.promoDiscount>0?(i(),n("div",at,[t[14]||(t[14]=e("span",null,[e("i",{class:"bi bi-gift"}),g(" Promo Savings")],-1)),e("b",null,"-"+o(v(r.value.promoDiscount)),1)])):c("",!0),e("div",ot,[t[15]||(t[15]=e("span",null,"Total",-1)),e("b",null,o(v(r.value.total)),1)])]),r.value.note?(i(),n("div",nt,[t[16]||(t[16]=e("label",{class:"small fw-semibold mb-1"},"Note",-1)),e("div",it,o(r.value.note),1)])):c("",!0)]),e("div",rt,[t[17]||(t[17]=e("i",{class:"bi bi-clock"},null,-1)),g(" "+o(w.value),1)])])])])])])])],64))}},mt=X(ut,[["__scopeId","data-v-d5cc8f8e"]]);export{mt as default};

import{_ as J,r as u,c as Q,o as Z,y as O,f,b as v,d as A,e as t,u as L,h as ee,m as $,k as B,v as q,l as j,F as k,g as te,t as h,C as oe,T as le,U as ae,i as se,p as S,n as re,q as s}from"./app-DMljjlQ-.js";import{E as ne,a as ie,X as de,u as E,w as ce}from"./xlsx-BJl_Jx6P.js";import{I as ue}from"./importFile-BV4kIh6x.js";import{P as me}from"./plus-CrdE_B5a.js";import{P as pe}from"./pencil--cpy_PIX.js";import"./createLucideIcon-6-5ktcZ2.js";const ge={class:"card border-0 shadow-lg rounded-4"},fe={class:"card-body"},ve={class:"d-flex flex-wrap gap-2 justify-content-between align-items-center mb-3"},ye={class:"d-flex gap-2"},he={class:"search-wrap"},be={class:"dropdown"},we={class:"dropdown-menu dropdown-menu-end shadow rounded-4 py-2"},_e={class:"table-responsive"},xe={class:"table table-hover"},Ae={key:0},Ce={class:"fw-semibold"},ke={class:"text-center"},Se={class:"d-inline-flex align-items-center gap-3"},Ee=["onClick"],De={key:0},Te={colspan:"3",class:"text-center text-muted py-4"},Fe={key:0,class:"mt-4 d-flex justify-content-between align-items-center"},Ne={class:"text-muted small"},Pe={class:"modal fade",id:"modalAllergyForm",tabindex:"-1","aria-hidden":"true"},Ie={class:"modal-dialog modal-lg modal-dialog-centered"},Le={class:"modal-content rounded-4"},$e={class:"modal-header"},je={class:"modal-title"},Ve={class:"modal-body"},Me={key:0,class:"text-danger"},Re={class:"col-md-2"},Oe=["disabled"],Be={__name:"AllergiesTab",setup(qe){const y=u(""),C=u(!1),T=u(null),w=u(""),F=()=>{y.value="",i.value={}},N=Q(()=>{const o=w.value.trim().toLowerCase();return o?n.value.filter(e=>e.name.toLowerCase().includes(o)):n.value}),U=()=>{C.value=!1,y.value=""},z=o=>{C.value=!0,T.value=o,y.value=o.name},X=async o=>{try{await S.delete(`/allergies/${o.id}`),n.value=n.value.filter(e=>e.id!==o.id),s.success("Allergy deleted successfully"),await x()}catch(e){s.error("Delete failed"),console.error(e)}},_=u(!1),V=async()=>{if(!_.value){if(!y.value.trim()){s.error("Please enter an allergy name"),i.value={customAllergy:["Please enter an allergy name"]};return}if(C.value)try{_.value=!0;const{data:o}=await S.put(`/allergies/${T.value.id}`,{name:y.value.trim()}),e=n.value.findIndex(l=>l.id===T.value.id);e!==-1&&(n.value[e]=o),s.success("Allergy updated successfully"),await x(),F(),M("modalAllergyForm")}catch(o){o.response?.data?.errors?(i.value={},Object.entries(o.response.data.errors).forEach(([e,l])=>{l.forEach(r=>s.error(r)),i.value={customAllergy:l}})):s.error("Update failed")}finally{_.value=!1}else{const o=y.value.trim();if(n.value.some(l=>l.name.toLowerCase()===o.toLowerCase())){s.error(`Allergy "${o}" already exists`),i.value={customAllergy:["This allergy already exists"]};return}try{_.value=!0;const l=await S.post("/allergies",{allergies:[{name:o}]}),r=l.data?.allergies??l.data;Array.isArray(r)&&r.length&&(n.value=[...n.value,...r]),s.success("Allergy added successfully"),F(),M("modalAllergyForm"),await x()}catch(l){l.response?.data?.errors?Object.values(l.response.data.errors).forEach(r=>r.forEach(p=>s.error(p))):(console.error(l),s.error("Create failed"))}finally{_.value=!1}}}},M=o=>{const e=document.getElementById(o);if(!e)return;(window.bootstrap?.Modal.getInstance(e)||new window.bootstrap.Modal(e)).hide()},n=u([]),m=u({current_page:1,last_page:1,per_page:15,total:0,from:0,to:0,links:[]});u(1),u(15);const D=u(!1),i=u({}),x=async(o=null)=>{D.value=!0;try{const{data:e}=await S.get("/allergies",{params:{q:w.value,page:o||m.value.current_page,per_page:m.value.per_page}});n.value=e.data||[],m.value={current_page:e.current_page,last_page:e.last_page,per_page:e.per_page,total:e.total,from:e.from,to:e.to,links:e.links},await re(),window.feather?.replace()}catch(e){console.error("Failed to fetch allergies",e),s.error("Failed to load allergies")}finally{D.value=!1}},G=o=>{if(!o)return;const l=new URLSearchParams(o.split("?")[1]).get("page");l&&x(parseInt(l))},P=o=>{if(!n.value||n.value.length===0){s.error("No Allergies data to download");return}const e=w.value.trim()?N.value:n.value;if(e.length===0){s.error("No Allergies found to download");return}try{o==="pdf"?K(e):o==="excel"?W(e):o==="csv"?H(e):s.error("Invalid download type")}catch(l){console.error("Download failed:",l),s.error(`Download failed: ${l.message}`)}},H=o=>{try{const e=["Name"],l=o.map(g=>[`"${g.name||""}"`]),r=[e.join(","),...l.map(g=>g.join(","))].join(`
`),p=new Blob([r],{type:"text/csv;charset=utf-8;"}),b=URL.createObjectURL(p),d=document.createElement("a");d.setAttribute("href",b),d.setAttribute("download",`allergies_${new Date().toISOString().split("T")[0]}.csv`),document.body.appendChild(d),d.click(),document.body.removeChild(d),s.success("CSV downloaded successfully",{autoClose:2500})}catch(e){console.error("CSV generation error:",e),s.error(`CSV generation failed: ${e.message}`,{autoClose:5e3})}},K=o=>{try{const e=new ne("p","mm","a4");e.setFont("helvetica","bold"),e.setFontSize(18),e.text("Allergies Report",70,20),e.setFont("helvetica","normal"),e.setFontSize(10);const l=new Date().toLocaleString();e.text(`Generated on: ${l}`,14,30),e.text(`Total Allergies: ${o.length}`,14,36);const r=["Name"],p=o.map(d=>[d.name||""]);ie(e,{head:[r],body:p,startY:45,styles:{fontSize:10,cellPadding:3,halign:"left",valign:"middle",lineColor:[220,220,220],lineWidth:.1},headStyles:{fillColor:[41,128,185],textColor:255,fontStyle:"bold"},alternateRowStyles:{fillColor:[245,245,245]},margin:{left:14,right:14},didDrawPage:d=>{const g=e.internal.getNumberOfPages(),a=e.internal.pageSize.height;e.setFontSize(8),e.text(`Page ${d.pageNumber} of ${g}`,14,a-10)}});const b=`allergies_${new Date().toISOString().split("T")[0]}.pdf`;e.save(b),s.success("PDF downloaded successfully",{autoClose:2500})}catch(e){console.error("PDF generation error:",e),s.error(`PDF generation failed: ${e.message}`,{autoClose:5e3})}},W=o=>{try{if(typeof de>"u")throw new Error("XLSX library is not loaded");const e=o.map(g=>({Name:g.name||""})),l=E.book_new(),r=E.json_to_sheet(e);r["!cols"]=[{wch:25}],E.book_append_sheet(l,r,"Allergies");const p=[{Info:"Generated On",Value:new Date().toLocaleString()},{Info:"Total Records",Value:o.length},{Info:"Exported By",Value:"Allergies Management System"}],b=E.json_to_sheet(p);E.book_append_sheet(l,b,"Report Info");const d=`allergies_${new Date().toISOString().split("T")[0]}.xlsx`;ce(l,d),s.success("Excel file downloaded successfully",{autoClose:2500})}catch(e){console.error("Excel generation error:",e),s.error(`Excel generation failed: ${e.message}`,{autoClose:5e3})}};Z(async()=>{await x(),window.feather?.replace()}),O(y,o=>{o&&i.value.customAllergy&&delete i.value.customAllergy});let R=null;O(w,()=>{clearTimeout(R),R=setTimeout(()=>{m.value.current_page=1,x(1)},500)});const Y=o=>{if(!Array.isArray(o)||o.length===0){s.error("File is empty.");return}o[0];const l=o.slice(1).filter(a=>Array.isArray(a)&&a.some(c=>String(c??"").trim()!==""));if(l.length===0){s.error("No data rows found the file is empty or contains only headers.");return}const r=l.map(a=>({name:String(a[0]??"").trim()})).filter(a=>a.name!=="");if(r.length===0){s.error("No valid allergy names found in the file.");return}const p=r.map(a=>a.name.toLowerCase()),b=p.filter((a,c)=>p.indexOf(a)!==c);if(b.length){const a=[...new Set(b)];s.error(`Duplicate entries found in file: ${a.join(", ")}`);return}const d=n.value.map(a=>a.name.toLowerCase()),g=r.filter(a=>d.includes(a.name.toLowerCase()));if(g.length>0){const a=g.map(c=>c.name).join(", ");s.error(`These allergies already exist in the database: ${a}`);return}S.post("/api/allergies/import",{allergies:r}).then(()=>{s.success("Allergies imported successfully");const a=document.querySelector(".modal.show");if(a){const c=bootstrap.Modal.getInstance(a);c&&c.hide()}setTimeout(()=>{document.querySelectorAll(".modal-backdrop").forEach(I=>I.remove()),document.body.classList.remove("modal-open"),document.body.style.overflow="",document.body.style.paddingRight=""},100),x()}).catch(a=>{if(a?.response?.status===422&&a.response.data?.errors){i.value=a.response.data.errors;const c=a.response.data.message||"There may be duplication or validation errors in the data.";s.error(c,{autoClose:3e3})}else s.error("Import failed. Please try again.",{autoClose:3e3}),console.error(a);setTimeout(()=>{document.querySelectorAll(".modal-backdrop").forEach(I=>I.remove()),document.body.classList.remove("modal-open"),document.body.style.overflow="",document.body.style.paddingRight=""},100)})};return(o,e)=>(v(),f(k,null,[A(L(ee),{title:"Allergy"}),t("div",ge,[t("div",fe,[t("div",ve,[e[9]||(e[9]=t("h4",{class:"mb-0"},"Allergies",-1)),t("div",ye,[t("div",he,[e[6]||(e[6]=t("i",{class:"bi bi-search"},null,-1)),B(t("input",{"onUpdate:modelValue":e[0]||(e[0]=l=>w.value=l),class:"form-control search-input",placeholder:"Search"},null,512),[[q,w.value]])]),t("button",{"data-bs-toggle":"modal","data-bs-target":"#modalAllergyForm",onClick:e[1]||(e[1]=()=>{U(),F(),i.value={}}),class:"d-flex align-items-center gap-1 btn-sm px-4 py-2 rounded-pill btn btn-primary text-white"},[A(L(me),{class:"w-4 h-4"}),e[7]||(e[7]=j(" Add Allergy ",-1))]),A(ue,{label:"Import",sampleHeaders:["Name"],sampleData:[["Milk"],["Peanuts"],["Gluten"]],onOnImport:Y}),t("div",be,[e[8]||(e[8]=t("button",{class:"btn btn-outline-secondary btn-sm rounded-pill py-2 px-4 dropdown-toggle","data-bs-toggle":"dropdown"}," Export ",-1)),t("ul",we,[t("li",null,[t("a",{class:"dropdown-item py-2",href:"javascript:;",onClick:e[2]||(e[2]=l=>P("pdf"))},"Export as PDF")]),t("li",null,[t("a",{class:"dropdown-item py-2",href:"javascript:;",onClick:e[3]||(e[3]=l=>P("excel"))},"Export as Excel")]),t("li",null,[t("a",{class:"dropdown-item py-2",href:"javascript:;",onClick:e[4]||(e[4]=l=>P("csv"))},"Export as CSV")])])])])]),t("div",_e,[t("table",xe,[e[11]||(e[11]=t("thead",{class:"border-top small text-muted"},[t("tr",null,[t("th",null,"S. #"),t("th",null,"Allergy Name"),t("th",{class:"text-center"},"Action")])],-1)),t("tbody",null,[D.value?(v(),f("tr",Ae,[...e[10]||(e[10]=[t("td",{colspan:"3",class:"text-center py-5"},[t("div",{class:"spinner-border text-primary",role:"status"},[t("span",{class:"visually-hidden"},"Loading...")]),t("p",{class:"text-muted mt-2 mb-0"},"Loading allergies...")],-1)])])):(v(),f(k,{key:1},[(v(!0),f(k,null,te(N.value,(l,r)=>(v(),f("tr",{key:l.id},[t("td",null,h(m.value.from+r),1),t("td",Ce,h(l.name),1),t("td",ke,[t("div",Se,[t("button",{"data-bs-toggle":"modal","data-bs-target":"#modalAllergyForm",onClick:()=>{z(l),i.value={}},title:"Edit",class:"p-2 rounded-full text-blue-600 hover:bg-blue-100"},[A(L(pe),{class:"w-4 h-4"})],8,Ee),A(oe,{title:"Confirm Delete",message:`Are you sure you want to delete ${l.name}?`,showDeleteButton:!0,onConfirm:()=>{X(l)},onCancel:()=>{}},null,8,["message","onConfirm"])])])]))),128)),N.value.length===0?(v(),f("tr",De,[t("td",Te,h(w.value.trim()?"No allergies found matching your search.":"No allergies found."),1)])):$("",!0)],64))])])]),!D.value&&m.value.last_page>1?(v(),f("div",Fe,[t("div",Ne," Showing "+h(m.value.from)+" to "+h(m.value.to)+" of "+h(m.value.total)+" entries ",1),A(le,{pagination:m.value.links,isApiDriven:!0,onPageChanged:G},null,8,["pagination"])])):$("",!0)])]),t("div",Pe,[t("div",Ie,[t("div",Le,[t("div",$e,[t("h5",je,h(C.value?"Edit Allergy":"Add Allergy(s)"),1),e[12]||(e[12]=t("button",{class:"absolute top-2 right-2 p-2 rounded-full hover:bg-gray-100 transition transform hover:scale-110","data-bs-dismiss":"modal","aria-label":"Close",title:"Close"},[t("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-6 w-6 text-red-500",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor","stroke-width":"2"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M6 18L18 6M6 6l12 12"})])],-1))]),t("div",Ve,[t("div",null,[e[13]||(e[13]=t("label",{class:"form-label"},"Allergy Name",-1)),B(t("input",{"onUpdate:modelValue":e[5]||(e[5]=l=>y.value=l),class:se(["form-control",{"is-invalid":i.value.customAllergy}]),placeholder:"e.g., Vegan",onKeyup:ae(V,["enter"])},null,34),[[q,y.value]]),i.value.customAllergy?(v(),f("span",Me,h(i.value.customAllergy[0]),1)):$("",!0)]),t("div",Re,[t("button",{class:"btn btn-primary rounded-pill py-2 btn-sm w-100 mt-4",disabled:_.value,onClick:V},[_.value?(v(),f(k,{key:0},[e[14]||(e[14]=t("span",{class:"spinner-border spinner-border-sm me-2"},null,-1)),e[15]||(e[15]=j(" Saving... ",-1))],64)):(v(),f(k,{key:1},[j(h((C.value,"Save")),1)],64))],8,Oe)])])])])])],64))}},We=J(Be,[["__scopeId","data-v-b14b2767"]]);export{We as default};

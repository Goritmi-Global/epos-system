import{_ as Z,r as v,c as j,E as R,f as o,b as r,e as t,d as A,m as _,i as k,u as f,t as d,k as w,v as V,F as E,g as I,T as G,q as p}from"./app-DMtB1k9Z.js";import{s as J}from"./index-6n_iKpwB.js";import{u as K}from"./useFormatters-BAefhHg6.js";import"./index-Ds9HV7qR.js";import"./index-Bep5Ew2j.js";import"./index-CptKtDcN.js";import"./index-D3qxtxH9.js";const W={class:"modal fade",id:"addPurchaseModal",tabindex:"-1","aria-hidden":"true"},X={class:"modal-dialog modal-xl modal-dialog-centered"},Y={class:"modal-content rounded-4"},ee={class:"modal-body"},te={class:"row g-3 align-items-center"},se={class:"col-md-5"},le={key:0,class:"text-danger"},ne={class:"row g-4 mt-1"},ae={class:"col-lg-5"},de={class:"search-wrap mb-2"},oe={class:"purchase-scroll"},re={class:"card-body"},ie={class:"d-flex align-items-start gap-3"},ue=["src"],ce={class:"flex-grow-1"},ve={class:"fw-semibold"},_e={class:"text-muted small"},pe={class:"text-muted small"},me={class:"text-muted small"},fe=["onClick"],ye={key:0,class:"col-12 mt-3"},he={class:"badge",style:{display:"inline-block","background-color":"#e6f7f1",color:"#155724",padding:"4px 18px","border-radius":"20px","font-size":"0.9rem","font-weight":"500","box-shadow":"0 2px 6px rgba(0,0,0,0.08)"}},be={class:"row g-2 mt-3"},xe={class:"col-3"},ge=["onUpdate:modelValue"],ke={key:0,class:"text-danger"},we={class:"col-3"},Pe=["onUpdate:modelValue","onChange","onFocus"],Ue={value:null},qe=["value"],Ce={key:0,class:"text-danger"},Ve={class:"col-3"},Ee=["onUpdate:modelValue"],Ie={key:0,class:"text-danger"},De={class:"col-3"},Ne={key:0,class:"text-danger"},Se={class:"col-lg-7"},Me={class:"cart card border rounded-4"},Be={class:"table-responsive"},je={class:"table align-middle mb-0"},Ae={class:"text-end"},Fe=["onClick"],Le={key:0},Te={class:"text-end p-3 fw-semibold"},Qe={class:"mt-4 text-center"},$e=["disabled"],ze={key:0},He={key:1},Oe={__name:"PurchaseComponent",props:{suppliers:{type:Array,required:!0},items:{type:Array,required:!0}},emits:["refresh-data"],setup(D,{emit:F}){const{formatCurrencySymbol:P,dateFmt:N}=K(),U=D,L=F,u=v([]),q=v(""),C=v({});v(!1);const T=j(()=>g(u.value.reduce((e,s)=>e+Number(s.cost||0),0)));console.log(U.items);const S=j(()=>{const e=q.value.trim().toLowerCase();return e?U.items.filter(s=>[s.name,s.category?.name??"",s.unit_name??"",String(s.stock??"")].join(" ").toLowerCase().includes(e)):U.items}),b=(e,s,i)=>{n.value[e.id]||(n.value[e.id]={}),n.value[e.id][s]=[i]},M=(e,s=null)=>{n.value&&(!e||!e.id||(s?n.value[e.id]&&(delete n.value[e.id][s],Object.keys(n.value[e.id]).length===0&&delete n.value[e.id]):delete n.value[e.id]))};async function B(e){try{const s=e.unit_id??e.unitId??null;if(!s){e.derived_units=[];return}if(C.value[s]){e.derived_units=C.value[s];return}const i=await axios.get("/units",{params:{per_page:200}}),a=(i.data?.data??i.data??[]).filter(c=>c.base_unit_id!==null&&Number(c.base_unit_id)===Number(s));C.value[s]=a,e.derived_units=a}catch(s){console.error("loadDerivedUnits error:",s),e.derived_units=[]}}function Q(e){e.selected_derived_unit_id?e.selectedDerivedUnitInfo=e.derived_units.find(s=>s.id===e.selected_derived_unit_id):e.selectedDerivedUnitInfo=null}async function $(e){M(e);const s=Number(e.qty||0);if(!s||s<=0){b(e,"qty","Enter a valid quantity."),p.error("Enter a valid quantity.");return}let i=s,l=null;e.selected_derived_unit_id&&(await B(e),l=(e.derived_units||[]).find(h=>Number(h.id)===Number(e.selected_derived_unit_id)),l&&l.conversion_factor&&(i=Number(s)*Number(l.conversion_factor)));const a=e.unitPrice!==""?Number(e.unitPrice):Number(e.defaultPrice||0),c=e.expiry||null;if(!i||i<=0){b(e,"qty","Enter a valid quantity."),p.error("Enter a valid quantity.");return}if(!a||a<=0){b(e,"unit_price","Enter a valid unit price."),p.error("Enter a valid unit price.");return}if(!c){b(e,"expiry_date","Enter an expiry date."),p.error("Enter an expiry date.");return}const m=u.value.find(h=>h.id===e.id&&h.unitPrice===a&&h.expiry===c);m?(m.qty=g(m.qty+i),m.cost=g(m.qty*m.unitPrice)):u.value.push({id:e.id,name:e.name,category:e.category,qty:i,unitPrice:a,expiry:c,cost:g(i*a),derived_unit_id:l?l.id:null,derived_unit_name:l?l.name:null,base_unit_name:e.unit_name||null}),e.qty=null,e.unitPrice=null,e.expiry=null,e.selected_derived_unit_id=null,M(e)}function z(e){u.value.splice(e,1)}const x=v(!1),n=v({}),H=()=>{n.value={},S.value.forEach(e=>{e.selectedDerivedUnitInfo=null,e.selected_derived_unit_id=null}),u.value.forEach(e=>{e.selectedDerivedUnitInfo=null,e.selected_derived_unit_id=null})};async function O(){y.value||(n.value.supllier_id=["Please select a supplier."]),n.value={};const e={supplier_id:y.value,purchase_date:new Date().toISOString().split("T")[0],status:"completed",items:u.value.map(s=>({product_id:s.id,quantity:s.qty,unit_price:s.unitPrice,expiry:s.expiry||null}))};x.value=!0;try{const s=await axios.post("/purchase-orders",e);L("refresh-data"),u.value=[],y.value=null,bootstrap.Modal.getInstance(document.getElementById("addPurchaseModal"))?.hide(),p.success("Order created successfully!")}catch(s){s?.response?.status===422&&s.response.data?.errors?(n.value=s.response.data.errors,p.error("Please fill in all required fields correctly.")):(p.error("Something went wrong. Please try again.",{autoClose:3e3}),console.error(s))}finally{x.value=!1}}const g=e=>Math.round((Number(e)||0)*100)/100,y=v(null);return(e,s)=>{const i=R("VueDatePicker");return r(),o("div",W,[t("div",X,[t("div",Y,[t("div",{class:"modal-header"},[s[3]||(s[3]=t("h5",{class:"modal-title fw-semibold"},"Add Purchase",-1)),t("button",{class:"absolute top-2 right-2 p-2 rounded-full hover:bg-gray-100 transition transform hover:scale-110","data-bs-dismiss":"modal","aria-label":"Close",title:"Close",onClick:H},[...s[2]||(s[2]=[t("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-6 w-6 text-red-500",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor","stroke-width":"2"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M6 18L18 6M6 6l12 12"})],-1)])])]),t("div",ee,[t("div",te,[t("div",se,[s[4]||(s[4]=t("label",{class:"form-label small text-muted d-block"},"Preferred supplier",-1)),A(f(J),{modelValue:y.value,"onUpdate:modelValue":s[0]||(s[0]=l=>y.value=l),options:D.suppliers,optionLabel:"name",optionValue:"id",placeholder:"Select Supplier",class:k(["w-100",{"is-invalid":n.value.supplier_id}]),appendTo:"self",autoZIndex:!0,baseZIndex:2e3},null,8,["modelValue","options","class"]),n.value.supplier_id?(r(),o("small",le,d(n.value.supplier_id[0]),1)):_("",!0)])]),t("div",ne,[t("div",ae,[t("div",de,[s[5]||(s[5]=t("i",{class:"bi bi-search"},null,-1)),w(t("input",{"onUpdate:modelValue":s[1]||(s[1]=l=>q.value=l),type:"text",class:"form-control search-input",placeholder:"Search..."},null,512),[[V,q.value]])]),t("div",oe,[(r(!0),o(E,null,I(S.value,l=>(r(),o("div",{key:l.id,class:"card shadow-sm border-0 rounded-4 mb-3"},[t("div",re,[t("div",ie,[t("img",{src:l.image_url,alt:"",style:{width:"76px",height:"76px","object-fit":"cover","border-radius":"6px"}},null,8,ue),t("div",ce,[t("div",ve,d(l.name),1),t("div",_e," Category: "+d(l.category.name),1),t("div",pe," Unit: "+d(l.unit_name),1),t("div",me," Stock: "+d(l.stock),1)]),t("button",{class:"btn btn-primary rounded-pill px-3 py-1 btn-sm",onClick:a=>$(l)}," Add ",8,fe)]),l.selectedDerivedUnitInfo?(r(),o("div",ye,[t("span",he," 1 "+d(l.selectedDerivedUnitInfo.name)+" = "+d(l.selectedDerivedUnitInfo.conversion_factor)+" "+d(l.unit_name),1)])):_("",!0),t("div",be,[t("div",xe,[s[6]||(s[6]=t("label",{class:"small text-muted"},"Quantity",-1)),w(t("input",{"onUpdate:modelValue":a=>l.qty=a,type:"number",min:"0",class:k(["form-control",{"is-invalid":n.value[l.id]&&n.value[l.id].qty}])},null,10,ge),[[V,l.qty,void 0,{number:!0}]]),n.value[l.id]&&n.value[l.id].qty?(r(),o("small",ke,d(n.value[l.id].qty[0]),1)):_("",!0)]),t("div",we,[s[7]||(s[7]=t("label",{class:"small text-muted"},"Unit",-1)),w(t("select",{class:"form-select","onUpdate:modelValue":a=>l.selected_derived_unit_id=a,onChange:a=>Q(l),onFocus:a=>B(l)},[t("option",Ue,"Base ("+d(l.unit_name)+")",1),(r(!0),o(E,null,I(l.derived_units||[],a=>(r(),o("option",{key:a.id,value:a.id},d(a.name),9,qe))),128))],40,Pe),[[G,l.selected_derived_unit_id]]),n.value[l.id]&&n.value[l.id].derived_unit?(r(),o("small",Ce,d(n.value[l.id].derived_unit[0]),1)):_("",!0)]),t("div",Ve,[s[8]||(s[8]=t("label",{class:"small text-muted"},"Unit Price",-1)),w(t("input",{"onUpdate:modelValue":a=>l.unitPrice=a,type:"number",min:"0",class:k(["form-control",{"is-invalid":n.value[l.id]&&n.value[l.id].unit_price}])},null,10,Ee),[[V,l.unitPrice,void 0,{number:!0}]]),n.value[l.id]&&n.value[l.id].unit_price?(r(),o("small",Ie,d(n.value[l.id].unit_price[0]),1)):_("",!0)]),t("div",De,[s[9]||(s[9]=t("label",{class:"small text-muted"},"Expiry Date",-1)),A(i,{modelValue:l.expiry,"onUpdate:modelValue":a=>l.expiry=a,format:f(N),"min-date":new Date,enableTimePicker:!1,placeholder:"Select date",class:k({"is-invalid":n.value[l.id]&&n.value[l.id].expiry_date})},null,8,["modelValue","onUpdate:modelValue","format","min-date","class"]),n.value[l.id]&&n.value[l.id].expiry_date?(r(),o("small",Ne,d(n.value[l.id].expiry_date[0]),1)):_("",!0)])])])]))),128))])]),t("div",Se,[t("div",Me,[t("div",Be,[t("table",je,[s[12]||(s[12]=t("thead",null,[t("tr",null,[t("th",null,"Name"),t("th",null,"Quantity"),t("th",null,"Unit Price"),t("th",null,"Expiry"),t("th",null,"Cost"),t("th",{class:"text-end"},"Action")])],-1)),t("tbody",null,[(r(!0),o(E,null,I(u.value,(l,a)=>(r(),o("tr",{key:a},[t("td",null,d(l.name),1),t("td",null,d(l.qty),1),t("td",null,d(f(P)(l.unitPrice)),1),t("td",null,d(f(N)(l.expiry)||"â€”"),1),t("td",null,d(f(P)(l.cost)),1),t("td",Ae,[t("button",{onClick:c=>z(a),class:"inline-flex items-center justify-center p-2.5 rounded-full text-red-600 hover:bg-red-100",title:"Delete"},[...s[10]||(s[10]=[t("svg",{class:"w-5 h-5",fill:"none",stroke:"currentColor","stroke-width":"2",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6M9 7h6m2 0H7m4-3h2a1 1 0 011 1v1H8V5a1 1 0 011-1z"})],-1)])],8,Fe)])]))),128)),u.value.length===0?(r(),o("tr",Le,[...s[11]||(s[11]=[t("td",{colspan:"7",class:"text-center text-muted py-4"}," No items added. ",-1)])])):_("",!0)])])]),t("div",Te," Total Bill: "+d(f(P)(T.value)),1)]),t("div",Qe,[t("button",{class:"btn btn-primary rounded-pill px-5 py-2",disabled:x.value||u.value.length===0,onClick:O},[x.value?(r(),o("span",He,"Saving...")):(r(),o("span",ze,"Quick Purchase"))],8,$e)])])])])])])])}}},Ye=Z(Oe,[["__scopeId","data-v-8c2b12bf"]]);export{Ye as default};

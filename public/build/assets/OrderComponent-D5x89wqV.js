import{_ as R,r as c,C as O,g as d,o as a,b as t,a as G,i as m,n as U,d as B,t as r,x as g,y as q,F as I,v as P,I as J,m as _}from"./app-C8Xsdeiq.js";import{s as K}from"./index-BOoCw-R4.js";import{u as W}from"./useFormatters-ZLqOMbOR.js";import"./index-Cq4AMUzx.js";const X={class:"modal fade",id:"addOrderModal",tabindex:"-1","aria-hidden":"true"},Y={class:"modal-dialog modal-xl modal-dialog-centered"},ee={class:"modal-content rounded-4"},te={class:"modal-body"},se={class:"row g-3 align-items-center"},le={class:"col-md-5"},ne={key:0,class:"text-danger"},oe={class:"row g-4 mt-1"},re={class:"col-lg-5"},de={class:"search-wrap mb-2"},ae={class:"card-body"},ie={class:"d-flex align-items-start gap-3"},ue=["src"],ce={class:"flex-grow-1"},ve={class:"fw-semibold"},_e={class:"text-muted small"},pe={class:"text-muted small"},me={class:"text-muted small"},fe=["onClick"],ye={key:0,class:"col-12 mt-3"},he={style:{display:"inline-block","background-color":"#e6f7f1",color:"#155724",padding:"4px 18px","border-radius":"20px","font-size":"0.9rem","font-weight":"500","box-shadow":"0 2px 6px rgba(0,0,0,0.08)"}},be={class:"row g-2 mt-3"},ge={class:"col-3"},xe=["onUpdate:modelValue"],ke={key:0,class:"text-danger"},we={class:"col-3"},Ce=["onUpdate:modelValue","onChange","onFocus"],Ue={value:null},qe=["value"],Ie={key:0,class:"text-danger"},Pe={class:"col-3"},Ne=["onUpdate:modelValue"],Ee={key:0,class:"text-danger"},Se={class:"col-lg-7"},Ve={class:"cart card border rounded-4"},De={class:"table-responsive"},Me={class:"table align-middle mb-0"},Oe={class:"text-end"},Be=["onClick"],je={key:0},Fe={class:"text-end p-3 fw-semibold"},Le={class:"mt-4 text-center"},Ae=["disabled"],Te={key:0},$e={key:1},ze={__name:"OrderComponent",props:{suppliers:{type:Array,required:!0},items:{type:Array,required:!0}},emits:["refresh-data"],setup(N,{emit:j}){const{formatCurrencySymbol:F}=W(),E=N,L=j,x=c(""),f=c(null);c(!1);const o=c({});c("");const b=c(!1),k=c({}),S=O(()=>{const e=x.value.trim().toLowerCase();return e?E.items.filter(s=>[s.name,s.category?.name??"",s.unit_name??"",String(s.stock??"")].join(" ").toLowerCase().includes(e)):E.items}),A=c([]),T=()=>{o.value={},S.value.forEach(e=>{e.selectedDerivedUnitInfo=null,e.selected_derived_unit_id=null}),A.value.forEach(e=>{e.selectedDerivedUnitInfo=null,e.selected_derived_unit_id=null})},y=e=>Math.round((Number(e)||0)*100)/100,i=c([]),$=O(()=>y(i.value.reduce((e,s)=>e+Number(s.cost||0),0))),w=(e,s,l)=>{o.value[e.id]||(o.value[e.id]={}),o.value[e.id][s]=[l]};async function V(e){try{const s=e.unit_id??e.unitId??null;if(!s){e.derived_units=[];return}if(k.value[s]){e.derived_units=k.value[s];return}const l=await axios.get("/units",{params:{per_page:200}}),u=(l.data?.data??l.data??[]).filter(v=>v.base_unit_id!==null&&Number(v.base_unit_id)===Number(s));k.value[s]=u,e.derived_units=u}catch(s){console.error("loadDerivedUnits error:",s),e.derived_units=[]}}function z(e){e.selected_derived_unit_id?e.selectedDerivedUnitInfo=e.derived_units.find(s=>s.id===e.selected_derived_unit_id):e.selectedDerivedUnitInfo=null}const D=(e,s=null)=>{o.value&&(!e||!e.id||(s?o.value[e.id]&&(delete o.value[e.id][s],Object.keys(o.value[e.id]).length===0&&delete o.value[e.id]):delete o.value[e.id]))};async function H(e){D(e);const s=Number(e.qty||0);if(!s||s<=0){w(e,"qty","Enter a valid quantity."),_.error("Enter a valid quantity.");return}let l=s,n=null,u=1;e.selected_derived_unit_id&&(await V(e),n=(e.derived_units||[]).find(h=>Number(h.id)===Number(e.selected_derived_unit_id)),n&&n.conversion_factor&&(u=Number(n.conversion_factor),l=Number(s)*u));const v=e.unitPrice!==""?Number(e.unitPrice):Number(e.defaultPrice||0),C=n?y(v/u):v,M=e.expiry||null;if(!l||l<=0){w(e,"qty","Enter a valid quantity."),_.error("Enter a valid quantity.");return}if(!v||v<=0){w(e,"unit_price","Enter a valid unit price."),_.error("Enter a valid unit price.");return}const p=i.value.find(h=>h.id===e.id&&h.unitPrice===C&&h.expiry===M);p?(p.qty=y(p.qty+l),p.cost=y(p.qty*p.unitPrice)):i.value.push({id:e.id,name:e.name,category:e.category,qty:l,unitPrice:C,expiry:M,cost:y(l*C),derived_unit_id:n?n.id:null,derived_unit_name:n?n.name:null,base_unit_name:e.unit_name||null,entered_price:v,entered_unit:n?n.name:e.unit_name}),e.qty=null,e.unitPrice=null,e.expiry=null,e.selected_derived_unit_id=null,D(e)}function Q(e){i.value.splice(e,1)}async function Z(){if(!f.value){o.value.supplier_id=["Please select a supplier."],_.error("Please select a supplier."),await nextTick(),document.getElementById("supplierSelect")?.focus();return}const e={supplier_id:f.value,purchase_date:new Date().toISOString().split("T")[0],status:"pending",items:i.value.map(({id:s,qty:l,unitPrice:n,expiry:u})=>({product_id:s,quantity:l,unit_price:n,expiry:u||null}))};b.value=!0;try{const s=await axios.post("/purchase-orders",e);i.value=[],f.value=null,bootstrap.Modal.getInstance(document.getElementById("addOrderModal"))?.hide(),_.success("Purchase order created successfully!"),L("refresh-data")}catch(s){s?.response?.status===422&&s.response.data?.errors?(o.value=s.response.data.errors,_.error("Please fill in all required fields correctly.")):(console.error(s),_.error("Something went wrong. Please try again.",{autoClose:3e3}))}finally{b.value=!1}}return(e,s)=>(a(),d("div",X,[t("div",Y,[t("div",ee,[t("div",{class:"modal-header"},[s[3]||(s[3]=t("h5",{class:"modal-title fw-semibold"},"Order",-1)),t("button",{class:"absolute top-2 right-2 p-2 rounded-full hover:bg-gray-100 transition transform hover:scale-110","data-bs-dismiss":"modal","aria-label":"Close",title:"Close",onClick:T},[...s[2]||(s[2]=[t("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-6 w-6 text-red-500",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor","stroke-width":"2"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M6 18L18 6M6 6l12 12"})],-1)])])]),t("div",te,[t("div",se,[t("div",le,[s[4]||(s[4]=t("label",{class:"form-label small text-muted d-block"},"Preferred Supplier",-1)),G(B(K),{modelValue:f.value,"onUpdate:modelValue":s[0]||(s[0]=l=>f.value=l),options:N.suppliers,optionLabel:"name",optionValue:"id",placeholder:"Select Supplier",class:U(["w-100",{"is-invalid":o.value.supplier_id}]),appendTo:"self",autoZIndex:!0,baseZIndex:2e3},null,8,["modelValue","options","class"]),o.value.supplier_id?(a(),d("small",ne,r(o.value.supplier_id[0]),1)):m("",!0)])]),t("div",oe,[t("div",re,[t("div",de,[s[5]||(s[5]=t("i",{class:"bi bi-search"},null,-1)),g(t("input",{"onUpdate:modelValue":s[1]||(s[1]=l=>x.value=l),type:"text",class:"form-control search-input",placeholder:"Search..."},null,512),[[q,x.value]])]),(a(!0),d(I,null,P(S.value,l=>(a(),d("div",{key:l.id,class:"card shadow-sm border-0 rounded-4 mb-3"},[t("div",ae,[t("div",ie,[t("img",{src:l.image_url,alt:"",style:{width:"76px",height:"76px","object-fit":"cover","border-radius":"6px"}},null,8,ue),t("div",ce,[t("div",ve,r(l.name),1),t("div",_e," Category: "+r(l.category.name),1),t("div",pe," Unit: "+r(l.unit_name),1),t("div",me," Stock: "+r(l.stock),1)]),t("button",{class:"btn btn-primary rounded-pill px-3 py-1 btn-sm",onClick:n=>H(l)}," Add ",8,fe)]),l.selectedDerivedUnitInfo?(a(),d("div",ye,[t("span",he," 1 "+r(l.selectedDerivedUnitInfo.name)+" = "+r(l.selectedDerivedUnitInfo.conversion_factor)+" "+r(l.unit_name),1)])):m("",!0),t("div",be,[t("div",ge,[s[6]||(s[6]=t("label",{class:"small text-muted"},"Quantity",-1)),g(t("input",{"onUpdate:modelValue":n=>l.qty=n,type:"number",min:"0",class:U(["form-control form-control",{"is-invalid":o.value[l.id]&&o.value[l.id].qty}])},null,10,xe),[[q,l.qty,void 0,{number:!0}]]),o.value[l.id]&&o.value[l.id].qty?(a(),d("small",ke,r(o.value[l.id].qty[0]),1)):m("",!0)]),t("div",we,[s[7]||(s[7]=t("label",{class:"small text-muted"},"Unit",-1)),g(t("select",{class:"form-select","onUpdate:modelValue":n=>l.selected_derived_unit_id=n,onChange:n=>z(l),onFocus:n=>V(l)},[t("option",Ue,"Base ("+r(l.unit_name)+")",1),(a(!0),d(I,null,P(l.derived_units||[],n=>(a(),d("option",{key:n.id,value:n.id},r(n.name),9,qe))),128))],40,Ce),[[J,l.selected_derived_unit_id]]),o.value[l.id]&&o.value[l.id].derived_unit?(a(),d("small",Ie,r(o.value[l.id].derived_unit[0]),1)):m("",!0)]),t("div",Pe,[s[8]||(s[8]=t("label",{class:"small text-muted"},"Unit Price",-1)),g(t("input",{"onUpdate:modelValue":n=>l.unitPrice=n,type:"number",min:"0",class:U(["form-control form-control",{"is-invalid":o.value[l.id]&&o.value[l.id].unit_price}])},null,10,Ne),[[q,l.unitPrice,void 0,{number:!0}]]),o.value[l.id]&&o.value[l.id].unit_price?(a(),d("small",Ee,r(o.value[l.id].unit_price[0]),1)):m("",!0)])])])]))),128))]),t("div",Se,[t("div",Ve,[t("div",De,[t("table",Me,[s[11]||(s[11]=t("thead",null,[t("tr",null,[t("th",null,"Name"),t("th",null,"Quantity"),t("th",null,"unit price"),t("th",null,"cost"),t("th",{class:"text-end"},"Action")])],-1)),t("tbody",null,[(a(!0),d(I,null,P(i.value,(l,n)=>(a(),d("tr",{key:n},[t("td",null,r(l.name),1),t("td",null,r(l.qty),1),t("td",null,r(l.unitPrice),1),t("td",null,r(l.cost),1),t("td",Oe,[t("button",{onClick:u=>Q(n),class:"inline-flex items-center justify-center p-2.5 rounded-full text-red-600 hover:bg-red-100",title:"Delete"},[...s[9]||(s[9]=[t("svg",{class:"w-5 h-5",fill:"none",stroke:"currentColor","stroke-width":"2",viewBox:"0 0 24 24"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6M9 7h6m2 0H7m4-3h2a1 1 0 011 1v1H8V5a1 1 0 011-1z"})],-1)])],8,Be)])]))),128)),i.value.length===0?(a(),d("tr",je,[...s[10]||(s[10]=[t("td",{colspan:"7",class:"text-center text-muted py-4"}," No items added. ",-1)])])):m("",!0)])])]),t("div",Fe," Total Bill: "+r(B(F)($.value)),1)]),t("div",Le,[t("button",{type:"button",class:"btn btn-primary rounded-pill px-5 py-2",disabled:b.value||i.value.length===0,onClick:Z},[b.value?(a(),d("span",$e,"Saving...")):(a(),d("span",Te,"Order"))],8,Ae)])])])])])])]))}},Ge=R(ze,[["__scopeId","data-v-50cb8018"]]);export{Ge as default};

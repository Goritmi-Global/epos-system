import{_ as N,A as P,r as c,w,o as D,s as a,g as y,b as g,f as i,t as x,p as k,q as S}from"./app-DFa9wJfT.js";const C={class:"mt-3 mb-2"},A=["disabled"],O={key:0},E={key:1,class:"d-inline-flex align-items-center gap-2"},F="#1C0D82",B={__name:"StripePayment",props:{order_code:String,show:Boolean,customer:String,phone:String,deliveryLocation:String,orderType:String,selectedTable:Object,orderItems:Array,grandTotal:Number,orderTotal:Number,money:Function,cashReceived:Number,cardPayment:Number,subTotal:Number,tax:Number,serviceCharges:Number,deliveryCharges:Number,note:[String,null],kitchenNote:[String,null],orderDate:String,orderTime:String,paymentMethod:String,paymentType:String,change:Number,type:String,cardCharge:Number,promoDiscount:{type:Number,default:0},promoId:{type:[Number,String,null],default:null},promoName:{type:[String,null],default:null},promoType:{type:[String,null],default:null},promoDiscountAmount:{type:Number,default:0},appliedPromos:{type:Array,default:()=>[]},approvedDiscounts:{type:Number,default:0},approvedDiscountDetails:{type:Array,default:()=>[]},currentOrderId:{type:[Number,null],default:null},isPartialPayment:{type:Boolean,default:!1},selectedItemIds:{type:Array,default:()=>[]},paidItemIds:{type:Array,default:()=>[]},paidProductIds:{type:Array,default:()=>[]},paidDealIds:{type:Array,default:()=>[]}},emits:["payment-success"],setup(_,{emit:b}){const e=_,v=b,h=P(),s=c(null),p=c(null),f=c(null),l=c(!1),n=c(!1);let o=null;async function T(){try{const r={amount:e.grandTotal??0,currency:"gbp",order_code:e.order_code??null},{data:t}=await S.post(route("stripe.pi.create"),r,{headers:{"X-Idempotency-Key":crypto.randomUUID?.()??String(Date.now())}});f.value=t.client_secret}catch(r){throw console.error(r),a.error("Could not start card payment. Please try again."),r}}async function m(){if((e.grandTotal??0)<=0){o&&o.unmount?.(),l.value=!1;return}s.value=window.Stripe(h.props.stripe_public_key),await T();const r={theme:"stripe",variables:{colorPrimary:F,colorText:"#0b1020",colorTextPlaceholder:"#98A2B3",colorBackground:"#FFFFFF",colorDanger:"#E5484D",borderRadius:"12px",fontFamily:'Inter, Poppins, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial'},rules:{".Label":{fontWeight:"600"},".Input":{boxShadow:"0 1px 2px rgba(0,0,0,.06)",padding:"12px"},".Tab, .Block":{borderRadius:"12px"},".Error":{color:"#E5484D"}}};p.value=s.value.elements({clientSecret:f.value,appearance:r}),o&&o.unmount?.(),o=p.value.create("payment"),o.mount("#payment-element"),l.value=!0}async function I(){if(!s.value||!p.value||!l.value){a.error("Payment is not ready yet. Please wait a moment.");return}n.value=!0;const r=new URLSearchParams({order_code:e.order_code??"",customer_name:e.customer??"",phone_number:e.phone??"",delivery_location:e.deliveryLocation??"",sub_total:String(e.orderTotal??e.grandTotal??0),total_amount:String(e.orderTotal??e.grandTotal??0),order_id:String(e.currentOrderId??""),is_partial_payment:e.isPartialPayment?"1":"0",selected_item_ids:JSON.stringify(e.selectedItemIds||[]),paid_item_ids:JSON.stringify(e.paidItemIds||[]),paid_product_ids:JSON.stringify(e.paidProductIds||[]),paid_deal_ids:JSON.stringify(e.paidDealIds||[]),type:String(e.type??"full-payment"),cardCharge:String(e.cardCharge??e.grandTotal??0),promo_discount:String(e.promoDiscount??0),promo_id:String(e.promoId??""),promo_name:String(e.promoName??""),promo_type:String(e.promoType??""),applied_promos:JSON.stringify(e.appliedPromos||[]),approved_discounts:String(e.approvedDiscounts??0),approved_discount_details:JSON.stringify(e.approvedDiscountDetails||[]),tax:String(e.tax??0),sale_discount:String(e.orderItems?.reduce((t,d)=>t+(d.total_resale_discount||0),0)||0),service_charges:String(e.serviceCharges??0),delivery_charges:String(e.deliveryCharges??0),note:e.note??"",kitchen_note:e.kitchenNote??"",order_date:e.orderDate??new Date().toISOString().split("T")[0],order_time:e.orderTime??new Date().toTimeString().split(" ")[0],order_type:e.orderType==="Eat_in"?"Eat In":e.orderType==="Delivery"?"Delivery":e.orderType==="Takeaway"?"Takeaway":"Collection",table_number:e.selectedTable?.name??"",payment_method:e.paymentMethod??"Stripe",payment_type:e.paymentType||"Card",cash_received:String(e.cashReceived??0),card_payment:String(e.cardPayment??e.grandTotal??0),change:String(e.change??0),items:JSON.stringify((e.orderItems??[]).map(t=>({product_id:t.id,title:t.title,quantity:t.qty,price:t.price,note:t.note??null,kitchen_note:t.kitchenNote??null,item_kitchen_note:t.item_kitchen_note??null,sale_discount_per_item:t.resale_discount_per_item||0})))});try{const t=await s.value.confirmPayment({elements:p.value,confirmParams:{return_url:`${window.location.origin}/pos/place-stripe-order?${r.toString()}`},redirect:"if_required"});if(t.error){a.error(t.error.message||"Payment failed. Please try again."),n.value=!1;return}if(t.paymentIntent&&t.paymentIntent.status==="succeeded"){const d=Object.fromEntries(r);d.payment_intent=t.paymentIntent.id,d.redirect_status="succeeded";const u=await S.post("/pos/place-stripe-order",d);u.data.success?(a.success(u.data.message||"Payment processed!"),v("payment-success",u.data)):a.error(u.data.message||"Failed to finalize order on server."),n.value=!1}}catch(t){console.error(t),a.error("Something went wrong while confirming payment."),n.value=!1}}return w(()=>e.grandTotal,async(r,t)=>{r!==t&&s.value&&(l.value=!1,await m())}),D(async()=>{if(window.Stripe)await m();else{const r=document.createElement("script");r.src="https://js.stripe.com/v3/",r.addEventListener("load",m),r.addEventListener("error",()=>a.error("Could not load Stripe. Check your network and try again.")),document.body.appendChild(r)}}),(r,t)=>(g(),y("div",C,[t[1]||(t[1]=i("div",{class:"pay-header d-flex align-items-center gap-2 mb-3"},[i("i",{class:"bi bi-credit-card-2-front-fill"}),i("h6",{class:"m-0"},"Pay with Card")],-1)),t[2]||(t[2]=i("div",{id:"payment-element",class:"stripe-box rounded-4 p-3"},null,-1)),i("button",{type:"button",class:"btn btn-primary pay-btn rounded-pill mt-3 d-inline-flex align-items-center justify-content-center",disabled:!l.value||n.value,onClick:I},[n.value?(g(),y("span",E,[...t[0]||(t[0]=[k(" Processing… ",-1),i("span",{class:"spinner-border spinner-border-sm",role:"status","aria-hidden":"true"},null,-1)])])):(g(),y("span",O,"Pay £"+x((_.grandTotal??0).toFixed(2)),1))],8,A)]))}},J=N(B,[["__scopeId","data-v-b37c6fc5"]]);export{J as default};

import{_ as oe,r as g,y as O,o as re,Y as J,c as $,E as ie,f as i,b as u,e as l,B as ue,m as _,i as b,d as T,w as Z,t as a,u as U,F as x,g as D,k as w,v as M,S as A,q as P}from"./app-DMbHFmC5.js";import{s as ae}from"./index-CTeLyq-R.js";import{u as de}from"./useFormatters-DkTAsbQy.js";import"./index-n9M0qU1L.js";import"./index-CPY7-peg.js";import"./index-yoVNKB8J.js";import"./index-ByxpwMC9.js";const ce={class:"modal fade",id:"bulkOrderModal",tabindex:"-1","aria-hidden":"true"},pe={class:"modal-dialog modal-xl modal-dialog-centered"},ve={class:"modal-content rounded-4"},me={class:"modal-body"},_e={class:"nav nav-tabs mb-4",role:"tablist"},ye={class:"nav-item",role:"presentation"},fe={class:"nav-item",role:"presentation"},be={key:0},he={class:"mb-3"},ge={key:0},Pe={key:1},ke={key:0,class:"text-danger"},Ie={class:"table-responsive"},Ue={class:"table align-middle"},we=["onUpdate:modelValue","onInput"],qe={key:0,class:"text-danger"},xe=["onUpdate:modelValue","onChange","onFocus"],De={value:null},Ve=["value"],Se=["onUpdate:modelValue","onInput"],Ce={key:0,class:"text-danger"},Ne={key:0,class:"text-danger"},Ee=["onClick"],Me={class:"text-end fw-bold mt-3"},Fe={key:1},Be={class:"table-responsive"},Oe={class:"table align-middle"},$e=["onUpdate:modelValue"],Te=["value"],Ae={key:0,class:"text-danger d-block"},je=["onUpdate:modelValue","onInput"],Le={key:0,class:"text-danger"},ze=["onUpdate:modelValue","onChange","onFocus"],Qe={value:null},Re=["value"],Je=["onUpdate:modelValue","onInput"],Ze={key:0,class:"text-danger"},Ye={key:0,class:"text-danger"},Ge=["onClick"],He={class:"text-end fw-bold mt-3"},Ke={class:"modal-footer"},We=["disabled"],Xe={key:0},et={key:1},tt=["disabled"],lt={key:0},nt={key:1},st={__name:"BulkOrderComponent",props:{suppliers:{type:Array,default:()=>[]},items:{type:Array,default:()=>[]}},emits:["refresh-data"],setup(V,{emit:Y}){const{formatCurrencySymbol:S,dateFmt:j}=de(),C=V,F=g({}),L=Y,y=g("single"),f=g(null),N=g(!1),d=g({}),c=g([]),E=g(!1),h=g({}),p=g([]);O(()=>C.items,t=>{c.value=t.map(n=>({...n,qty:0,unitPrice:0,expiry:null,subtotal:0,selected_derived_unit_id:null,selectedDerivedUnitInfo:null,derived_units:[]}))},{immediate:!0}),O(f,t=>{c.value.forEach(n=>{n.preferred_supplier_id!==t&&n.supplier_id!==t&&(n.qty=0,n.unitPrice=0,n.expiry=null,n.subtotal=0,n.selected_derived_unit_id=null,n.selectedDerivedUnitInfo=null)})}),O(()=>C.items,t=>{p.value=t.map(n=>({...n,qty:0,unitPrice:0,expiry:null,subtotal:0,supplier_id:n.preferred_supplier_id||n.supplier_id||null,selected_derived_unit_id:null,selectedDerivedUnitInfo:null,derived_units:[]}))},{immediate:!0}),re(()=>{console.log("Props items:",J(C.items)),console.log("First item structure:",J(C.items[0])),feather.replace();const t=document.getElementById("bulkOrderModal");t&&(t.addEventListener("show.bs.modal",()=>{y.value="single"}),t.addEventListener("hide.bs.modal",()=>{y.value="single"}))});function B(t){let n=Number(t.qty)||0;const r=Number(t.unitPrice)||0;t.selected_derived_unit_id&&t.selectedDerivedUnitInfo&&(Number(t.selectedDerivedUnitInfo.conversion_factor),n=n),t.subtotal=n*r}function G(t){let n=Number(t.qty)||0;const r=Number(t.unitPrice)||0;t.selected_derived_unit_id&&t.selectedDerivedUnitInfo&&(Number(t.selectedDerivedUnitInfo.conversion_factor),n=n),t.subtotal=n*r}function z(t){t.qty<0&&(t.qty=0),B(t)}function Q(t){if(t.unitPrice===null||t.unitPrice===void 0||t.unitPrice===""){t.unitPrice="",t.subtotal=0;return}t.unitPrice<0&&(t.unitPrice=0),B(t)}const H=$(()=>f.value?c.value.filter(t=>{const n=t.preferred_supplier_id||t.preferredSupplierId,r=t.supplier_id||t.supplierId;return n===f.value||r===f.value}):c.value);function K(t){c.value[t].qty=0,c.value[t].unitPrice=0,c.value[t].expiry=null,c.value[t].subtotal=0,c.value[t].selected_derived_unit_id=null,c.value[t].selectedDerivedUnitInfo=null,c.value[t].derived_units&&(c.value[t].derived_units=[])}function W(t){p.value[t].qty=0,p.value[t].unitPrice=0,p.value[t].expiry=null,p.value[t].subtotal=0,p.value[t].supplier_id=null,p.value[t].selected_derived_unit_id=null,p.value[t].selectedDerivedUnitInfo=null,p.value[t].derived_units&&(p.value[t].derived_units=[])}async function R(t){try{const n=t.unit_id??t.unitId??null;if(!n){t.derived_units=[];return}if(F.value[n]){t.derived_units=F.value[n];return}const r=await axios.get("/units",{params:{per_page:200}}),o=(r.data?.data??r.data??[]).filter(s=>s.base_unit_id!==null&&Number(s.base_unit_id)===Number(n));F.value[n]=o,t.derived_units=o}catch(n){console.error("loadDerivedUnits error:",n),t.derived_units=[]}}function X(t){t.selected_derived_unit_id?t.selectedDerivedUnitInfo=t.derived_units.find(n=>n.id===t.selected_derived_unit_id):t.selectedDerivedUnitInfo=null,B(t)}function ee(t){t.selected_derived_unit_id?t.selectedDerivedUnitInfo=t.derived_units.find(n=>n.id===t.selected_derived_unit_id):t.selectedDerivedUnitInfo=null,G(t)}const te=$(()=>c.value.reduce((t,n)=>t+(Number(n.subtotal)||0),0)),le=$(()=>p.value.reduce((t,n)=>t+(Number(n.subtotal)||0),0));async function ne(){d.value={},f.value||(d.value.supplier="Please select a supplier");const t=new Date().toISOString().split("T")[0],n=[];if(console.log("Raw bulkItems before processing:",JSON.parse(JSON.stringify(c.value))),c.value.forEach((e,o)=>{console.log(`Processing item ${o}:`,{id:e.id,name:e.name,qty:e.qty,unitPrice:e.unitPrice,selected_derived_unit_id:e.selected_derived_unit_id,selectedDerivedUnitInfo:e.selectedDerivedUnitInfo});const s=e.qty||e.unitPrice||e.expiry,v={};if(s){let m=Number(e.qty)||0;if(e.selected_derived_unit_id&&e.selectedDerivedUnitInfo){const q=Number(e.selectedDerivedUnitInfo.conversion_factor)||1;m=m*q,console.log(`Applied conversion: ${e.qty} * ${q} = ${m}`)}const k=e.unitPrice!==null&&e.unitPrice!==void 0&&e.unitPrice!==""?Number(e.unitPrice):0;console.log("Entered Price:",k,"Type:",typeof e.unitPrice,"Raw value:",e.unitPrice);const I=e.selectedDerivedUnitInfo&&k>0?Number((k/Number(e.selectedDerivedUnitInfo.conversion_factor)).toFixed(4)):k;if(console.log("Base Unit Price:",I),(!m||m<=0)&&(v.qty="Quantity is required"),(!k||k<=0)&&(v.unitPrice="Unit Price is required"),e.expiry?new Date(e.expiry)<new Date(t)&&(v.expiry="Expiry must be today or later"):v.expiry="Expiry date is required",Object.keys(v).length>0)d.value[o]=v;else{const q={product_id:e.id,quantity:m,unit_price:I,expiry:e.expiry};console.log("Pushing item to validItems:",q),n.push(q)}}}),console.log("Valid Items to submit:",n),!f.value){P.error("Please select a supplier");return}if(n.length===0){P.error("No valid items to submit");return}if(Object.keys(d.value).length>0){P.error("Please fix the highlighted errors");return}const r={supplier_id:f.value,purchase_date:t,status:"completed",items:n};console.log("Final Payload:",r),N.value=!0;try{await axios.post("/purchase-orders",r),P.success("Bulk order created successfully!"),L("refresh-data"),f.value=null,c.value.forEach(o=>{o.qty=0,o.unitPrice=0,o.expiry=null,o.subtotal=0,o.selected_derived_unit_id=null,o.selectedDerivedUnitInfo=null}),bootstrap.Modal.getInstance(document.getElementById("bulkOrderModal"))?.hide()}catch(e){console.error(e),P.error("Failed to save bulk order")}finally{N.value=!1}}async function se(){h.value={};const t=new Date().toISOString().split("T")[0],n={};if(p.value.forEach((r,e)=>{const o=r.qty||r.unitPrice||r.expiry,s={};if(o){r.supplier_id||(s.supplier_id="Supplier is required");let v=Number(r.qty)||0;if(r.selected_derived_unit_id&&r.selectedDerivedUnitInfo){const I=Number(r.selectedDerivedUnitInfo.conversion_factor)||1;v=v*I}const m=r.unitPrice!==null&&r.unitPrice!==void 0&&r.unitPrice!==""?Number(r.unitPrice):0,k=r.selectedDerivedUnitInfo&&m>0?Number((m/Number(r.selectedDerivedUnitInfo.conversion_factor)).toFixed(4)):m;if((!v||v<=0)&&(s.qty="Quantity is required"),(!m||m<=0)&&(s.unitPrice="Unit Price is required"),r.expiry?new Date(r.expiry)<new Date(t)&&(s.expiry="Expiry must be today or later"):s.expiry="Expiry date is required",Object.keys(s).length>0)h.value[e]=s;else{const I=r.supplier_id;n[I]||(n[I]=[]),n[I].push({product_id:r.id,quantity:v,unit_price:k,expiry:r.expiry})}}}),Object.keys(n).length===0){P.error("No valid items to submit");return}if(Object.keys(h.value).length>0){P.error("Please fix the highlighted errors");return}E.value=!0;try{for(const[e,o]of Object.entries(n)){const s={supplier_id:parseInt(e),purchase_date:t,status:"completed",items:o};await axios.post("/purchase-orders",s)}P.success("Multiple orders created successfully!"),L("refresh-data"),p.value.forEach(e=>{e.qty=0,e.unitPrice=0,e.expiry=null,e.subtotal=0,e.supplier_id=null,e.selected_derived_unit_id=null,e.selectedDerivedUnitInfo=null}),bootstrap.Modal.getInstance(document.getElementById("bulkOrderModal"))?.hide(),setTimeout(()=>{document.querySelectorAll(".modal-backdrop").forEach(e=>e.remove()),document.body.classList.remove("modal-open"),document.body.style.removeProperty("overflow"),document.body.style.removeProperty("padding-right")},100)}catch(r){console.error(r),P.error("Failed to save multiple orders")}finally{E.value=!1}}return(t,n)=>{const r=ie("VueDatePicker");return u(),i("div",ce,[l("div",pe,[l("div",ve,[n[9]||(n[9]=ue('<div class="modal-header" data-v-741d4272><h5 class="modal-title fw-semibold" data-v-741d4272>Bulk Purchase</h5><button class="absolute top-2 right-2 p-2 rounded-full hover:bg-gray-100 transition transform hover:scale-110" data-bs-dismiss="modal" aria-label="Close" title="Close" data-v-741d4272><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" data-v-741d4272><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" data-v-741d4272></path></svg></button></div>',1)),l("div",me,[l("ul",_e,[l("li",ye,[l("button",{class:b(["nav-link",{active:y.value==="single"}]),onClick:n[0]||(n[0]=e=>y.value="single"),type:"button",role:"tab"}," Single Purchase ",2)]),l("li",fe,[l("button",{class:b(["nav-link",{active:y.value==="multiple"}]),onClick:n[1]||(n[1]=e=>y.value="multiple"),type:"button",role:"tab"}," Multiple Purchase ",2)])]),y.value==="single"?(u(),i("div",be,[l("div",he,[n[3]||(n[3]=l("label",{class:"form-label"},"Preferred Supplier",-1)),T(U(ae),{modelValue:f.value,"onUpdate:modelValue":n[2]||(n[2]=e=>f.value=e),options:V.suppliers,optionLabel:"name",optionValue:"id",placeholder:"Select Supplier",class:b(["w-100",{"is-invalid":d.value.supplier}]),appendTo:"self",autoZIndex:!0,baseZIndex:2e3},{value:Z(e=>[e.value?(u(),i("div",ge,a(V.suppliers.find(o=>o.id===e.value)?.name||"Select Supplier"),1)):(u(),i("span",Pe,a(e.placeholder),1))]),option:Z(e=>[l("div",null,a(e.option.name),1)]),_:1},8,["modelValue","options","class"]),d.value.supplier?(u(),i("small",ke,a(d.value.supplier),1)):_("",!0)]),l("div",Ie,[l("table",Ue,[n[5]||(n[5]=l("thead",null,[l("tr",null,[l("th",null,"Name"),l("th",null,"Category"),l("th",null,"Unit"),l("th",null,"Qty"),l("th",null,"Unit"),l("th",null,"Unit Price"),l("th",null,"Expiry"),l("th",null,"Subtotal"),l("th")])],-1)),l("tbody",null,[(u(!0),i(x,null,D(H.value,(e,o)=>(u(),i("tr",{key:e.id},[l("td",null,a(e.name),1),l("td",null,a(e.category?.name||"-"),1),l("td",null,a(e.unit_name),1),l("td",null,[w(l("input",{type:"number",min:"0","onUpdate:modelValue":s=>e.qty=s,class:b(["form-control",{"is-invalid":d.value[o]?.qty}]),onInput:s=>z(e)},null,42,we),[[M,e.qty,void 0,{number:!0}]]),d.value[o]?.qty?(u(),i("small",qe,a(d.value[o].qty),1)):_("",!0)]),l("td",null,[w(l("select",{class:"form-select","onUpdate:modelValue":s=>e.selected_derived_unit_id=s,onChange:s=>X(e),onFocus:s=>R(e)},[l("option",De,"Base ("+a(e.unit_name)+")",1),(u(!0),i(x,null,D(e.derived_units||[],s=>(u(),i("option",{key:s.id,value:s.id},a(s.name),9,Ve))),128))],40,xe),[[A,e.selected_derived_unit_id]])]),l("td",null,[w(l("input",{type:"number",min:"0","onUpdate:modelValue":s=>e.unitPrice=s,class:b(["form-control",{"is-invalid":d.value[o]?.unitPrice}]),onInput:s=>Q(e)},null,42,Se),[[M,e.unitPrice,void 0,{number:!0}]]),d.value[o]?.unitPrice?(u(),i("small",Ce,a(d.value[o].unitPrice),1)):_("",!0)]),l("td",null,[T(r,{modelValue:e.expiry,"onUpdate:modelValue":s=>e.expiry=s,format:U(j),"min-date":new Date,enableTimePicker:!1,teleport:"body",placeholder:"Select date",class:b({"is-invalid":d.value[o]?.expiry})},null,8,["modelValue","onUpdate:modelValue","format","min-date","class"]),d.value[o]?.expiry?(u(),i("small",Ne,a(d.value[o].expiry),1)):_("",!0)]),l("td",null,a(U(S)(e.subtotal.toFixed(2))),1),l("td",null,[l("button",{class:"btn btn-sm btn-outline-danger d-flex align-items-center justify-content-center",onClick:s=>K(o),title:"Clear",style:{width:"36px",height:"36px"}},[...n[4]||(n[4]=[l("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",fill:"currentColor",viewBox:"0 0 16 16"},[l("path",{"fill-rule":"evenodd",d:"M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"}),l("path",{d:"M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"})],-1)])],8,Ee)])]))),128))])])]),l("div",Me," Total: "+a(U(S)(te.value.toFixed(2))),1)])):_("",!0),y.value==="multiple"?(u(),i("div",Fe,[l("div",Be,[l("table",Oe,[n[8]||(n[8]=l("thead",null,[l("tr",null,[l("th",null,"Name"),l("th",null,"Category"),l("th",null,"Unit"),l("th",null,"Supplier"),l("th",null,"Qty"),l("th",null,"Unit"),l("th",null,"Unit Price"),l("th",null,"Expiry"),l("th",null,"Subtotal"),l("th")])],-1)),l("tbody",null,[(u(!0),i(x,null,D(p.value,(e,o)=>(u(),i("tr",{key:e.id},[l("td",null,a(e.name),1),l("td",null,a(e.category?.name||"-"),1),l("td",null,a(e.unit_name),1),l("td",null,[w(l("select",{"onUpdate:modelValue":s=>e.supplier_id=s,class:b(["form-select w-100",{"is-invalid":h.value[o]?.supplier_id}])},[n[6]||(n[6]=l("option",{value:"",disabled:"",hidden:""},"Select Supplier",-1)),(u(!0),i(x,null,D(V.suppliers,s=>(u(),i("option",{key:s.id,value:s.id},a(s.name),9,Te))),128))],10,$e),[[A,e.supplier_id]]),h.value[o]?.supplier_id?(u(),i("small",Ae,a(h.value[o].supplier_id),1)):_("",!0)]),l("td",null,[w(l("input",{type:"number",min:"0","onUpdate:modelValue":s=>e.qty=s,class:b(["form-control",{"is-invalid":d.value[o]?.qty}]),onInput:s=>z(e)},null,42,je),[[M,e.qty,void 0,{number:!0}]]),d.value[o]?.qty?(u(),i("small",Le,a(d.value[o].qty),1)):_("",!0)]),l("td",null,[w(l("select",{class:"form-select","onUpdate:modelValue":s=>e.selected_derived_unit_id=s,onChange:s=>ee(e),onFocus:s=>R(e)},[l("option",Qe,"Base ("+a(e.unit_name)+")",1),(u(!0),i(x,null,D(e.derived_units||[],s=>(u(),i("option",{key:s.id,value:s.id},a(s.name),9,Re))),128))],40,ze),[[A,e.selected_derived_unit_id]])]),l("td",null,[w(l("input",{type:"number",min:"0","onUpdate:modelValue":s=>e.unitPrice=s,class:b(["form-control",{"is-invalid":d.value[o]?.unitPrice}]),onInput:s=>Q(e)},null,42,Je),[[M,e.unitPrice,void 0,{number:!0}]]),d.value[o]?.unitPrice?(u(),i("small",Ze,a(d.value[o].unitPrice),1)):_("",!0)]),l("td",null,[T(r,{modelValue:e.expiry,"onUpdate:modelValue":s=>e.expiry=s,position:t.bottom,format:U(j),"min-date":new Date,enableTimePicker:!1,teleport:t.body,placeholder:"Select date",class:b({"is-invalid":h.value[o]?.expiry})},null,8,["modelValue","onUpdate:modelValue","position","format","min-date","teleport","class"]),h.value[o]?.expiry?(u(),i("small",Ye,a(h.value[o].expiry),1)):_("",!0)]),l("td",null,a(U(S)(e.subtotal.toFixed(2))),1),l("td",null,[l("button",{class:"btn btn-sm btn-outline-danger d-flex align-items-center justify-content-center",onClick:s=>W(o),title:"Clear",style:{width:"36px",height:"36px"}},[...n[7]||(n[7]=[l("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",fill:"currentColor",viewBox:"0 0 16 16"},[l("path",{"fill-rule":"evenodd",d:"M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"}),l("path",{d:"M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"})],-1)])],8,Ge)])]))),128))])])]),l("div",He," Total: "+a(U(S)(le.value.toFixed(2))),1)])):_("",!0)]),l("div",Ke,[y.value==="single"?(u(),i("button",{key:0,class:"btn btn-primary rounded-pill px-4 py-2",disabled:N.value,onClick:ne},[N.value?(u(),i("span",et,"Saving...")):(u(),i("span",Xe,"Save"))],8,We)):_("",!0),y.value==="multiple"?(u(),i("button",{key:1,class:"btn btn-primary rounded-pill px-4 py-2",disabled:E.value,onClick:se},[E.value?(u(),i("span",nt,"Saving...")):(u(),i("span",lt,"Save"))],8,tt)):_("",!0)])])])])}}},pt=oe(st,[["__scopeId","data-v-741d4272"]]);export{pt as default};

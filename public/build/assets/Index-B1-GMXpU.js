import{_ as se,r as _,o as U,n as oe,c as T,I as le,w as ne,a as re,b as v,d as z,e as I,f as t,u as p,h as ie,t as r,g as h,l as G,m as H,v as ue,p as de,F as A,i as W,T as ce,P as me,s as y}from"./app-DR8KNMKR.js";import{_ as pe}from"./Master-CDAihGCm.js";import{u as ve}from"./useFormatters-DMXCh6bx.js";import{F as ye}from"./FilterModal-DzeDwtIr.js";import{E as _e,a as he,X as ge,u as S,w as be}from"./xlsx-pGpJNtJ_.js";import{s as fe}from"./index-CTSRqQAW.js";import{u as xe}from"./useModal-vDbn_8lj.js";import"./index-CLKGagE0.js";import"./createLucideIcon-B2WAtkKL.js";import"./PasswordVerificationModal-CwsPs3Zr.js";import"./index-YIqX59W4.js";import"./index-D1-aYu0b.js";import"./sun-g0Zz1s9o.js";import"./index-D-wNi1xB.js";import"./index-Dwzhpvva.js";import"./index-BOMKKwwB.js";import"./index-nqZoyhBR.js";const we={class:"page-wrapper"},De={class:"row g-3"},Fe={class:"col-6 col-md-4"},Pe={class:"card border-0 shadow-sm rounded-4"},Te={class:"card-body d-flex align-items-center justify-content-between"},Ne={class:"mb-0 fw-bold"},Se={class:"col-6 col-md-4"},Ce={class:"card border-0 shadow-sm rounded-4"},$e={class:"card-body d-flex align-items-center justify-content-between"},Ie={class:"mb-0 fw-bold"},ke={class:"col-12 col-md-4"},Oe={class:"card border-0 shadow-sm rounded-4"},Ve={class:"card-body d-flex align-items-center justify-content-between"},Me={class:"mb-0 fw-bold"},Ae={class:"card border-0 shadow-lg rounded-4 mt-3"},Re={class:"card-body"},je={class:"d-flex flex-wrap gap-2 justify-content-between align-items-center mb-3"},Be={class:"d-flex flex-wrap gap-2 align-items-center"},Ee={class:"search-wrap"},Le={key:1,class:"form-control search-input",placeholder:"Search by Order ID",disabled:"",type:"text"},Ue={class:"col-md-6"},ze=["onUpdate:modelValue"],Ge=["value"],He={class:"table-responsive"},We={class:"table table-hover align-middle"},Xe={key:0},qe={class:"text-success"},Ye={class:"text-success"},Qe={class:"text-success"},Ke={class:"text-capitalize"},Je={key:0},Ze={key:0,class:"mt-4 d-flex justify-content-between align-items-center"},et={class:"text-muted small"},tt={__name:"Index",setup(at){const{closeModal:X}=xe(),{formatCurrencySymbol:g,dateFmt:C}=ve(),F=_([]),f=_(!1),$=_({total_payments:0,todays_payments:0,total_amount:0}),c=_({current_page:1,last_page:1,per_page:10,total:0,from:0,to:0,links:[]}),k=_(null),q=[{label:"PDF",value:"pdf"},{label:"Excel",value:"excel"},{label:"CSV",value:"csv"}],Y=a=>{a.value&&(Z(a.value),k.value=null)},N=async(a=null)=>{f.value=!0;try{const e={q:x.value,page:a||c.value.current_page,per_page:c.value.per_page,sort_by:m.value.sortBy||"",payment_type:m.value.paymentType||"",date_from:m.value.dateFrom||"",date_to:m.value.dateTo||"",price_min:m.value.priceMin||"",price_max:m.value.priceMax||""};Object.keys(e).forEach(o=>{(e[o]===void 0||e[o]==="")&&delete e[o]});const s=await axios.get("/api/payments/all",{params:e});F.value=s.data.data.map(o=>{const l=o.order||{};return{id:l.id,customer_name:l.customer_name,promo:l.promo,service_charges:l.service_charges,delivery_charges:l.delivery_charges,tax:l.tax,sub_total:l.sub_total,sales_discount:l.sales_discount,approved_discounts:l.approved_discounts,total_amount:l.total_amount,status:l.status,type:l.type,payment_type:o.payment_type,amount_received:o.amount_received,payment_date:o.payment_date,user:o.user}}),s.data.stats&&($.value=s.data.stats),c.value={current_page:s.data.current_page,last_page:s.data.last_page,per_page:s.data.per_page,total:s.data.total,from:s.data.from,to:s.data.to,links:s.data.links}}catch(e){console.error("Error fetching payments:",e),F.value=[],y.error("Failed to load payments")}finally{f.value=!1}},Q=a=>{if(!a)return;const s=new URLSearchParams(a.split("?")[1]).get("page");s&&N(parseInt(s))};U(async()=>{x.value="",R.value=Date.now(),await oe(),setTimeout(()=>{j.value=!0;const a=document.getElementById(O);a&&(a.value="",x.value="")},100),N()});const x=_(""),R=_(Date.now()),O=`search-${Math.random().toString(36).substr(2,9)}`,j=_(!1),P=_({sortBy:"",paymentType:"",dateFrom:"",dateTo:"",priceMin:null,priceMax:null}),m=_({sortBy:"",paymentType:"",dateFrom:"",dateTo:"",priceMin:null,priceMax:null}),V=T(()=>F.value.map(a=>{const e=Array.isArray(a.promo)&&a.promo.length>0?a.promo[0]:null;return{orderId:a.id,customer:a.customer_name,user:a.user?.name||"—",type:a.payment_type||"—",serviceCharges:Number(a.service_charges||0),deliveryCharges:Number(a.delivery_charges||0),tax:Number(a.tax||0),amountReceived:Number(a.amount_received||0),promoDiscount:e?Number(e.discount_amount||0):0,salesDiscount:Number(a.sales_discount||0),approvedDiscount:Number(a.approved_discounts||0),grandTotal:Number(a.total_amount||0),promoName:e?e.promo_name:"—",paidAt:a.payment_date||null,status:a.status}})),B=T(()=>V.value),K=a=>{P.value={...P.value,...a},m.value={...P.value},c.value.current_page=1,N(1)},J=()=>{P.value={sortBy:"",paymentType:"",dateFrom:"",dateTo:"",priceMin:null,priceMax:null},m.value={sortBy:"",paymentType:"",dateFrom:"",dateTo:"",priceMin:null,priceMax:null},c.value.current_page=1,c.value.per_page=10,N(1),X("paymentFilterModal")},E=T(()=>({sortOptions:[{value:"date_desc",label:"Date: Newest First"},{value:"date_asc",label:"Date: Oldest First"},{value:"amount_desc",label:"Amount: High to Low"},{value:"amount_asc",label:"Amount: Low to High"},{value:"order_asc",label:"Order ID: Low to High"},{value:"order_desc",label:"Order ID: High to Low"}],paymentTypeOptions:[{value:"Cash",label:"Cash"},{value:"Card",label:"Card"},{value:"Split",label:"Split"},{value:"QR",label:"QR"},{value:"Bank",label:"Bank"}]}));T(()=>V.value.length),T(()=>{const a=new Date,e=new Date(a.getFullYear(),a.getMonth(),a.getDate()),s=new Date(a.getFullYear(),a.getMonth(),a.getDate()+1);return F.value.filter(o=>{if(!o.created_at||!o.payment)return!1;const l=new Date(o.created_at);return l>=e&&l<s}).length}),T(()=>V.value.reduce((a,e)=>a+Number(e.grandTotal||0),0)),U(()=>window.feather?.replace()),le(()=>window.feather?.replace());let L=null;ne(x,()=>{clearTimeout(L),L=setTimeout(()=>{c.value.current_page=1,N(1)},500)});const Z=async a=>{if(!F.value||F.value.length===0){y.error("No payment data to download");return}try{f.value=!0;const e={q:x.value,sort_by:m.value.sortBy||"",payment_type:m.value.paymentType||"",date_from:m.value.dateFrom||"",date_to:m.value.dateTo||"",price_min:m.value.priceMin||"",price_max:m.value.priceMax||"",export:"all"};Object.keys(e).forEach(l=>{(e[l]===void 0||e[l]==="")&&delete e[l]});const o=(await axios.get("/api/payments/all",{params:e})).data.data.map(l=>{const d=l.order||{};return{id:d.id,customer_name:d.customer_name,promo:d.promo,service_charges:d.service_charges,delivery_charges:d.delivery_charges,tax:d.tax,sub_total:d.sub_total,sales_discount:d.sales_discount,approved_discounts:d.approved_discounts,total_amount:d.total_amount,status:d.status,type:d.type,payment_type:l.payment_type,amount_received:l.amount_received,payment_date:l.payment_date,user:l.user}});if(o.length===0){y.error("No payments found to download");return}a==="pdf"?te(o):a==="excel"?ae(o):a==="csv"?ee(o):y.error("Invalid download type")}catch(e){console.error("Download failed:",e),y.error(`Download failed: ${e.message}`)}finally{f.value=!1}},ee=a=>{try{const e=["Order ID","Date","Customer","Payment Type","Amount Received","Promo Discount","Sales Discount","Approved Discount","Tax","Service Charges","Delivery Charges","Grand Total","Status"],s=a.map(i=>[`"${i.id||""}"`,`"${C(i.payment_date)}"`,`"${i.customer_name||"Walk In"}"`,`"${i.payment_type||"-"}"`,`"${Number(i.amount_received||0).toFixed(2)}"`,`"${Number(i.promo?.[0]?.discount_amount||0).toFixed(2)}"`,`"${Number(i.sales_discount||0).toFixed(2)}"`,`"${Number(i.approved_discounts||0).toFixed(2)}"`,`"${Number(i.tax||0).toFixed(2)}"`,`"${Number(i.service_charges||0).toFixed(2)}"`,`"${Number(i.delivery_charges||0).toFixed(2)}"`,`"${Number(i.total_amount||0).toFixed(2)}"`,`"${i.status||""}"`]),o=[e.join(","),...s.map(i=>i.join(","))].join(`
`),l=new Blob([o],{type:"text/csv;charset=utf-8;"}),d=URL.createObjectURL(l),b=document.createElement("a");b.setAttribute("href",d),b.setAttribute("download",`Payments_${new Date().toISOString().split("T")[0]}.csv`),document.body.appendChild(b),b.click(),document.body.removeChild(b),y.success("Payments CSV downloaded successfully")}catch(e){console.error("CSV generation error:",e),y.error(`CSV generation failed: ${e.message}`)}},te=a=>{try{const e=new _e("l","mm","a4");e.setFontSize(18),e.setFont("helvetica","bold"),e.text("Payments Report",14,20),e.setFontSize(10),e.setFont("helvetica","normal");const s=new Date().toLocaleString();e.text(`Generated on: ${s}`,14,28),e.text(`Total Payments: ${a.length}`,14,34);const o=a.reduce((u,w)=>u+Number(w.total_amount||0),0),l=a.reduce((u,w)=>u+Number(w.amount_received||0),0);e.text(`Total Revenue: £${o.toFixed(2)}`,14,40),e.text(`Total Received: £${l.toFixed(2)}`,14,46);const d=["Order ID","Date","Customer","Payment Type","Amount Received","Promo Disc.","Sales Disc.","Tax","Grand Total","Status"],b=a.map(u=>[u.id||"",C(u.payment_date),u.customer_name||"Walk In",u.payment_type||"-",`£${Number(u.amount_received||0).toFixed(2)}`,`£${Number(u.promo?.[0]?.discount_amount||0).toFixed(2)}`,`£${Number(u.sales_discount||0).toFixed(2)}`,`£${Number(u.tax||0).toFixed(2)}`,`£${Number(u.total_amount||0).toFixed(2)}`,u.status||""]);he(e,{head:[d],body:b,startY:52,styles:{fontSize:8,cellPadding:2,halign:"left",lineColor:[0,0,0],lineWidth:.1},headStyles:{fillColor:[41,128,185],textColor:255,fontStyle:"bold"},alternateRowStyles:{fillColor:[245,245,245]},margin:{left:14,right:14},didDrawPage:u=>{const w=e.internal.getNumberOfPages(),M=e.internal.pageSize.height;e.setFontSize(8),e.text(`Page ${u.pageNumber} of ${w}`,u.settings.margin.left,M-10)}});const i=`Payments_${new Date().toISOString().split("T")[0]}.pdf`;e.save(i),y.success("Payments PDF downloaded successfully")}catch(e){console.error("PDF generation error:",e),y.error(`PDF generation failed: ${e.message}`)}},ae=a=>{try{if(typeof ge>"u")throw new Error("XLSX library is not loaded");const e=a.map(n=>({"Order ID":n.id||"",Date:C(n.payment_date),Customer:n.customer_name||"Walk In","Order Type":n.type||"-","Payment Type":n.payment_type||"-","Amount Received":Number(n.amount_received||0).toFixed(2),"Promo Name":n.promo?.[0]?.promo_name||"-","Promo Discount":Number(n.promo?.[0]?.discount_amount||0).toFixed(2),"Sales Discount":Number(n.sales_discount||0).toFixed(2),"Approved Discount":Number(n.approved_discounts||0).toFixed(2),Tax:Number(n.tax||0).toFixed(2),"Service Charges":Number(n.service_charges||0).toFixed(2),"Delivery Charges":Number(n.delivery_charges||0).toFixed(2),"Grand Total":Number(n.total_amount||0).toFixed(2),Status:n.status||"",User:n.user?.name||"—"})),s=S.book_new(),o=S.json_to_sheet(e);o["!cols"]=[{wch:10},{wch:12},{wch:20},{wch:12},{wch:12},{wch:15},{wch:20},{wch:15},{wch:15},{wch:15},{wch:10},{wch:15},{wch:15},{wch:12},{wch:10},{wch:15}],S.book_append_sheet(s,o,"Payments");const l=a.reduce((n,D)=>n+Number(D.total_amount||0),0),d=a.reduce((n,D)=>n+Number(D.amount_received||0),0),b=a.reduce((n,D)=>n+Number(D.promo?.[0]?.discount_amount||0),0),i=a.reduce((n,D)=>n+Number(D.sales_discount||0),0),u=[{Info:"Generated On",Value:new Date().toLocaleString()},{Info:"Total Payments",Value:a.length},{Info:"Total Revenue",Value:`£${l.toFixed(2)}`},{Info:"Total Amount Received",Value:`£${d.toFixed(2)}`},{Info:"Total Promo Discounts",Value:`£${b.toFixed(2)}`},{Info:"Total Sales Discounts",Value:`£${i.toFixed(2)}`},{Info:"Exported By",Value:"Payment Management System"}],w=S.json_to_sheet(u);S.book_append_sheet(s,w,"Summary");const M=`Payments_${new Date().toISOString().split("T")[0]}.xlsx`;be(s,M),y.success("Payments Excel file downloaded successfully")}catch(e){console.error("Excel generation error:",e),y.error(`Excel generation failed: ${e.message}`)}};return(a,e)=>(v(),re(pe,null,{default:z(()=>[I(p(ie),{title:"Payment"}),t("div",we,[e[18]||(e[18]=t("h4",{class:"fw-semibold mb-3"},"Overall Payments",-1)),t("div",De,[t("div",Fe,[t("div",Pe,[t("div",Te,[t("div",null,[t("h3",Ne,r($.value.total_payments),1),e[4]||(e[4]=t("p",{class:"text-muted mb-0 small"},"Total Payments",-1))]),e[5]||(e[5]=t("div",{class:"rounded-circle p-3 bg-primary-subtle text-primary d-flex align-items-center justify-content-center",style:{width:"56px",height:"56px"}},[t("i",{class:"bi bi-list-check fs-4"})],-1))])])]),t("div",Se,[t("div",Ce,[t("div",$e,[t("div",null,[t("h3",Ie,r($.value.todays_payments),1),e[6]||(e[6]=t("p",{class:"text-muted mb-0 small"},"Today's Payments",-1))]),e[7]||(e[7]=t("div",{class:"rounded-circle p-3 bg-success-subtle text-success d-flex align-items-center justify-content-center",style:{width:"56px",height:"56px"}},[t("i",{class:"bi bi-calendar-day fs-4"})],-1))])])]),t("div",ke,[t("div",Oe,[t("div",Ve,[t("div",null,[t("h3",Me,r(p(g)($.value.total_amount,"GBP")),1),e[8]||(e[8]=t("p",{class:"text-muted mb-0 small"},"Total Amount",-1))]),e[9]||(e[9]=t("div",{class:"rounded-circle p-3 bg-warning-subtle text-warning d-flex align-items-center justify-content-center",style:{width:"56px",height:"56px"}},[t("i",{class:"bi bi-currency-pound fs-4"})],-1))])])])]),t("div",Ae,[t("div",Re,[t("div",je,[e[14]||(e[14]=t("h5",{class:"mb-0 fw-semibold"},"Payments",-1)),t("div",Be,[t("div",Ee,[e[10]||(e[10]=t("i",{class:"bi bi-search"},null,-1)),e[11]||(e[11]=t("input",{type:"email",name:"email",autocomplete:"email",style:{position:"absolute",left:"-9999px",width:"1px",height:"1px"},tabindex:"-1","aria-hidden":"true"},null,-1)),j.value?H((v(),h("input",{id:O,"onUpdate:modelValue":e[0]||(e[0]=s=>x.value=s),key:R.value,class:"form-control search-input",placeholder:"Search by Order ID",type:"search",autocomplete:"new-password",name:O,role:"presentation",onFocus:e[1]||(e[1]=(...s)=>a.handleFocus&&a.handleFocus(...s))},null,32)),[[ue,x.value]]):(v(),h("input",Le))]),I(ye,{modelValue:P.value,"onUpdate:modelValue":e[2]||(e[2]=s=>P.value=s),title:"Payments","modal-id":"paymentFilterModal","modal-size":"modal-lg","sort-options":E.value.sortOptions,"show-price-range":!0,"show-date-range":!0,"show-stock-status":!1,"price-label":"Amount Range",onApply:K,onClear:J},{customFilters:z(({filters:s})=>[t("div",Ue,[e[13]||(e[13]=t("label",{class:"form-label fw-semibold text-dark"},[t("i",{class:"fas fa-credit-card me-2 text-muted"}),de("Payment Type ")],-1)),H(t("select",{"onUpdate:modelValue":o=>s.paymentType=o,class:"form-select"},[e[12]||(e[12]=t("option",{value:""},"All",-1)),(v(!0),h(A,null,W(E.value.paymentTypeOptions,o=>(v(),h("option",{key:o.value,value:o.value},r(o.label),9,Ge))),128))],8,ze),[[ce,s.paymentType]])])]),_:1},8,["modelValue","sort-options"]),I(p(fe),{modelValue:k.value,"onUpdate:modelValue":e[3]||(e[3]=s=>k.value=s),options:q,optionLabel:"label",optionValue:"value",placeholder:"Export",class:"export-dropdown",onChange:Y},null,8,["modelValue"])])]),t("div",He,[t("table",We,[e[17]||(e[17]=t("thead",{class:"border-top small text-muted"},[t("tr",null,[t("th",null,"S. #"),t("th",null,"Order ID"),t("th",null,"Actual Payment"),t("th",null,"Promo Name"),t("th",null,"Promo Discount"),t("th",null,"Sales Discount"),t("th",null,"Approved Discount"),t("th",null,"Tax"),t("th",null,"Service Charges"),t("th",null,"Delivery Charges"),t("th",null,"Grand Total"),t("th",null,"Payment Date"),t("th",null,"Payment Type")])],-1)),t("tbody",null,[f.value?(v(),h("tr",Xe,[...e[15]||(e[15]=[t("td",{colspan:"11",class:"text-center py-5"},[t("div",{class:"d-flex flex-column align-items-center justify-content-center"},[t("div",{class:"spinner-border mb-3",role:"status",style:{color:"#1B1670",width:"3rem",height:"3rem","border-width":"0.3em"}},[t("span",{class:"visually-hidden"},"Loading...")]),t("div",{class:"fw-semibold text-muted"},"Loading Payments...")])],-1)])])):(v(),h(A,{key:1},[(v(!0),h(A,null,W(B.value,(s,o)=>(v(),h("tr",{key:s.orderId},[t("td",null,r((c.value.current_page-1)*c.value.per_page+o+1),1),t("td",null,r(s.orderId),1),t("td",null,r(p(g)(s.amountReceived)),1),t("td",null,r(s.promoName),1),t("td",qe,r(s.promoDiscount?p(g)(s.promoDiscount):"—"),1),t("td",Ye,r(s.salesDiscount?p(g)(s.salesDiscount):"—"),1),t("td",Qe,r(s.approvedDiscount?p(g)(s.approvedDiscount):"—"),1),t("td",null,r(p(g)(s.tax)),1),t("td",null,r(p(g)(s.serviceCharges)),1),t("td",null,r(p(g)(s.deliveryCharges)),1),t("td",null,r(p(g)(s.grandTotal)),1),t("td",null,r(p(C)(s.paidAt)),1),t("td",Ke,r(s.type),1)]))),128)),!f.value&&B.value.length===0?(v(),h("tr",Je,[...e[16]||(e[16]=[t("td",{colspan:"13",class:"text-center text-muted py-4"}," No payments found. ",-1)])])):G("",!0)],64))])])]),!f.value&&c.value.last_page>1?(v(),h("div",Ze,[t("div",et," Showing "+r(c.value.from)+" to "+r(c.value.to)+" of "+r(c.value.total)+" items ",1),I(me,{pagination:c.value.links,isApiDriven:!0,onPageChanged:Q},null,8,["pagination"])])):G("",!0)])])])]),_:1}))}},ft=se(tt,[["__scopeId","data-v-b45e6b19"]]);export{ft as default};

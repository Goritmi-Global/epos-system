import{_ as Y,r as c,c as J,o as Q,y as O,f as p,b as f,d as A,e as t,u as T,h as Z,m as $,k as B,v as R,l as L,F as S,g as ee,t as y,C as te,S as le,U as ae,i as oe,p as k,n as se,q as o}from"./app-baHdzX7S.js";import{E as re,a as ne,X as ie,u as D,w as de}from"./xlsx-B334sDKe.js";import{I as ce}from"./importFile-BFleLEav.js";import{P as ue}from"./plus-Dx5WLWdx.js";import{P as me}from"./pencil-sD43XpLj.js";import"./createLucideIcon-TbLSe6i2.js";const ge={class:"card border-0 shadow-lg rounded-4"},pe={class:"card-body"},fe={class:"d-flex flex-wrap gap-2 justify-content-between align-items-center mb-3"},ve={class:"d-flex gap-2"},ye={class:"search-wrap"},he={class:"dropdown"},we={class:"dropdown-menu dropdown-menu-end shadow rounded-4 py-2"},be={class:"table-responsive"},_e={class:"table table-hover"},xe={key:0},Ae={class:"fw-semibold"},Ce={class:"text-center"},Se={class:"d-inline-flex align-items-center gap-3"},ke=["onClick"],De={key:0},Ee={colspan:"3",class:"text-center text-muted py-4"},Fe={key:0,class:"mt-4 d-flex justify-content-between align-items-center"},Ne={class:"text-muted small"},Pe={class:"modal fade",id:"modalAllergyForm",tabindex:"-1","aria-hidden":"true"},Ie={class:"modal-dialog modal-lg modal-dialog-centered"},Te={class:"modal-content rounded-4"},$e={class:"modal-header"},Le={class:"modal-title"},je={class:"modal-body"},Ve={key:0,class:"text-danger"},Me={class:"col-md-2"},Oe=["disabled"],Be={__name:"AllergiesTab",setup(Re){const v=c(""),C=c(!1),F=c(null),w=c(""),N=()=>{v.value="",i.value={}},P=J(()=>{const l=w.value.trim().toLowerCase();return l?n.value.filter(e=>e.name.toLowerCase().includes(l)):n.value}),U=()=>{C.value=!1,v.value=""},z=l=>{C.value=!0,F.value=l,v.value=l.name},X=async l=>{try{await k.delete(`/allergies/${l.id}`),n.value=n.value.filter(e=>e.id!==l.id),o.success("Allergy deleted successfully"),await _()}catch(e){o.error("Delete failed"),console.error(e)}},b=c(!1),j=async()=>{if(!b.value){if(!v.value.trim()){o.error("Please enter an allergy name"),i.value={customAllergy:["Please enter an allergy name"]};return}if(C.value)try{b.value=!0;const{data:l}=await k.put(`/allergies/${F.value.id}`,{name:v.value.trim()}),e=n.value.findIndex(a=>a.id===F.value.id);e!==-1&&(n.value[e]=l),o.success("Allergy updated successfully"),await _(),N(),V("modalAllergyForm")}catch(l){l.response?.data?.errors?(i.value={},Object.entries(l.response.data.errors).forEach(([e,a])=>{a.forEach(r=>o.error(r)),i.value={customAllergy:a}})):o.error("Update failed")}finally{b.value=!1}else{const l=v.value.trim();if(n.value.some(a=>a.name.toLowerCase()===l.toLowerCase())){o.error(`Allergy "${l}" already exists`),i.value={customAllergy:["This allergy already exists"]};return}try{b.value=!0;const a=await k.post("/allergies",{allergies:[{name:l}]}),r=a.data?.allergies??a.data;Array.isArray(r)&&r.length&&(n.value=[...n.value,...r]),o.success("Allergy added successfully"),N(),V("modalAllergyForm"),await _()}catch(a){a.response?.data?.errors?Object.values(a.response.data.errors).forEach(r=>r.forEach(m=>o.error(m))):(console.error(a),o.error("Create failed"))}finally{b.value=!1}}}},V=l=>{const e=document.getElementById(l);if(!e)return;(window.bootstrap?.Modal.getInstance(e)||new window.bootstrap.Modal(e)).hide()},n=c([]),u=c({current_page:1,last_page:1,per_page:15,total:0,from:0,to:0,links:[]});c(1),c(15);const E=c(!1),i=c({}),_=async(l=null)=>{E.value=!0;try{const{data:e}=await k.get("/allergies",{params:{q:w.value,page:l||u.value.current_page,per_page:u.value.per_page}});n.value=e.data||[],u.value={current_page:e.current_page,last_page:e.last_page,per_page:e.per_page,total:e.total,from:e.from,to:e.to,links:e.links},await se(),window.feather?.replace()}catch(e){console.error("Failed to fetch allergies",e),o.error("Failed to load allergies")}finally{E.value=!1}},q=l=>{if(!l)return;const a=new URLSearchParams(l.split("?")[1]).get("page");a&&_(parseInt(a))},I=l=>{if(!n.value||n.value.length===0){o.error("No Allergies data to download");return}const e=w.value.trim()?P.value:n.value;if(e.length===0){o.error("No Allergies found to download");return}try{l==="pdf"?H(e):l==="excel"?K(e):l==="csv"?G(e):o.error("Invalid download type")}catch(a){console.error("Download failed:",a),o.error(`Download failed: ${a.message}`)}},G=l=>{try{const e=["Name"],a=l.map(g=>[`"${g.name||""}"`]),r=[e.join(","),...a.map(g=>g.join(","))].join(`
`),m=new Blob([r],{type:"text/csv;charset=utf-8;"}),h=URL.createObjectURL(m),d=document.createElement("a");d.setAttribute("href",h),d.setAttribute("download",`allergies_${new Date().toISOString().split("T")[0]}.csv`),document.body.appendChild(d),d.click(),document.body.removeChild(d),o.success("CSV downloaded successfully",{autoClose:2500})}catch(e){console.error("CSV generation error:",e),o.error(`CSV generation failed: ${e.message}`,{autoClose:5e3})}},H=l=>{try{const e=new re("p","mm","a4");e.setFont("helvetica","bold"),e.setFontSize(18),e.text("Allergies Report",70,20),e.setFont("helvetica","normal"),e.setFontSize(10);const a=new Date().toLocaleString();e.text(`Generated on: ${a}`,14,30),e.text(`Total Allergies: ${l.length}`,14,36);const r=["Name"],m=l.map(d=>[d.name||""]);ne(e,{head:[r],body:m,startY:45,styles:{fontSize:10,cellPadding:3,halign:"left",valign:"middle",lineColor:[220,220,220],lineWidth:.1},headStyles:{fillColor:[41,128,185],textColor:255,fontStyle:"bold"},alternateRowStyles:{fillColor:[245,245,245]},margin:{left:14,right:14},didDrawPage:d=>{const g=e.internal.getNumberOfPages(),s=e.internal.pageSize.height;e.setFontSize(8),e.text(`Page ${d.pageNumber} of ${g}`,14,s-10)}});const h=`allergies_${new Date().toISOString().split("T")[0]}.pdf`;e.save(h),o.success("PDF downloaded successfully",{autoClose:2500})}catch(e){console.error("PDF generation error:",e),o.error(`PDF generation failed: ${e.message}`,{autoClose:5e3})}},K=l=>{try{if(typeof ie>"u")throw new Error("XLSX library is not loaded");const e=l.map(g=>({Name:g.name||""})),a=D.book_new(),r=D.json_to_sheet(e);r["!cols"]=[{wch:25}],D.book_append_sheet(a,r,"Allergies");const m=[{Info:"Generated On",Value:new Date().toLocaleString()},{Info:"Total Records",Value:l.length},{Info:"Exported By",Value:"Allergies Management System"}],h=D.json_to_sheet(m);D.book_append_sheet(a,h,"Report Info");const d=`allergies_${new Date().toISOString().split("T")[0]}.xlsx`;de(a,d),o.success("Excel file downloaded successfully",{autoClose:2500})}catch(e){console.error("Excel generation error:",e),o.error(`Excel generation failed: ${e.message}`,{autoClose:5e3})}};Q(async()=>{await _(),window.feather?.replace()}),O(v,l=>{l&&i.value.customAllergy&&delete i.value.customAllergy});let M=null;O(w,()=>{clearTimeout(M),M=setTimeout(()=>{u.value.current_page=1,_(1)},500)});const W=l=>{if(!Array.isArray(l)||l.length===0){o.error("File is empty.");return}l[0];const a=l.slice(1).filter(s=>Array.isArray(s)&&s.some(x=>String(x??"").trim()!==""));if(a.length===0){o.error("No data rows found the file is empty or contains only headers.");return}const r=a.map(s=>({name:String(s[0]??"").trim()})).filter(s=>s.name!=="");if(r.length===0){o.error("No valid allergy names found in the file.");return}const m=r.map(s=>s.name.toLowerCase()),h=m.filter((s,x)=>m.indexOf(s)!==x);if(h.length){const s=[...new Set(h)];o.error(`Duplicate entries found in file: ${s.join(", ")}`);return}const d=n.value.map(s=>s.name.toLowerCase()),g=r.filter(s=>d.includes(s.name.toLowerCase()));if(g.length>0){const s=g.map(x=>x.name).join(", ");o.error(`These allergies already exist in the database: ${s}`);return}k.post("/api/allergies/import",{allergies:r}).then(()=>{o.success("Allergies imported successfully"),_()}).catch(s=>{if(s?.response?.status===422&&s.response.data?.errors){i.value=s.response.data.errors;const x=s.response.data.message||"There may be duplication or validation errors in the data.";o.error(x,{autoClose:3e3})}else o.error("Import failed. Please try again.",{autoClose:3e3}),console.error(s)})};return(l,e)=>(f(),p(S,null,[A(T(Z),{title:"Allergy"}),t("div",ge,[t("div",pe,[t("div",fe,[e[9]||(e[9]=t("h4",{class:"mb-0"},"Allergies",-1)),t("div",ve,[t("div",ye,[e[6]||(e[6]=t("i",{class:"bi bi-search"},null,-1)),B(t("input",{"onUpdate:modelValue":e[0]||(e[0]=a=>w.value=a),class:"form-control search-input",placeholder:"Search"},null,512),[[R,w.value]])]),t("button",{"data-bs-toggle":"modal","data-bs-target":"#modalAllergyForm",onClick:e[1]||(e[1]=()=>{U(),N(),i.value={}}),class:"d-flex align-items-center gap-1 btn-sm px-4 py-2 rounded-pill btn btn-primary text-white"},[A(T(ue),{class:"w-4 h-4"}),e[7]||(e[7]=L(" Add Allergy ",-1))]),A(ce,{label:"Import",sampleHeaders:["Name"],sampleData:[["Milk"],["Peanuts"],["Gluten"]],onOnImport:W}),t("div",he,[e[8]||(e[8]=t("button",{class:"btn btn-outline-secondary btn-sm rounded-pill py-2 px-4 dropdown-toggle","data-bs-toggle":"dropdown"}," Export ",-1)),t("ul",we,[t("li",null,[t("a",{class:"dropdown-item py-2",href:"javascript:;",onClick:e[2]||(e[2]=a=>I("pdf"))},"Export as PDF")]),t("li",null,[t("a",{class:"dropdown-item py-2",href:"javascript:;",onClick:e[3]||(e[3]=a=>I("excel"))},"Export as Excel")]),t("li",null,[t("a",{class:"dropdown-item py-2",href:"javascript:;",onClick:e[4]||(e[4]=a=>I("csv"))},"Export as CSV")])])])])]),t("div",be,[t("table",_e,[e[11]||(e[11]=t("thead",{class:"border-top small text-muted"},[t("tr",null,[t("th",null,"S. #"),t("th",null,"Allergy Name"),t("th",{class:"text-center"},"Action")])],-1)),t("tbody",null,[E.value?(f(),p("tr",xe,[...e[10]||(e[10]=[t("td",{colspan:"3",class:"text-center py-5"},[t("div",{class:"spinner-border text-primary",role:"status"},[t("span",{class:"visually-hidden"},"Loading...")]),t("p",{class:"text-muted mt-2 mb-0"},"Loading allergies...")],-1)])])):(f(),p(S,{key:1},[(f(!0),p(S,null,ee(P.value,(a,r)=>(f(),p("tr",{key:a.id},[t("td",null,y(u.value.from+r),1),t("td",Ae,y(a.name),1),t("td",Ce,[t("div",Se,[t("button",{"data-bs-toggle":"modal","data-bs-target":"#modalAllergyForm",onClick:()=>{z(a),i.value={}},title:"Edit",class:"p-2 rounded-full text-blue-600 hover:bg-blue-100"},[A(T(me),{class:"w-4 h-4"})],8,ke),A(te,{title:"Confirm Delete",message:`Are you sure you want to delete ${a.name}?`,showDeleteButton:!0,onConfirm:()=>{X(a)},onCancel:()=>{}},null,8,["message","onConfirm"])])])]))),128)),P.value.length===0?(f(),p("tr",De,[t("td",Ee,y(w.value.trim()?"No allergies found matching your search.":"No allergies found."),1)])):$("",!0)],64))])])]),!E.value&&u.value.last_page>1?(f(),p("div",Fe,[t("div",Ne," Showing "+y(u.value.from)+" to "+y(u.value.to)+" of "+y(u.value.total)+" entries ",1),A(le,{pagination:u.value.links,isApiDriven:!0,onPageChanged:q},null,8,["pagination"])])):$("",!0)])]),t("div",Pe,[t("div",Ie,[t("div",Te,[t("div",$e,[t("h5",Le,y(C.value?"Edit Allergy":"Add Allergy(s)"),1),e[12]||(e[12]=t("button",{class:"absolute top-2 right-2 p-2 rounded-full hover:bg-gray-100 transition transform hover:scale-110","data-bs-dismiss":"modal","aria-label":"Close",title:"Close"},[t("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-6 w-6 text-red-500",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor","stroke-width":"2"},[t("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M6 18L18 6M6 6l12 12"})])],-1))]),t("div",je,[t("div",null,[e[13]||(e[13]=t("label",{class:"form-label"},"Allergy Name",-1)),B(t("input",{"onUpdate:modelValue":e[5]||(e[5]=a=>v.value=a),class:oe(["form-control",{"is-invalid":i.value.customAllergy}]),placeholder:"e.g., Vegan",onKeyup:ae(j,["enter"])},null,34),[[R,v.value]]),i.value.customAllergy?(f(),p("span",Ve,y(i.value.customAllergy[0]),1)):$("",!0)]),t("div",Me,[t("button",{class:"btn btn-primary rounded-pill py-2 btn-sm w-100 mt-4",disabled:b.value,onClick:j},[b.value?(f(),p(S,{key:0},[e[14]||(e[14]=t("span",{class:"spinner-border spinner-border-sm me-2"},null,-1)),e[15]||(e[15]=L(" Saving... ",-1))],64)):(f(),p(S,{key:1},[L(y((C.value,"Save")),1)],64))],8,Oe)])])])])])],64))}},Ke=Y(Be,[["__scopeId","data-v-640170c8"]]);export{Ke as default};

import{_ as te,r as c,c as le,o as ae,w as R,g as f,b as v,e as C,f as l,u as F,h as oe,l as N,m as U,v as B,p as T,F as E,i as se,t as w,C as re,P as ne,U as ie,j as de,q as S,n as ce,s as o}from"./app-8IuynfNs.js";import{E as ue,a as me,X as ge,u as D,w as pe}from"./xlsx-BnIfDSd0.js";import{I as fe}from"./importFile-C2bQz6WC.js";import{s as ve}from"./index-Cu2K41uh.js";import{P as ye}from"./plus-NuSuYcsm.js";import{P as he}from"./pencil-B8UGC7Qe.js";import"./index-baplSocH.js";import"./index-T3VCF_Yp.js";import"./index-qUyqoe8i.js";import"./index-B4GukRYa.js";import"./index-KmCVkqca.js";import"./createLucideIcon-CHSKluew.js";const be={class:"card border-0 shadow-lg rounded-4"},we={class:"card-body"},xe={class:"d-flex flex-wrap gap-2 justify-content-between align-items-center mb-3"},_e={class:"d-flex gap-2"},Ae={class:"search-wrap"},Ce={class:"table-responsive"},Se={class:"table table-hover"},ke={key:0},Ee={class:"fw-semibold"},De={class:"text-center"},Fe={class:"d-inline-flex align-items-center gap-3"},Pe=["onClick"],Le={key:0},$e={colspan:"3",class:"text-center text-muted py-4"},Ie={key:0,class:"mt-4 d-flex justify-content-between align-items-center"},Ne={class:"text-muted small"},Te={class:"modal fade",id:"modalAllergyForm",tabindex:"-1","aria-hidden":"true"},Ve={class:"modal-dialog modal-lg modal-dialog-centered"},je={class:"modal-content rounded-4"},Me={class:"modal-header"},Oe={class:"modal-title"},Re={class:"modal-body"},Ue={key:0,class:"text-danger"},Be={class:"col-md-2"},qe=["disabled"],ze={__name:"AllergiesTab",setup(Xe){const y=c(""),k=c(!1),P=c(null),x=c(""),L=c(null),q=[{label:"PDF",value:"pdf"},{label:"Excel",value:"excel"},{label:"CSV",value:"csv"}],z=t=>{t.value&&(Y(t.value),L.value=null)},$=()=>{y.value="",n.value={}},V=le(()=>{const t=x.value.trim().toLowerCase();return t?u.value.filter(e=>e.name.toLowerCase().includes(t)):u.value}),X=()=>{k.value=!1,y.value=""},G=t=>{k.value=!0,P.value=t,y.value=t.name},H=async t=>{try{await S.delete(`/allergies/${t.id}`),u.value=u.value.filter(e=>e.id!==t.id),o.success("Allergy deleted successfully"),await A()}catch(e){o.error("Delete failed"),console.error(e)}},_=c(!1),j=async()=>{if(!_.value){if(!y.value.trim()){o.error("Please enter an allergy name"),n.value={customAllergy:["Please enter an allergy name"]};return}if(k.value)try{_.value=!0;const{data:t}=await S.put(`/allergies/${P.value.id}`,{name:y.value.trim()}),e=u.value.findIndex(a=>a.id===P.value.id);e!==-1&&(u.value[e]=t),o.success("Allergy updated successfully"),await A(),$(),M("modalAllergyForm")}catch(t){t.response?.data?.errors?(n.value={},Object.entries(t.response.data.errors).forEach(([e,a])=>{a.forEach(r=>o.error(r)),n.value={customAllergy:a}})):o.error("Update failed")}finally{_.value=!1}else{const t=y.value.trim();if(u.value.some(a=>a.name.toLowerCase()===t.toLowerCase())){o.error(`Allergy "${t}" already exists`),n.value={customAllergy:["This allergy already exists"]};return}try{_.value=!0;const a=await S.post("/allergies",{allergies:[{name:t}]}),r=a.data?.allergies??a.data;Array.isArray(r)&&r.length&&(u.value=[...u.value,...r]),o.success("Allergy added successfully"),$(),M("modalAllergyForm"),await A()}catch(a){a.response?.data?.errors?Object.values(a.response.data.errors).forEach(r=>r.forEach(g=>o.error(g))):(console.error(a),o.error("Create failed"))}finally{_.value=!1}}}},M=t=>{const e=document.getElementById(t);if(!e)return;(window.bootstrap?.Modal.getInstance(e)||new window.bootstrap.Modal(e)).hide()},u=c([]),m=c({current_page:1,last_page:1,per_page:10,total:0,from:0,to:0,links:[]});c(1),c(15);const h=c(!1),n=c({}),A=async(t=null)=>{h.value=!0;try{const{data:e}=await S.get("/allergies",{params:{q:x.value,page:t||m.value.current_page,per_page:m.value.per_page}});u.value=e.data||[],m.value={current_page:e.current_page,last_page:e.last_page,per_page:e.per_page,total:e.total,from:e.from,to:e.to,links:e.links},await ce(),window.feather?.replace()}catch(e){console.error("Failed to fetch allergies",e),o.error("Failed to load allergies")}finally{h.value=!1}},K=t=>{if(!t)return;const a=new URLSearchParams(t.split("?")[1]).get("page");a&&A(parseInt(a))},W=async()=>{try{h.value=!0;const t=await S.get("/allergies",{params:{q:x.value.trim(),per_page:1e4,page:1}});return console.log("ðŸ“¦ Export data received:",{total:t.data.total,items:t.data.data.length}),t.data.data||[]}catch(t){return console.error("âŒ Error fetching export data:",t),o.error("Failed to load data for export"),[]}finally{h.value=!1}},Y=async t=>{try{h.value=!0,o.info("Preparing export data...",{autoClose:1500});const e=await W();if(!e||e.length===0){o.error("No allergies found to download"),h.value=!1;return}console.log(`ðŸ“¥ Exporting ${e.length} allergies as ${t.toUpperCase()}`),t==="pdf"?Q(e):t==="excel"?Z(e):t==="csv"?J(e):o.error("Invalid download type")}catch(e){console.error("Download failed:",e),o.error(`Download failed: ${e.message}`)}finally{h.value=!1}},J=t=>{try{const e=["Name"],a=t.map(p=>[`"${p.name||""}"`]),r=[e.join(","),...a.map(p=>p.join(","))].join(`
`),g=new Blob([r],{type:"text/csv;charset=utf-8;"}),b=URL.createObjectURL(g),i=document.createElement("a");i.setAttribute("href",b),i.setAttribute("download",`allergies_${new Date().toISOString().split("T")[0]}.csv`),document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(b),o.success(`CSV downloaded successfully (${t.length} allergies)`,{autoClose:2500})}catch(e){console.error("CSV generation error:",e),o.error(`CSV generation failed: ${e.message}`,{autoClose:5e3})}},Q=t=>{try{const e=new ue("p","mm","a4");e.setFont("helvetica","bold"),e.setFontSize(18),e.text("Allergies Report",70,20),e.setFont("helvetica","normal"),e.setFontSize(10);const a=new Date().toLocaleString();e.text(`Generated on: ${a}`,14,30),e.text(`Total Allergies: ${t.length}`,14,36);const r=["Name"],g=t.map(i=>[i.name||""]);me(e,{head:[r],body:g,startY:45,styles:{fontSize:10,cellPadding:3,halign:"left",valign:"middle",lineColor:[220,220,220],lineWidth:.1},headStyles:{fillColor:[41,128,185],textColor:255,fontStyle:"bold"},alternateRowStyles:{fillColor:[245,245,245]},margin:{left:14,right:14},didDrawPage:i=>{const p=e.internal.getNumberOfPages(),s=e.internal.pageSize.height;e.setFontSize(8),e.text(`Page ${i.pageNumber} of ${p}`,14,s-10)}});const b=`allergies_${new Date().toISOString().split("T")[0]}.pdf`;e.save(b),o.success(`PDF downloaded successfully (${t.length} allergies)`,{autoClose:2500})}catch(e){console.error("PDF generation error:",e),o.error(`PDF generation failed: ${e.message}`,{autoClose:5e3})}},Z=t=>{try{if(typeof ge>"u")throw new Error("XLSX library is not loaded");const e=t.map(p=>({Name:p.name||""})),a=D.book_new(),r=D.json_to_sheet(e);r["!cols"]=[{wch:25}],D.book_append_sheet(a,r,"Allergies");const g=[{Info:"Generated On",Value:new Date().toLocaleString()},{Info:"Total Records",Value:t.length},{Info:"Exported By",Value:"Allergies Management System"}],b=D.json_to_sheet(g);D.book_append_sheet(a,b,"Report Info");const i=`allergies_${new Date().toISOString().split("T")[0]}.xlsx`;pe(a,i),o.success(`Excel file downloaded successfully (${t.length} allergies)`,{autoClose:2500})}catch(e){console.error("Excel generation error:",e),o.error(`Excel generation failed: ${e.message}`,{autoClose:5e3})}};ae(async()=>{await A(),window.feather?.replace()}),R(y,t=>{t&&n.value.customAllergy&&delete n.value.customAllergy});let O=null;R(x,()=>{clearTimeout(O),O=setTimeout(()=>{m.value.current_page=1,A(1)},500)});const ee=t=>{if(!Array.isArray(t)||t.length===0){o.error("File is empty.");return}t[0];const a=t.slice(1).filter(s=>Array.isArray(s)&&s.some(d=>String(d??"").trim()!==""));if(a.length===0){o.error("No data rows found the file is empty or contains only headers.");return}const r=a.map(s=>({name:String(s[0]??"").trim()})).filter(s=>s.name!=="");if(r.length===0){o.error("No valid allergy names found in the file.");return}const g=r.map(s=>s.name.toLowerCase()),b=g.filter((s,d)=>g.indexOf(s)!==d);if(b.length){const s=[...new Set(b)];o.error(`Duplicate entries found in file: ${s.join(", ")}`);return}const i=u.value.map(s=>s.name.toLowerCase()),p=r.filter(s=>i.includes(s.name.toLowerCase()));if(p.length>0){const s=p.map(d=>d.name).join(", ");o.error(`These allergies already exist in the database: ${s}`);return}S.post("/api/allergies/import",{allergies:r}).then(()=>{o.success("Allergies imported successfully");const s=document.querySelector(".modal.show");if(s){const d=bootstrap.Modal.getInstance(s);d&&d.hide()}setTimeout(()=>{document.querySelectorAll(".modal-backdrop").forEach(I=>I.remove()),document.body.classList.remove("modal-open"),document.body.style.overflow="",document.body.style.paddingRight=""},100),A()}).catch(s=>{if(s?.response?.status===422&&s.response.data?.errors){n.value=s.response.data.errors;const d=s.response.data.message||"There may be duplication or validation errors in the data.";o.error(d,{autoClose:3e3})}else o.error("Import failed. Please try again.",{autoClose:3e3}),console.error(s);setTimeout(()=>{document.querySelectorAll(".modal-backdrop").forEach(I=>I.remove()),document.body.classList.remove("modal-open"),document.body.style.overflow="",document.body.style.paddingRight=""},100)})};return(t,e)=>(v(),f(E,null,[C(F(oe),{title:"Allergy"}),l("div",be,[l("div",we,[l("div",xe,[e[6]||(e[6]=l("h4",{class:"mb-0"},"Allergies",-1)),l("div",_e,[l("div",Ae,[e[4]||(e[4]=l("i",{class:"bi bi-search"},null,-1)),U(l("input",{"onUpdate:modelValue":e[0]||(e[0]=a=>x.value=a),class:"form-control search-input",placeholder:"Search"},null,512),[[B,x.value]])]),l("button",{"data-bs-toggle":"modal","data-bs-target":"#modalAllergyForm",onClick:e[1]||(e[1]=()=>{X(),$(),n.value={}}),class:"d-flex align-items-center gap-1 btn-sm px-4 py-2 rounded-pill btn btn-primary text-white"},[C(F(ye),{class:"w-4 h-4"}),e[5]||(e[5]=T(" Add Allergy ",-1))]),C(fe,{label:"Import",sampleHeaders:["Name"],sampleData:[["Milk"],["Peanuts"],["Gluten"]],onOnImport:ee}),C(F(ve),{modelValue:L.value,"onUpdate:modelValue":e[2]||(e[2]=a=>L.value=a),options:q,optionLabel:"label",optionValue:"value",placeholder:"Export",class:"export-dropdown",onChange:z},null,8,["modelValue"])])]),l("div",Ce,[l("table",Se,[e[8]||(e[8]=l("thead",{class:"border-top small text-muted"},[l("tr",null,[l("th",null,"S. #"),l("th",null,"Allergy Name"),l("th",{class:"text-center"},"Action")])],-1)),l("tbody",null,[h.value?(v(),f("tr",ke,[...e[7]||(e[7]=[l("td",{colspan:"3",class:"text-center py-5"},[l("div",{class:"spinner-border text-primary",role:"status"},[l("span",{class:"visually-hidden"},"Loading...")]),l("p",{class:"text-muted mt-2 mb-0"},"Loading allergies...")],-1)])])):(v(),f(E,{key:1},[(v(!0),f(E,null,se(V.value,(a,r)=>(v(),f("tr",{key:a.id},[l("td",null,w(m.value.from+r),1),l("td",Ee,w(a.name),1),l("td",De,[l("div",Fe,[l("button",{"data-bs-toggle":"modal","data-bs-target":"#modalAllergyForm",onClick:()=>{G(a),n.value={}},title:"Edit",class:"p-2 rounded-full text-blue-600 hover:bg-blue-100"},[C(F(he),{class:"w-4 h-4"})],8,Pe),C(re,{title:"Confirm Delete",message:`Are you sure you want to delete ${a.name}?`,showDeleteButton:!0,onConfirm:()=>{H(a)},onCancel:()=>{}},null,8,["message","onConfirm"])])])]))),128)),V.value.length===0?(v(),f("tr",Le,[l("td",$e,w(x.value.trim()?"No allergies found matching your search.":"No allergies found."),1)])):N("",!0)],64))])])]),!h.value&&m.value.last_page>1?(v(),f("div",Ie,[l("div",Ne," Showing "+w(m.value.from)+" to "+w(m.value.to)+" of "+w(m.value.total)+" entries ",1),C(ne,{pagination:m.value.links,isApiDriven:!0,onPageChanged:K},null,8,["pagination"])])):N("",!0)])]),l("div",Te,[l("div",Ve,[l("div",je,[l("div",Me,[l("h5",Oe,w(k.value?"Edit Allergy":"Add Allergy(s)"),1),e[9]||(e[9]=l("button",{class:"absolute top-2 right-2 p-2 rounded-full hover:bg-gray-100 transition transform hover:scale-110","data-bs-dismiss":"modal","aria-label":"Close",title:"Close"},[l("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-6 w-6 text-red-500",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor","stroke-width":"2"},[l("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M6 18L18 6M6 6l12 12"})])],-1))]),l("div",Re,[l("div",null,[e[10]||(e[10]=l("label",{class:"form-label"},"Allergy Name",-1)),U(l("input",{"onUpdate:modelValue":e[3]||(e[3]=a=>y.value=a),class:de(["form-control",{"is-invalid":n.value.customAllergy}]),placeholder:"e.g., Vegan",onKeyup:ie(j,["enter"])},null,34),[[B,y.value]]),n.value.customAllergy?(v(),f("span",Ue,w(n.value.customAllergy[0]),1)):N("",!0)]),l("div",Be,[l("button",{class:"btn btn-primary rounded-pill py-2 btn-sm w-100 mt-4",disabled:_.value,onClick:j},[_.value?(v(),f(E,{key:0},[e[11]||(e[11]=l("span",{class:"spinner-border spinner-border-sm me-2"},null,-1)),e[12]||(e[12]=T(" Saving... ",-1))],64)):(v(),f(E,{key:1},[T(w((k.value,"Save")),1)],64))],8,qe)])])])])])],64))}},ot=te(ze,[["__scopeId","data-v-e87ddb41"]]);export{ot as default};

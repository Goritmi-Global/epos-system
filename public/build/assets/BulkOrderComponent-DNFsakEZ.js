import{_ as se,r as g,w as O,o as re,Y as J,c as $,E as ie,g as i,b as u,f as l,D as ue,l as _,j as f,e as T,d as Z,t as a,u as U,F as x,i as D,m as w,v as M,T as A,s as k}from"./app-CYYlfszq.js";import{s as ae}from"./index-BzmJYhwS.js";import{u as de}from"./useFormatters-RJKnQoSm.js";import"./index-DJNrC0mS.js";import"./index-Dz-aUUP8.js";import"./index-B3Pqd2wp.js";import"./index-BxpxhNZZ.js";import"./index-BuSNz9fi.js";const ce={class:"modal fade",id:"bulkOrderModal",tabindex:"-1","aria-hidden":"true"},pe={class:"modal-dialog modal-xl modal-dialog-centered"},ve={class:"modal-content rounded-4"},me={class:"modal-body"},_e={class:"nav nav-tabs mb-4",role:"tablist"},ye={class:"nav-item",role:"presentation"},fe={class:"nav-item",role:"presentation"},be={key:0},he={class:"mb-3"},ge={key:0},ke={key:1},Pe={key:0,class:"text-danger"},Ie={class:"table-responsive"},Ue={class:"table align-middle"},we=["onUpdate:modelValue","onInput"],qe={key:0,class:"text-danger"},xe=["onUpdate:modelValue","onChange","onFocus"],De={value:null},Se=["value"],Ve=["onUpdate:modelValue","onInput"],Ce={key:0,class:"text-danger"},Ne={key:0,class:"text-danger"},Ee=["onClick"],Me={class:"text-end fw-bold mt-3"},Fe={key:1},Be={class:"table-responsive"},Oe={class:"table align-middle"},$e=["onUpdate:modelValue"],Te=["value"],Ae={key:0,class:"text-danger d-block"},Le=["onUpdate:modelValue","onInput"],je={key:0,class:"text-danger"},Re=["onUpdate:modelValue","onChange","onFocus"],ze={value:null},Qe=["value"],Je=["onUpdate:modelValue","onInput"],Ze={key:0,class:"text-danger"},Ye={key:0,class:"text-danger"},Ge=["onClick"],He={class:"text-end fw-bold mt-3"},Ke={class:"modal-footer"},We=["disabled"],Xe={key:0},et={key:1},tt=["disabled"],lt={key:0},nt={key:1},ot={__name:"BulkOrderComponent",props:{suppliers:{type:Array,default:()=>[]},items:{type:Array,default:()=>[]}},emits:["refresh-data"],setup(S,{emit:Y}){const{formatCurrencySymbol:V,dateFmt:L}=de(),C=S,F=g({}),j=Y,y=g("single"),b=g(null),N=g(!1),d=g({}),c=g([]),E=g(!1),h=g({}),v=g([]);O(()=>C.items,e=>{c.value=e.map(n=>({...n,qty:0,unitPrice:0,expiry:null,subtotal:0,selected_derived_unit_id:null,selectedDerivedUnitInfo:null,derived_units:[]}))},{immediate:!0}),O(b,e=>{c.value.forEach(n=>{n.preferred_supplier_id!==e&&n.supplier_id!==e&&(n.qty=0,n.unitPrice=0,n.expiry=null,n.subtotal=0,n.selected_derived_unit_id=null,n.selectedDerivedUnitInfo=null)})}),O(()=>C.items,e=>{v.value=e.map(n=>({...n,qty:0,unitPrice:0,expiry:null,subtotal:0,supplier_id:n.preferred_supplier_id||n.supplier_id||null,selected_derived_unit_id:null,selectedDerivedUnitInfo:null,derived_units:[]}))},{immediate:!0}),re(()=>{console.log("Props items:",J(C.items)),console.log("First item structure:",J(C.items[0])),feather.replace();const e=document.getElementById("bulkOrderModal");e&&(e.addEventListener("show.bs.modal",()=>{y.value="single"}),e.addEventListener("hide.bs.modal",()=>{y.value="single"}),e.addEventListener("hidden.bs.modal",()=>{document.body.classList.remove("modal-open"),document.body.style.overflow="",document.querySelectorAll(".modal-backdrop").forEach(r=>r.remove())}))});function B(e){let n=Number(e.qty)||0;const r=Number(e.unitPrice)||0;e.selected_derived_unit_id&&e.selectedDerivedUnitInfo&&(Number(e.selectedDerivedUnitInfo.conversion_factor),n=n),e.subtotal=n*r}function G(e){let n=Number(e.qty)||0;const r=Number(e.unitPrice)||0;e.selected_derived_unit_id&&e.selectedDerivedUnitInfo&&(Number(e.selectedDerivedUnitInfo.conversion_factor),n=n),e.subtotal=n*r}function R(e){e.qty<0&&(e.qty=0),B(e)}function z(e){if(e.unitPrice===null||e.unitPrice===void 0||e.unitPrice===""){e.unitPrice="",e.subtotal=0;return}e.unitPrice<0&&(e.unitPrice=0),B(e)}const H=$(()=>b.value?c.value.filter(e=>{const n=o=>o==null?"":String(o).trim(),r=n(e.preferred_supplier_id??e.preferredSupplierId),t=n(e.supplier_id??e.supplierId),s=n(b.value);return r===s||t===s}):c.value);function K(e){c.value[e].qty=0,c.value[e].unitPrice=0,c.value[e].expiry=null,c.value[e].subtotal=0,c.value[e].selected_derived_unit_id=null,c.value[e].selectedDerivedUnitInfo=null,c.value[e].derived_units&&(c.value[e].derived_units=[])}function W(e){v.value[e].qty=0,v.value[e].unitPrice=0,v.value[e].expiry=null,v.value[e].subtotal=0,v.value[e].supplier_id=null,v.value[e].selected_derived_unit_id=null,v.value[e].selectedDerivedUnitInfo=null,v.value[e].derived_units&&(v.value[e].derived_units=[])}async function Q(e){try{const n=e.unit_id??e.unitId??null;if(!n){e.derived_units=[];return}if(F.value[n]){e.derived_units=F.value[n];return}const r=await axios.get("/units",{params:{per_page:200}}),s=(r.data?.data??r.data??[]).filter(o=>o.base_unit_id!==null&&Number(o.base_unit_id)===Number(n));F.value[n]=s,e.derived_units=s}catch(n){console.error("loadDerivedUnits error:",n),e.derived_units=[]}}function X(e){e.selected_derived_unit_id?e.selectedDerivedUnitInfo=e.derived_units.find(n=>n.id===e.selected_derived_unit_id):e.selectedDerivedUnitInfo=null,B(e)}function ee(e){e.selected_derived_unit_id?e.selectedDerivedUnitInfo=e.derived_units.find(n=>n.id===e.selected_derived_unit_id):e.selectedDerivedUnitInfo=null,G(e)}const te=$(()=>c.value.reduce((e,n)=>e+(Number(n.subtotal)||0),0)),le=$(()=>v.value.reduce((e,n)=>e+(Number(n.subtotal)||0),0));async function ne(){d.value={},b.value||(d.value.supplier="Please select a supplier");const e=new Date().toISOString().split("T")[0],n=[];if(console.log("Raw bulkItems before processing:",JSON.parse(JSON.stringify(c.value))),c.value.forEach((t,s)=>{console.log(`Processing item ${s}:`,{id:t.id,name:t.name,qty:t.qty,unitPrice:t.unitPrice,selected_derived_unit_id:t.selected_derived_unit_id,selectedDerivedUnitInfo:t.selectedDerivedUnitInfo});const o=t.qty||t.unitPrice||t.expiry,p={};if(o){let m=Number(t.qty)||0;if(t.selected_derived_unit_id&&t.selectedDerivedUnitInfo){const q=Number(t.selectedDerivedUnitInfo.conversion_factor)||1;m=m*q,console.log(`Applied conversion: ${t.qty} * ${q} = ${m}`)}const P=t.unitPrice!==null&&t.unitPrice!==void 0&&t.unitPrice!==""?Number(t.unitPrice):0;console.log("Entered Price:",P,"Type:",typeof t.unitPrice,"Raw value:",t.unitPrice);const I=t.selectedDerivedUnitInfo&&P>0?Number((P/Number(t.selectedDerivedUnitInfo.conversion_factor)).toFixed(4)):P;if(console.log("Base Unit Price:",I),(!m||m<=0)&&(p.qty="Quantity is required"),(!P||P<=0)&&(p.unitPrice="Unit Price is required"),t.expiry?new Date(t.expiry)<new Date(e)&&(p.expiry="Expiry must be today or later"):p.expiry="Expiry date is required",Object.keys(p).length>0)d.value[s]=p;else{const q={product_id:t.id,quantity:m,unit_price:I,expiry:t.expiry};console.log("Pushing item to validItems:",q),n.push(q)}}}),!b.value){k.error("Please select a supplier");return}if(n.length===0){k.error("No valid items to submit");return}if(Object.keys(d.value).length>0){k.error("Please fix the highlighted errors");return}const r={supplier_id:b.value,purchase_date:e,status:"completed",items:n};N.value=!0;try{await axios.post("/purchase-orders",r),k.success("Bulk order created successfully!"),j("refresh-data"),b.value=null,c.value.forEach(o=>{o.qty=0,o.unitPrice=0,o.expiry=null,o.subtotal=0,o.selected_derived_unit_id=null,o.selectedDerivedUnitInfo=null});const t=document.getElementById("bulkOrderModal"),s=bootstrap.Modal.getInstance(t);s&&s.hide(),setTimeout(()=>{document.body.classList.remove("modal-open"),document.body.style.overflow="",document.body.style.paddingRight="",document.querySelectorAll(".modal-backdrop").forEach(p=>p.remove())},100)}catch(t){console.error(t),k.error("Failed to save bulk order")}finally{N.value=!1}}async function oe(){h.value={};const e=new Date().toISOString().split("T")[0],n={};if(v.value.forEach((r,t)=>{const s=r.qty||r.unitPrice||r.expiry,o={};if(s){r.supplier_id||(o.supplier_id="Supplier is required");let p=Number(r.qty)||0;if(r.selected_derived_unit_id&&r.selectedDerivedUnitInfo){const I=Number(r.selectedDerivedUnitInfo.conversion_factor)||1;p=p*I}const m=r.unitPrice!==null&&r.unitPrice!==void 0&&r.unitPrice!==""?Number(r.unitPrice):0,P=r.selectedDerivedUnitInfo&&m>0?Number((m/Number(r.selectedDerivedUnitInfo.conversion_factor)).toFixed(4)):m;if((!p||p<=0)&&(o.qty="Quantity is required"),(!m||m<=0)&&(o.unitPrice="Unit Price is required"),r.expiry?new Date(r.expiry)<new Date(e)&&(o.expiry="Expiry must be today or later"):o.expiry="Expiry date is required",Object.keys(o).length>0)h.value[t]=o;else{const I=r.supplier_id;n[I]||(n[I]=[]),n[I].push({product_id:r.id,quantity:p,unit_price:P,expiry:r.expiry})}}}),Object.keys(n).length===0){k.error("No valid items to submit");return}if(Object.keys(h.value).length>0){k.error("Please fix the highlighted errors");return}E.value=!0;try{for(const[s,o]of Object.entries(n)){const p={supplier_id:parseInt(s),purchase_date:e,status:"completed",items:o};await axios.post("/purchase-orders",p)}k.success("Multiple orders created successfully!"),j("refresh-data"),v.value.forEach(s=>{s.qty=0,s.unitPrice=0,s.expiry=null,s.subtotal=0,s.supplier_id=null,s.selected_derived_unit_id=null,s.selectedDerivedUnitInfo=null});const r=document.getElementById("bulkOrderModal"),t=bootstrap.Modal.getInstance(r);t&&t.hide(),setTimeout(()=>{document.body.classList.remove("modal-open"),document.body.style.overflow="",document.body.style.paddingRight="",document.querySelectorAll(".modal-backdrop").forEach(o=>o.remove())},300)}catch(r){console.error(r),k.error("Failed to save multiple orders")}finally{E.value=!1}}return(e,n)=>{const r=ie("VueDatePicker");return u(),i("div",ce,[l("div",pe,[l("div",ve,[n[9]||(n[9]=ue('<div class="modal-header" data-v-7972cb38><h5 class="modal-title fw-semibold" data-v-7972cb38>Bulk Purchase</h5><button class="absolute top-2 right-2 p-2 rounded-full hover:bg-gray-100 transition transform hover:scale-110" data-bs-dismiss="modal" aria-label="Close" title="Close" data-v-7972cb38><svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-red-500" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" data-v-7972cb38><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" data-v-7972cb38></path></svg></button></div>',1)),l("div",me,[l("ul",_e,[l("li",ye,[l("button",{class:f(["nav-link",{active:y.value==="single"}]),onClick:n[0]||(n[0]=t=>y.value="single"),type:"button",role:"tab"}," Single Purchase ",2)]),l("li",fe,[l("button",{class:f(["nav-link",{active:y.value==="multiple"}]),onClick:n[1]||(n[1]=t=>y.value="multiple"),type:"button",role:"tab"}," Multiple Purchase ",2)])]),y.value==="single"?(u(),i("div",be,[l("div",he,[n[3]||(n[3]=l("label",{class:"form-label"},"Preferred Supplier",-1)),T(U(ae),{modelValue:b.value,"onUpdate:modelValue":n[2]||(n[2]=t=>b.value=t),options:S.suppliers,optionLabel:"name",optionValue:"id",placeholder:"Select Supplier",class:f(["w-100",{"is-invalid":d.value.supplier}]),appendTo:"self",autoZIndex:!0,baseZIndex:2e3},{value:Z(t=>[t.value?(u(),i("div",ge,a(S.suppliers.find(s=>s.id===t.value)?.name||"Select Supplier"),1)):(u(),i("span",ke,a(t.placeholder),1))]),option:Z(t=>[l("div",null,a(t.option.name),1)]),_:1},8,["modelValue","options","class"]),d.value.supplier?(u(),i("small",Pe,a(d.value.supplier),1)):_("",!0)]),l("div",Ie,[l("table",Ue,[n[5]||(n[5]=l("thead",null,[l("tr",null,[l("th",null,"Name"),l("th",null,"Category"),l("th",null,"Unit"),l("th",null,"Qty"),l("th",null,"Unit"),l("th",null,"Unit Price"),l("th",null,"Expiry"),l("th",null,"Subtotal"),l("th")])],-1)),l("tbody",null,[(u(!0),i(x,null,D(H.value,(t,s)=>(u(),i("tr",{key:t.id},[l("td",null,a(t.name),1),l("td",null,a(t.category?.name||"-"),1),l("td",null,a(t.unit_name),1),l("td",null,[w(l("input",{type:"number",min:"0","onUpdate:modelValue":o=>t.qty=o,class:f(["form-control",{"is-invalid":d.value[s]?.qty}]),onInput:o=>R(t)},null,42,we),[[M,t.qty,void 0,{number:!0}]]),d.value[s]?.qty?(u(),i("small",qe,a(d.value[s].qty),1)):_("",!0)]),l("td",null,[w(l("select",{class:"form-select","onUpdate:modelValue":o=>t.selected_derived_unit_id=o,onChange:o=>X(t),onFocus:o=>Q(t)},[l("option",De,"Base ("+a(t.unit_name)+")",1),(u(!0),i(x,null,D(t.derived_units||[],o=>(u(),i("option",{key:o.id,value:o.id},a(o.name),9,Se))),128))],40,xe),[[A,t.selected_derived_unit_id]])]),l("td",null,[w(l("input",{type:"number",min:"0","onUpdate:modelValue":o=>t.unitPrice=o,class:f(["form-control",{"is-invalid":d.value[s]?.unitPrice}]),onInput:o=>z(t)},null,42,Ve),[[M,t.unitPrice,void 0,{number:!0}]]),d.value[s]?.unitPrice?(u(),i("small",Ce,a(d.value[s].unitPrice),1)):_("",!0)]),l("td",null,[T(r,{modelValue:t.expiry,"onUpdate:modelValue":o=>t.expiry=o,format:U(L),"min-date":new Date,enableTimePicker:!1,teleport:"body",placeholder:"Select date",class:f({"is-invalid":d.value[s]?.expiry})},null,8,["modelValue","onUpdate:modelValue","format","min-date","class"]),d.value[s]?.expiry?(u(),i("small",Ne,a(d.value[s].expiry),1)):_("",!0)]),l("td",null,a(U(V)(t.subtotal.toFixed(2))),1),l("td",null,[l("button",{class:"btn btn-sm btn-outline-danger d-flex align-items-center justify-content-center",onClick:o=>K(s),title:"Clear",style:{width:"36px",height:"36px"}},[...n[4]||(n[4]=[l("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",fill:"currentColor",viewBox:"0 0 16 16"},[l("path",{"fill-rule":"evenodd",d:"M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"}),l("path",{d:"M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"})],-1)])],8,Ee)])]))),128))])])]),l("div",Me," Total: "+a(U(V)(te.value.toFixed(2))),1)])):_("",!0),y.value==="multiple"?(u(),i("div",Fe,[l("div",Be,[l("table",Oe,[n[8]||(n[8]=l("thead",null,[l("tr",null,[l("th",null,"Name"),l("th",null,"Category"),l("th",null,"Unit"),l("th",null,"Supplier"),l("th",null,"Qty"),l("th",null,"Unit"),l("th",null,"Unit Price"),l("th",null,"Expiry"),l("th",null,"Subtotal"),l("th")])],-1)),l("tbody",null,[(u(!0),i(x,null,D(v.value,(t,s)=>(u(),i("tr",{key:t.id},[l("td",null,a(t.name),1),l("td",null,a(t.category?.name||"-"),1),l("td",null,a(t.unit_name),1),l("td",null,[w(l("select",{"onUpdate:modelValue":o=>t.supplier_id=o,class:f(["form-select w-100",{"is-invalid":h.value[s]?.supplier_id}])},[n[6]||(n[6]=l("option",{value:"",disabled:"",hidden:""},"Select Supplier",-1)),(u(!0),i(x,null,D(S.suppliers,o=>(u(),i("option",{key:o.id,value:o.id},a(o.name),9,Te))),128))],10,$e),[[A,t.supplier_id]]),h.value[s]?.supplier_id?(u(),i("small",Ae,a(h.value[s].supplier_id),1)):_("",!0)]),l("td",null,[w(l("input",{type:"number",min:"0","onUpdate:modelValue":o=>t.qty=o,class:f(["form-control",{"is-invalid":d.value[s]?.qty}]),onInput:o=>R(t)},null,42,Le),[[M,t.qty,void 0,{number:!0}]]),d.value[s]?.qty?(u(),i("small",je,a(d.value[s].qty),1)):_("",!0)]),l("td",null,[w(l("select",{class:"form-select","onUpdate:modelValue":o=>t.selected_derived_unit_id=o,onChange:o=>ee(t),onFocus:o=>Q(t)},[l("option",ze,"Base ("+a(t.unit_name)+")",1),(u(!0),i(x,null,D(t.derived_units||[],o=>(u(),i("option",{key:o.id,value:o.id},a(o.name),9,Qe))),128))],40,Re),[[A,t.selected_derived_unit_id]])]),l("td",null,[w(l("input",{type:"number",min:"0","onUpdate:modelValue":o=>t.unitPrice=o,class:f(["form-control",{"is-invalid":d.value[s]?.unitPrice}]),onInput:o=>z(t)},null,42,Je),[[M,t.unitPrice,void 0,{number:!0}]]),d.value[s]?.unitPrice?(u(),i("small",Ze,a(d.value[s].unitPrice),1)):_("",!0)]),l("td",null,[T(r,{modelValue:t.expiry,"onUpdate:modelValue":o=>t.expiry=o,position:e.bottom,format:U(L),"min-date":new Date,enableTimePicker:!1,teleport:e.body,placeholder:"Select date",class:f({"is-invalid":h.value[s]?.expiry})},null,8,["modelValue","onUpdate:modelValue","position","format","min-date","teleport","class"]),h.value[s]?.expiry?(u(),i("small",Ye,a(h.value[s].expiry),1)):_("",!0)]),l("td",null,a(U(V)(t.subtotal.toFixed(2))),1),l("td",null,[l("button",{class:"btn btn-sm btn-outline-danger d-flex align-items-center justify-content-center",onClick:o=>W(s),title:"Clear",style:{width:"36px",height:"36px"}},[...n[7]||(n[7]=[l("svg",{xmlns:"http://www.w3.org/2000/svg",width:"16",height:"16",fill:"currentColor",viewBox:"0 0 16 16"},[l("path",{"fill-rule":"evenodd",d:"M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"}),l("path",{d:"M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"})],-1)])],8,Ge)])]))),128))])])]),l("div",He," Total: "+a(U(V)(le.value.toFixed(2))),1)])):_("",!0)]),l("div",Ke,[y.value==="single"?(u(),i("button",{key:0,class:"btn btn-primary rounded-pill px-4 py-2",disabled:N.value,onClick:ne},[N.value?(u(),i("span",et,"Saving...")):(u(),i("span",Xe,"Save"))],8,We)):_("",!0),y.value==="multiple"?(u(),i("button",{key:1,class:"btn btn-primary rounded-pill px-4 py-2",disabled:E.value,onClick:oe},[E.value?(u(),i("span",nt,"Saving...")):(u(),i("span",lt,"Save"))],8,tt)):_("",!0)])])])])}}},vt=se(ot,[["__scopeId","data-v-7972cb38"]]);export{vt as default};

import{_ as Q,r as u,c as Z,o as ee,y as O,f,b as v,d as C,e as l,u as T,h as te,m as I,k as U,v as B,l as N,F as E,g as le,t as b,C as oe,T as ae,U as se,i as re,p as k,n as ne,q as a}from"./app-DrUr72II.js";import{E as ie,a as de,X as ce,u as D,w as ue}from"./xlsx-7aOw9oZM.js";import{I as me}from"./importFile-AWru9xi7.js";import{P as ge}from"./plus-CmrmLSaN.js";import{P as pe}from"./pencil-Be4IWqC2.js";import"./createLucideIcon-BENYThoS.js";const fe={class:"card border-0 shadow-lg rounded-4"},ve={class:"card-body"},ye={class:"d-flex flex-wrap gap-2 justify-content-between align-items-center mb-3"},he={class:"d-flex gap-2"},we={class:"search-wrap"},be={class:"dropdown"},xe={class:"dropdown-menu dropdown-menu-end shadow rounded-4 py-2"},_e={class:"table-responsive"},Ae={class:"table table-hover"},Ce={key:0},ke={class:"fw-semibold"},Se={class:"text-center"},Ee={class:"d-inline-flex align-items-center gap-3"},De=["onClick"],$e={key:0},Fe={colspan:"3",class:"text-center text-muted py-4"},Pe={key:0,class:"mt-4 d-flex justify-content-between align-items-center"},Le={class:"text-muted small"},Te={class:"modal fade",id:"modalAllergyForm",tabindex:"-1","aria-hidden":"true"},Ie={class:"modal-dialog modal-lg modal-dialog-centered"},Ne={class:"modal-content rounded-4"},je={class:"modal-header"},Ve={class:"modal-title"},Me={class:"modal-body"},Re={key:0,class:"text-danger"},Oe={class:"col-md-2"},Ue=["disabled"],Be={__name:"AllergiesTab",setup(qe){const y=u(""),S=u(!1),$=u(null),x=u(""),F=()=>{y.value="",n.value={}},j=Z(()=>{const t=x.value.trim().toLowerCase();return t?c.value.filter(e=>e.name.toLowerCase().includes(t)):c.value}),q=()=>{S.value=!1,y.value=""},z=t=>{S.value=!0,$.value=t,y.value=t.name},X=async t=>{try{await k.delete(`/allergies/${t.id}`),c.value=c.value.filter(e=>e.id!==t.id),a.success("Allergy deleted successfully"),await A()}catch(e){a.error("Delete failed"),console.error(e)}},_=u(!1),V=async()=>{if(!_.value){if(!y.value.trim()){a.error("Please enter an allergy name"),n.value={customAllergy:["Please enter an allergy name"]};return}if(S.value)try{_.value=!0;const{data:t}=await k.put(`/allergies/${$.value.id}`,{name:y.value.trim()}),e=c.value.findIndex(o=>o.id===$.value.id);e!==-1&&(c.value[e]=t),a.success("Allergy updated successfully"),await A(),F(),M("modalAllergyForm")}catch(t){t.response?.data?.errors?(n.value={},Object.entries(t.response.data.errors).forEach(([e,o])=>{o.forEach(r=>a.error(r)),n.value={customAllergy:o}})):a.error("Update failed")}finally{_.value=!1}else{const t=y.value.trim();if(c.value.some(o=>o.name.toLowerCase()===t.toLowerCase())){a.error(`Allergy "${t}" already exists`),n.value={customAllergy:["This allergy already exists"]};return}try{_.value=!0;const o=await k.post("/allergies",{allergies:[{name:t}]}),r=o.data?.allergies??o.data;Array.isArray(r)&&r.length&&(c.value=[...c.value,...r]),a.success("Allergy added successfully"),F(),M("modalAllergyForm"),await A()}catch(o){o.response?.data?.errors?Object.values(o.response.data.errors).forEach(r=>r.forEach(g=>a.error(g))):(console.error(o),a.error("Create failed"))}finally{_.value=!1}}}},M=t=>{const e=document.getElementById(t);if(!e)return;(window.bootstrap?.Modal.getInstance(e)||new window.bootstrap.Modal(e)).hide()},c=u([]),m=u({current_page:1,last_page:1,per_page:10,total:0,from:0,to:0,links:[]});u(1),u(15);const h=u(!1),n=u({}),A=async(t=null)=>{h.value=!0;try{const{data:e}=await k.get("/allergies",{params:{q:x.value,page:t||m.value.current_page,per_page:m.value.per_page}});c.value=e.data||[],m.value={current_page:e.current_page,last_page:e.last_page,per_page:e.per_page,total:e.total,from:e.from,to:e.to,links:e.links},await ne(),window.feather?.replace()}catch(e){console.error("Failed to fetch allergies",e),a.error("Failed to load allergies")}finally{h.value=!1}},G=t=>{if(!t)return;const o=new URLSearchParams(t.split("?")[1]).get("page");o&&A(parseInt(o))},H=async()=>{try{h.value=!0;const t=await k.get("/allergies",{params:{q:x.value.trim(),per_page:1e4,page:1}});return console.log("ðŸ“¦ Export data received:",{total:t.data.total,items:t.data.data.length}),t.data.data||[]}catch(t){return console.error("âŒ Error fetching export data:",t),a.error("Failed to load data for export"),[]}finally{h.value=!1}},P=async t=>{try{h.value=!0,a.info("Preparing export data...",{autoClose:1500});const e=await H();if(!e||e.length===0){a.error("No allergies found to download"),h.value=!1;return}console.log(`ðŸ“¥ Exporting ${e.length} allergies as ${t.toUpperCase()}`),t==="pdf"?W(e):t==="excel"?Y(e):t==="csv"?K(e):a.error("Invalid download type")}catch(e){console.error("Download failed:",e),a.error(`Download failed: ${e.message}`)}finally{h.value=!1}},K=t=>{try{const e=["Name"],o=t.map(p=>[`"${p.name||""}"`]),r=[e.join(","),...o.map(p=>p.join(","))].join(`
`),g=new Blob([r],{type:"text/csv;charset=utf-8;"}),w=URL.createObjectURL(g),i=document.createElement("a");i.setAttribute("href",w),i.setAttribute("download",`allergies_${new Date().toISOString().split("T")[0]}.csv`),document.body.appendChild(i),i.click(),document.body.removeChild(i),URL.revokeObjectURL(w),a.success(`CSV downloaded successfully (${t.length} allergies)`,{autoClose:2500})}catch(e){console.error("CSV generation error:",e),a.error(`CSV generation failed: ${e.message}`,{autoClose:5e3})}},W=t=>{try{const e=new ie("p","mm","a4");e.setFont("helvetica","bold"),e.setFontSize(18),e.text("Allergies Report",70,20),e.setFont("helvetica","normal"),e.setFontSize(10);const o=new Date().toLocaleString();e.text(`Generated on: ${o}`,14,30),e.text(`Total Allergies: ${t.length}`,14,36);const r=["Name"],g=t.map(i=>[i.name||""]);de(e,{head:[r],body:g,startY:45,styles:{fontSize:10,cellPadding:3,halign:"left",valign:"middle",lineColor:[220,220,220],lineWidth:.1},headStyles:{fillColor:[41,128,185],textColor:255,fontStyle:"bold"},alternateRowStyles:{fillColor:[245,245,245]},margin:{left:14,right:14},didDrawPage:i=>{const p=e.internal.getNumberOfPages(),s=e.internal.pageSize.height;e.setFontSize(8),e.text(`Page ${i.pageNumber} of ${p}`,14,s-10)}});const w=`allergies_${new Date().toISOString().split("T")[0]}.pdf`;e.save(w),a.success(`PDF downloaded successfully (${t.length} allergies)`,{autoClose:2500})}catch(e){console.error("PDF generation error:",e),a.error(`PDF generation failed: ${e.message}`,{autoClose:5e3})}},Y=t=>{try{if(typeof ce>"u")throw new Error("XLSX library is not loaded");const e=t.map(p=>({Name:p.name||""})),o=D.book_new(),r=D.json_to_sheet(e);r["!cols"]=[{wch:25}],D.book_append_sheet(o,r,"Allergies");const g=[{Info:"Generated On",Value:new Date().toLocaleString()},{Info:"Total Records",Value:t.length},{Info:"Exported By",Value:"Allergies Management System"}],w=D.json_to_sheet(g);D.book_append_sheet(o,w,"Report Info");const i=`allergies_${new Date().toISOString().split("T")[0]}.xlsx`;ue(o,i),a.success(`Excel file downloaded successfully (${t.length} allergies)`,{autoClose:2500})}catch(e){console.error("Excel generation error:",e),a.error(`Excel generation failed: ${e.message}`,{autoClose:5e3})}};ee(async()=>{await A(),window.feather?.replace()}),O(y,t=>{t&&n.value.customAllergy&&delete n.value.customAllergy});let R=null;O(x,()=>{clearTimeout(R),R=setTimeout(()=>{m.value.current_page=1,A(1)},500)});const J=t=>{if(!Array.isArray(t)||t.length===0){a.error("File is empty.");return}t[0];const o=t.slice(1).filter(s=>Array.isArray(s)&&s.some(d=>String(d??"").trim()!==""));if(o.length===0){a.error("No data rows found the file is empty or contains only headers.");return}const r=o.map(s=>({name:String(s[0]??"").trim()})).filter(s=>s.name!=="");if(r.length===0){a.error("No valid allergy names found in the file.");return}const g=r.map(s=>s.name.toLowerCase()),w=g.filter((s,d)=>g.indexOf(s)!==d);if(w.length){const s=[...new Set(w)];a.error(`Duplicate entries found in file: ${s.join(", ")}`);return}const i=c.value.map(s=>s.name.toLowerCase()),p=r.filter(s=>i.includes(s.name.toLowerCase()));if(p.length>0){const s=p.map(d=>d.name).join(", ");a.error(`These allergies already exist in the database: ${s}`);return}k.post("/api/allergies/import",{allergies:r}).then(()=>{a.success("Allergies imported successfully");const s=document.querySelector(".modal.show");if(s){const d=bootstrap.Modal.getInstance(s);d&&d.hide()}setTimeout(()=>{document.querySelectorAll(".modal-backdrop").forEach(L=>L.remove()),document.body.classList.remove("modal-open"),document.body.style.overflow="",document.body.style.paddingRight=""},100),A()}).catch(s=>{if(s?.response?.status===422&&s.response.data?.errors){n.value=s.response.data.errors;const d=s.response.data.message||"There may be duplication or validation errors in the data.";a.error(d,{autoClose:3e3})}else a.error("Import failed. Please try again.",{autoClose:3e3}),console.error(s);setTimeout(()=>{document.querySelectorAll(".modal-backdrop").forEach(L=>L.remove()),document.body.classList.remove("modal-open"),document.body.style.overflow="",document.body.style.paddingRight=""},100)})};return(t,e)=>(v(),f(E,null,[C(T(te),{title:"Allergy"}),l("div",fe,[l("div",ve,[l("div",ye,[e[9]||(e[9]=l("h4",{class:"mb-0"},"Allergies",-1)),l("div",he,[l("div",we,[e[6]||(e[6]=l("i",{class:"bi bi-search"},null,-1)),U(l("input",{"onUpdate:modelValue":e[0]||(e[0]=o=>x.value=o),class:"form-control search-input",placeholder:"Search"},null,512),[[B,x.value]])]),l("button",{"data-bs-toggle":"modal","data-bs-target":"#modalAllergyForm",onClick:e[1]||(e[1]=()=>{q(),F(),n.value={}}),class:"d-flex align-items-center gap-1 btn-sm px-4 py-2 rounded-pill btn btn-primary text-white"},[C(T(ge),{class:"w-4 h-4"}),e[7]||(e[7]=N(" Add Allergy ",-1))]),C(me,{label:"Import",sampleHeaders:["Name"],sampleData:[["Milk"],["Peanuts"],["Gluten"]],onOnImport:J}),l("div",be,[e[8]||(e[8]=l("button",{class:"btn btn-outline-secondary btn-sm rounded-pill py-2 px-4 dropdown-toggle","data-bs-toggle":"dropdown"}," Export ",-1)),l("ul",xe,[l("li",null,[l("a",{class:"dropdown-item py-2",href:"javascript:;",onClick:e[2]||(e[2]=o=>P("pdf"))},"Export as PDF")]),l("li",null,[l("a",{class:"dropdown-item py-2",href:"javascript:;",onClick:e[3]||(e[3]=o=>P("excel"))},"Export as Excel")]),l("li",null,[l("a",{class:"dropdown-item py-2",href:"javascript:;",onClick:e[4]||(e[4]=o=>P("csv"))},"Export as CSV")])])])])]),l("div",_e,[l("table",Ae,[e[11]||(e[11]=l("thead",{class:"border-top small text-muted"},[l("tr",null,[l("th",null,"S. #"),l("th",null,"Allergy Name"),l("th",{class:"text-center"},"Action")])],-1)),l("tbody",null,[h.value?(v(),f("tr",Ce,[...e[10]||(e[10]=[l("td",{colspan:"3",class:"text-center py-5"},[l("div",{class:"spinner-border text-primary",role:"status"},[l("span",{class:"visually-hidden"},"Loading...")]),l("p",{class:"text-muted mt-2 mb-0"},"Loading allergies...")],-1)])])):(v(),f(E,{key:1},[(v(!0),f(E,null,le(j.value,(o,r)=>(v(),f("tr",{key:o.id},[l("td",null,b(m.value.from+r),1),l("td",ke,b(o.name),1),l("td",Se,[l("div",Ee,[l("button",{"data-bs-toggle":"modal","data-bs-target":"#modalAllergyForm",onClick:()=>{z(o),n.value={}},title:"Edit",class:"p-2 rounded-full text-blue-600 hover:bg-blue-100"},[C(T(pe),{class:"w-4 h-4"})],8,De),C(oe,{title:"Confirm Delete",message:`Are you sure you want to delete ${o.name}?`,showDeleteButton:!0,onConfirm:()=>{X(o)},onCancel:()=>{}},null,8,["message","onConfirm"])])])]))),128)),j.value.length===0?(v(),f("tr",$e,[l("td",Fe,b(x.value.trim()?"No allergies found matching your search.":"No allergies found."),1)])):I("",!0)],64))])])]),!h.value&&m.value.last_page>1?(v(),f("div",Pe,[l("div",Le," Showing "+b(m.value.from)+" to "+b(m.value.to)+" of "+b(m.value.total)+" entries ",1),C(ae,{pagination:m.value.links,isApiDriven:!0,onPageChanged:G},null,8,["pagination"])])):I("",!0)])]),l("div",Te,[l("div",Ie,[l("div",Ne,[l("div",je,[l("h5",Ve,b(S.value?"Edit Allergy":"Add Allergy(s)"),1),e[12]||(e[12]=l("button",{class:"absolute top-2 right-2 p-2 rounded-full hover:bg-gray-100 transition transform hover:scale-110","data-bs-dismiss":"modal","aria-label":"Close",title:"Close"},[l("svg",{xmlns:"http://www.w3.org/2000/svg",class:"h-6 w-6 text-red-500",fill:"none",viewBox:"0 0 24 24",stroke:"currentColor","stroke-width":"2"},[l("path",{"stroke-linecap":"round","stroke-linejoin":"round",d:"M6 18L18 6M6 6l12 12"})])],-1))]),l("div",Me,[l("div",null,[e[13]||(e[13]=l("label",{class:"form-label"},"Allergy Name",-1)),U(l("input",{"onUpdate:modelValue":e[5]||(e[5]=o=>y.value=o),class:re(["form-control",{"is-invalid":n.value.customAllergy}]),placeholder:"e.g., Vegan",onKeyup:se(V,["enter"])},null,34),[[B,y.value]]),n.value.customAllergy?(v(),f("span",Re,b(n.value.customAllergy[0]),1)):I("",!0)]),l("div",Oe,[l("button",{class:"btn btn-primary rounded-pill py-2 btn-sm w-100 mt-4",disabled:_.value,onClick:V},[_.value?(v(),f(E,{key:0},[e[14]||(e[14]=l("span",{class:"spinner-border spinner-border-sm me-2"},null,-1)),e[15]||(e[15]=N(" Saving... ",-1))],64)):(v(),f(E,{key:1},[N(b((S.value,"Save")),1)],64))],8,Ue)])])])])])],64))}},Ye=Q(Be,[["__scopeId","data-v-e8840177"]]);export{Ye as default};

import{_ as se,r as g,o as L,n as le,c as F,I as ne,w as re,a as ie,b as p,d as U,e as $,f as t,u as m,h as de,t as r,g as y,l as z,m as G,v as ue,p as ce,F as V,i as H,T as me,P as pe,s as v}from"./app-BOMqQl54.js";import{_ as ve}from"./Master-t5sKYHj4.js";import{u as ye}from"./useFormatters-DSjy4Xmc.js";import{F as he}from"./FilterModal-0Wv3gaox.js";import{E as _e,a as ge,X as be,u as S,w as fe}from"./xlsx-B5zBSq-K.js";import{s as xe}from"./index-4S-6UPku.js";import"./index-DFI1w7K3.js";import"./createLucideIcon-DvtweBtm.js";import"./index-DsP-l9eT.js";import"./index-Vjw1Gq1q.js";import"./sun-D-mhzGUf.js";import"./index-DUbsQ-HQ.js";import"./index-CWVsoM9N.js";import"./index-BkIqSWvw.js";const we={class:"page-wrapper"},De={class:"row g-3"},Fe={class:"col-6 col-md-4"},Te={class:"card border-0 shadow-sm rounded-4"},Pe={class:"card-body d-flex align-items-center justify-content-between"},Ne={class:"mb-0 fw-bold"},Se={class:"col-6 col-md-4"},Ce={class:"card border-0 shadow-sm rounded-4"},$e={class:"card-body d-flex align-items-center justify-content-between"},Ie={class:"mb-0 fw-bold"},ke={class:"col-12 col-md-4"},Me={class:"card border-0 shadow-sm rounded-4"},Oe={class:"card-body d-flex align-items-center justify-content-between"},Ve={class:"mb-0 fw-bold"},Ae={class:"card border-0 shadow-lg rounded-4 mt-3"},Re={class:"card-body"},Be={class:"d-flex flex-wrap gap-2 justify-content-between align-items-center mb-3"},Ee={class:"d-flex flex-wrap gap-2 align-items-center"},je={class:"search-wrap"},Le={key:1,class:"form-control search-input",placeholder:"Search by Order ID",disabled:"",type:"text"},Ue={class:"col-md-6"},ze=["onUpdate:modelValue"],Ge=["value"],He={class:"table-responsive"},We={class:"table table-hover align-middle"},Xe={key:0},Ye={class:"text-success"},qe={class:"text-success"},Qe={class:"text-success"},Ke={class:"text-capitalize"},Je={key:0},Ze={key:0,class:"mt-4 d-flex justify-content-between align-items-center"},et={class:"text-muted small"},tt={__name:"Index",setup(at){const{formatCurrencySymbol:h,dateFmt:C}=ye(),f=g([]),T=g(!1),u=g({current_page:1,last_page:1,per_page:10,total:0,from:0,to:0,links:[]}),I=g(null),W=[{label:"PDF",value:"pdf"},{label:"Excel",value:"excel"},{label:"CSV",value:"csv"}],X=a=>{a.value&&(ee(a.value),I.value=null)},P=async(a=null)=>{T.value=!0;try{const e={q:D.value,page:a||u.value.current_page,per_page:u.value.per_page,sort_by:c.value.sortBy||"",payment_type:c.value.paymentType||"",date_from:c.value.dateFrom||"",date_to:c.value.dateTo||"",price_min:c.value.priceMin||"",price_max:c.value.priceMax||""};Object.keys(e).forEach(s=>{(e[s]===void 0||e[s]==="")&&delete e[s]});const o=await axios.get("/api/payments/all",{params:e});f.value=o.data.data.map(s=>{const n=s.order||{};return{id:n.id,customer_name:n.customer_name,promo:n.promo,service_charges:n.service_charges,delivery_charges:n.delivery_charges,tax:n.tax,sub_total:n.sub_total,sales_discount:n.sales_discount,approved_discounts:n.approved_discounts,total_amount:n.total_amount,status:n.status,type:n.type,payment_type:s.payment_type,amount_received:s.amount_received,payment_date:s.payment_date,user:s.user}}),u.value={current_page:o.data.current_page,last_page:o.data.last_page,per_page:o.data.per_page,total:o.data.total,from:o.data.from,to:o.data.to,links:o.data.links}}catch(e){console.error("Error fetching payments:",e),f.value=[],v.error("Failed to load payments")}finally{T.value=!1}},Y=a=>{if(!a)return;const o=new URLSearchParams(a.split("?")[1]).get("page");o&&P(parseInt(o))};L(async()=>{D.value="",A.value=Date.now(),await le(),setTimeout(()=>{R.value=!0;const e=document.getElementById(k);e&&(e.value="",D.value="")},100),P();const a=document.getElementById("paymentFilterModal");a&&a.addEventListener("hidden.bs.modal",()=>{b.value={sortBy:c.value.sortBy||"",paymentType:c.value.paymentType||"",dateFrom:c.value.dateFrom||"",dateTo:c.value.dateTo||"",priceMin:c.value.priceMin||null,priceMax:c.value.priceMax||null}})});const D=g(""),A=g(Date.now()),k=`search-${Math.random().toString(36).substr(2,9)}`,R=g(!1),b=g({sortBy:"",paymentType:"",dateFrom:"",dateTo:"",priceMin:null,priceMax:null}),c=g({sortBy:"",paymentType:"",dateFrom:"",dateTo:"",priceMin:null,priceMax:null}),M=F(()=>f.value.map(a=>{const e=Array.isArray(a.promo)&&a.promo.length>0?a.promo[0]:null;return{orderId:a.id,customer:a.customer_name,user:a.user?.name||"—",type:a.payment_type||"—",serviceCharges:Number(a.service_charges||0),deliveryCharges:Number(a.delivery_charges||0),tax:Number(a.tax||0),amountReceived:Number(a.amount_received||0),promoDiscount:e?Number(e.discount_amount||0):0,salesDiscount:Number(a.sales_discount||0),approvedDiscount:Number(a.approved_discounts||0),grandTotal:Number(a.total_amount||0),promoName:e?e.promo_name:"—",paidAt:a.payment_date||null,status:a.status}})),B=F(()=>M.value),q=a=>{b.value={...b.value,...a},c.value={...b.value},u.value.current_page=1,P(1),bootstrap.Modal.getInstance(document.getElementById("paymentFilterModal"))?.hide(),console.log("Filters applied:",b.value)},Q=()=>{b.value={sortBy:"",paymentType:"",dateFrom:"",dateTo:"",priceMin:null,priceMax:null},c.value={sortBy:"",paymentType:"",dateFrom:"",dateTo:"",priceMin:null,priceMax:null},u.value.current_page=1,u.value.per_page=10,P(1),console.log("Filters cleared")},E=F(()=>({sortOptions:[{value:"date_desc",label:"Date: Newest First"},{value:"date_asc",label:"Date: Oldest First"},{value:"amount_desc",label:"Amount: High to Low"},{value:"amount_asc",label:"Amount: Low to High"},{value:"order_asc",label:"Order ID: Low to High"},{value:"order_desc",label:"Order ID: High to Low"}],paymentTypeOptions:[{value:"Cash",label:"Cash"},{value:"Card",label:"Card"},{value:"Split",label:"Split"},{value:"QR",label:"QR"},{value:"Bank",label:"Bank"}]})),K=F(()=>M.value.length),J=F(()=>{const a=new Date,e=new Date(a.getFullYear(),a.getMonth(),a.getDate()),o=new Date(a.getFullYear(),a.getMonth(),a.getDate()+1);return f.value.filter(s=>{if(!s.created_at||!s.payment)return!1;const n=new Date(s.created_at);return n>=e&&n<o}).length}),Z=F(()=>M.value.reduce((a,e)=>a+Number(e.grandTotal||0),0));L(()=>window.feather?.replace()),ne(()=>window.feather?.replace());let j=null;re(D,()=>{clearTimeout(j),j=setTimeout(()=>{u.value.current_page=1,P(1)},500)});const ee=a=>{if(!f.value||f.value.length===0){v.error("No payment data to download");return}const e=f.value;if(e.length===0){v.error("No payments found to download");return}try{a==="pdf"?ae(e):a==="excel"?oe(e):a==="csv"?te(e):v.error("Invalid download type")}catch(o){console.error("Download failed:",o),v.error(`Download failed: ${o.message}`)}},te=a=>{try{const e=["Order ID","Date","Customer","Payment Type","Amount Received","Promo Discount","Sales Discount","Approved Discount","Tax","Service Charges","Delivery Charges","Grand Total","Status"],o=a.map(i=>[`"${i.id||""}"`,`"${C(i.payment_date)}"`,`"${i.customer_name||"Walk In"}"`,`"${i.payment_type||"-"}"`,`"${Number(i.amount_received||0).toFixed(2)}"`,`"${Number(i.promo?.[0]?.discount_amount||0).toFixed(2)}"`,`"${Number(i.sales_discount||0).toFixed(2)}"`,`"${Number(i.approved_discounts||0).toFixed(2)}"`,`"${Number(i.tax||0).toFixed(2)}"`,`"${Number(i.service_charges||0).toFixed(2)}"`,`"${Number(i.delivery_charges||0).toFixed(2)}"`,`"${Number(i.total_amount||0).toFixed(2)}"`,`"${i.status||""}"`]),s=[e.join(","),...o.map(i=>i.join(","))].join(`
`),n=new Blob([s],{type:"text/csv;charset=utf-8;"}),N=URL.createObjectURL(n),_=document.createElement("a");_.setAttribute("href",N),_.setAttribute("download",`Payments_${new Date().toISOString().split("T")[0]}.csv`),document.body.appendChild(_),_.click(),document.body.removeChild(_),v.success("Payments CSV downloaded successfully")}catch(e){console.error("CSV generation error:",e),v.error(`CSV generation failed: ${e.message}`)}},ae=a=>{try{const e=new _e("l","mm","a4");e.setFontSize(18),e.setFont("helvetica","bold"),e.text("Payments Report",14,20),e.setFontSize(10),e.setFont("helvetica","normal");const o=new Date().toLocaleString();e.text(`Generated on: ${o}`,14,28),e.text(`Total Payments: ${a.length}`,14,34);const s=a.reduce((d,x)=>d+Number(x.total_amount||0),0),n=a.reduce((d,x)=>d+Number(x.amount_received||0),0);e.text(`Total Revenue: £${s.toFixed(2)}`,14,40),e.text(`Total Received: £${n.toFixed(2)}`,14,46);const N=["Order ID","Date","Customer","Payment Type","Amount Received","Promo Disc.","Sales Disc.","Tax","Grand Total","Status"],_=a.map(d=>[d.id||"",C(d.payment_date),d.customer_name||"Walk In",d.payment_type||"-",`£${Number(d.amount_received||0).toFixed(2)}`,`£${Number(d.promo?.[0]?.discount_amount||0).toFixed(2)}`,`£${Number(d.sales_discount||0).toFixed(2)}`,`£${Number(d.tax||0).toFixed(2)}`,`£${Number(d.total_amount||0).toFixed(2)}`,d.status||""]);ge(e,{head:[N],body:_,startY:52,styles:{fontSize:8,cellPadding:2,halign:"left",lineColor:[0,0,0],lineWidth:.1},headStyles:{fillColor:[41,128,185],textColor:255,fontStyle:"bold"},alternateRowStyles:{fillColor:[245,245,245]},margin:{left:14,right:14},didDrawPage:d=>{const x=e.internal.getNumberOfPages(),O=e.internal.pageSize.height;e.setFontSize(8),e.text(`Page ${d.pageNumber} of ${x}`,d.settings.margin.left,O-10)}});const i=`Payments_${new Date().toISOString().split("T")[0]}.pdf`;e.save(i),v.success("Payments PDF downloaded successfully")}catch(e){console.error("PDF generation error:",e),v.error(`PDF generation failed: ${e.message}`)}},oe=a=>{try{if(typeof be>"u")throw new Error("XLSX library is not loaded");const e=a.map(l=>({"Order ID":l.id||"",Date:C(l.payment_date),Customer:l.customer_name||"Walk In","Order Type":l.type||"-","Payment Type":l.payment_type||"-","Amount Received":Number(l.amount_received||0).toFixed(2),"Promo Name":l.promo?.[0]?.promo_name||"-","Promo Discount":Number(l.promo?.[0]?.discount_amount||0).toFixed(2),"Sales Discount":Number(l.sales_discount||0).toFixed(2),"Approved Discount":Number(l.approved_discounts||0).toFixed(2),Tax:Number(l.tax||0).toFixed(2),"Service Charges":Number(l.service_charges||0).toFixed(2),"Delivery Charges":Number(l.delivery_charges||0).toFixed(2),"Grand Total":Number(l.total_amount||0).toFixed(2),Status:l.status||"",User:l.user?.name||"—"})),o=S.book_new(),s=S.json_to_sheet(e);s["!cols"]=[{wch:10},{wch:12},{wch:20},{wch:12},{wch:12},{wch:15},{wch:20},{wch:15},{wch:15},{wch:15},{wch:10},{wch:15},{wch:15},{wch:12},{wch:10},{wch:15}],S.book_append_sheet(o,s,"Payments");const n=a.reduce((l,w)=>l+Number(w.total_amount||0),0),N=a.reduce((l,w)=>l+Number(w.amount_received||0),0),_=a.reduce((l,w)=>l+Number(w.promo?.[0]?.discount_amount||0),0),i=a.reduce((l,w)=>l+Number(w.sales_discount||0),0),d=[{Info:"Generated On",Value:new Date().toLocaleString()},{Info:"Total Payments",Value:a.length},{Info:"Total Revenue",Value:`£${n.toFixed(2)}`},{Info:"Total Amount Received",Value:`£${N.toFixed(2)}`},{Info:"Total Promo Discounts",Value:`£${_.toFixed(2)}`},{Info:"Total Sales Discounts",Value:`£${i.toFixed(2)}`},{Info:"Exported By",Value:"Payment Management System"}],x=S.json_to_sheet(d);S.book_append_sheet(o,x,"Summary");const O=`Payments_${new Date().toISOString().split("T")[0]}.xlsx`;fe(o,O),v.success("Payments Excel file downloaded successfully")}catch(e){console.error("Excel generation error:",e),v.error(`Excel generation failed: ${e.message}`)}};return(a,e)=>(p(),ie(ve,null,{default:U(()=>[$(m(de),{title:"Payment"}),t("div",we,[e[18]||(e[18]=t("h4",{class:"fw-semibold mb-3"},"Overall Payments",-1)),t("div",De,[t("div",Fe,[t("div",Te,[t("div",Pe,[t("div",null,[t("h3",Ne,r(K.value),1),e[4]||(e[4]=t("p",{class:"text-muted mb-0 small"},"Total Payments",-1))]),e[5]||(e[5]=t("div",{class:"rounded-circle p-3 bg-primary-subtle text-primary d-flex align-items-center justify-content-center",style:{width:"56px",height:"56px"}},[t("i",{class:"bi bi-list-check fs-4"})],-1))])])]),t("div",Se,[t("div",Ce,[t("div",$e,[t("div",null,[t("h3",Ie,r(J.value),1),e[6]||(e[6]=t("p",{class:"text-muted mb-0 small"},"Today's Payments",-1))]),e[7]||(e[7]=t("div",{class:"rounded-circle p-3 bg-success-subtle text-success d-flex align-items-center justify-content-center",style:{width:"56px",height:"56px"}},[t("i",{class:"bi bi-calendar-day fs-4"})],-1))])])]),t("div",ke,[t("div",Me,[t("div",Oe,[t("div",null,[t("h3",Ve,r(m(h)(Z.value,"GBP")),1),e[8]||(e[8]=t("p",{class:"text-muted mb-0 small"},"Total Amount",-1))]),e[9]||(e[9]=t("div",{class:"rounded-circle p-3 bg-warning-subtle text-warning d-flex align-items-center justify-content-center",style:{width:"56px",height:"56px"}},[t("i",{class:"bi bi-currency-pound fs-4"})],-1))])])])]),t("div",Ae,[t("div",Re,[t("div",Be,[e[14]||(e[14]=t("h5",{class:"mb-0 fw-semibold"},"Payments",-1)),t("div",Ee,[t("div",je,[e[10]||(e[10]=t("i",{class:"bi bi-search"},null,-1)),e[11]||(e[11]=t("input",{type:"email",name:"email",autocomplete:"email",style:{position:"absolute",left:"-9999px",width:"1px",height:"1px"},tabindex:"-1","aria-hidden":"true"},null,-1)),R.value?G((p(),y("input",{id:k,"onUpdate:modelValue":e[0]||(e[0]=o=>D.value=o),key:A.value,class:"form-control search-input",placeholder:"Search by Order ID",type:"search",autocomplete:"new-password",name:k,role:"presentation",onFocus:e[1]||(e[1]=(...o)=>a.handleFocus&&a.handleFocus(...o))},null,32)),[[ue,D.value]]):(p(),y("input",Le))]),$(he,{modelValue:b.value,"onUpdate:modelValue":e[2]||(e[2]=o=>b.value=o),title:"Payments","modal-id":"paymentFilterModal","modal-size":"modal-lg","sort-options":E.value.sortOptions,"show-price-range":!0,"show-date-range":!0,"show-stock-status":!1,"price-label":"Amount Range",onApply:q,onClear:Q},{customFilters:U(({filters:o})=>[t("div",Ue,[e[13]||(e[13]=t("label",{class:"form-label fw-semibold text-dark"},[t("i",{class:"fas fa-credit-card me-2 text-muted"}),ce("Payment Type ")],-1)),G(t("select",{"onUpdate:modelValue":s=>o.paymentType=s,class:"form-select"},[e[12]||(e[12]=t("option",{value:""},"All",-1)),(p(!0),y(V,null,H(E.value.paymentTypeOptions,s=>(p(),y("option",{key:s.value,value:s.value},r(s.label),9,Ge))),128))],8,ze),[[me,o.paymentType]])])]),_:1},8,["modelValue","sort-options"]),$(m(xe),{modelValue:I.value,"onUpdate:modelValue":e[3]||(e[3]=o=>I.value=o),options:W,optionLabel:"label",optionValue:"value",placeholder:"Export",class:"export-dropdown",onChange:X},null,8,["modelValue"])])]),t("div",He,[t("table",We,[e[17]||(e[17]=t("thead",{class:"border-top small text-muted"},[t("tr",null,[t("th",null,"S. #"),t("th",null,"Order ID"),t("th",null,"Actual Payment"),t("th",null,"Promo Name"),t("th",null,"Promo Discount"),t("th",null,"Sales Discount"),t("th",null,"Approved Discount"),t("th",null,"Tax"),t("th",null,"Service Charges"),t("th",null,"Delivery Charges"),t("th",null,"Grand Total"),t("th",null,"Payment Date"),t("th",null,"Payment Type")])],-1)),t("tbody",null,[T.value?(p(),y("tr",Xe,[...e[15]||(e[15]=[t("td",{colspan:"11",class:"text-center py-5"},[t("div",{class:"d-flex flex-column align-items-center justify-content-center"},[t("div",{class:"spinner-border mb-3",role:"status",style:{color:"#1B1670",width:"3rem",height:"3rem","border-width":"0.3em"}},[t("span",{class:"visually-hidden"},"Loading...")]),t("div",{class:"fw-semibold text-muted"},"Loading Payments...")])],-1)])])):(p(),y(V,{key:1},[(p(!0),y(V,null,H(B.value,(o,s)=>(p(),y("tr",{key:o.orderId},[t("td",null,r((u.value.current_page-1)*u.value.per_page+s+1),1),t("td",null,r(o.orderId),1),t("td",null,r(m(h)(o.amountReceived)),1),t("td",null,r(o.promoName),1),t("td",Ye,r(o.promoDiscount?m(h)(o.promoDiscount):"—"),1),t("td",qe,r(o.salesDiscount?m(h)(o.salesDiscount):"—"),1),t("td",Qe,r(o.approvedDiscount?m(h)(o.approvedDiscount):"—"),1),t("td",null,r(m(h)(o.tax)),1),t("td",null,r(m(h)(o.serviceCharges)),1),t("td",null,r(m(h)(o.deliveryCharges)),1),t("td",null,r(m(h)(o.grandTotal)),1),t("td",null,r(m(C)(o.paidAt)),1),t("td",Ke,r(o.type),1)]))),128)),!T.value&&B.value.length===0?(p(),y("tr",Je,[...e[16]||(e[16]=[t("td",{colspan:"13",class:"text-center text-muted py-4"}," No payments found. ",-1)])])):z("",!0)],64))])])]),!T.value&&u.value.last_page>1?(p(),y("div",Ze,[t("div",et," Showing "+r(u.value.from)+" to "+r(u.value.to)+" of "+r(u.value.total)+" items ",1),$(pe,{pagination:u.value.links,isApiDriven:!0,onPageChanged:Y},null,8,["pagination"])])):z("",!0)])])])]),_:1}))}},_t=se(tt,[["__scopeId","data-v-11d086b5"]]);export{_t as default};

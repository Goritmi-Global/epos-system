import{_ as ee,r as _,o as V,n as te,c as D,I as ae,a as oe,b as h,w as E,d as j,e as t,u as y,h as ne,t as d,k as R,f as w,v as se,l as le,F as A,g as z,S as re,m as de,q as v}from"./app-BPm8Jqa8.js";import{_ as ie}from"./Master-B-oa1_ok.js";import{u as ue}from"./useFormatters-SHi38_16.js";import{F as ce}from"./FilterModal-DGgiBVnc.js";import{E as me,a as pe,X as ye,u as N,w as he}from"./xlsx-DiILdRon.js";import"./index-CkTwpF0O.js";import"./createLucideIcon-CtC6jb4d.js";import"./index-z4fDpXBL.js";import"./index-Cydqvc8x.js";import"./sun-BfHbTYSR.js";const ve={class:"page-wrapper"},be={class:"row g-3"},fe={class:"col-6 col-md-4"},we={class:"card border-0 shadow-sm rounded-4"},ge={class:"card-body d-flex align-items-center justify-content-between"},_e={class:"mb-0 fw-bold"},xe={class:"col-6 col-md-4"},De={class:"card border-0 shadow-sm rounded-4"},Ce={class:"card-body d-flex align-items-center justify-content-between"},Te={class:"mb-0 fw-bold"},Ne={class:"col-12 col-md-4"},Fe={class:"card border-0 shadow-sm rounded-4"},Pe={class:"card-body d-flex align-items-center justify-content-between"},Se={class:"mb-0 fw-bold"},Ie={class:"card border-0 shadow-lg rounded-4 mt-3"},ke={class:"card-body"},$e={class:"d-flex flex-wrap gap-2 justify-content-between align-items-center mb-3"},Ae={class:"d-flex flex-wrap gap-2 align-items-center"},Me={class:"search-wrap"},Oe={key:1,class:"form-control search-input",placeholder:"Search by Order ID",disabled:"",type:"text"},Be={class:"col-md-6"},Le=["onUpdate:modelValue"],Ve=["value"],Ee={class:"dropdown"},je={class:"dropdown-menu dropdown-menu-end shadow rounded-4 py-2"},Re={class:"table-responsive"},ze={class:"table table-hover align-middle"},Ge={key:0},He={class:"text-success"},Ue={class:"text-success"},We={class:"text-success"},Xe={class:"text-capitalize"},Ye={key:0},qe={__name:"Index",setup(Qe){const{formatCurrencySymbol:b,dateFmt:F}=ue(),x=_([]),P=_(!1),G=async()=>{P.value=!0;try{const o=await axios.get("/api/orders/all");x.value=o.data.data}catch(o){console.error("Error fetching orders:",o)}finally{P.value=!1}};V(async()=>{C.value="",M.value=Date.now(),await te(),setTimeout(()=>{O.value=!0;const e=document.getElementById(S);e&&(e.value="",C.value="")},100),G();const o=document.getElementById("paymentFilterModal");o&&o.addEventListener("hidden.bs.modal",()=>{s.value={sortBy:g.value.sortBy||"",paymentType:g.value.paymentType||"",dateFrom:g.value.dateFrom||"",dateTo:g.value.dateTo||"",priceMin:g.value.priceMin||null,priceMax:g.value.priceMax||null}})});const C=_(""),M=_(Date.now()),S=`search-${Math.random().toString(36).substr(2,9)}`,O=_(!1),s=_({sortBy:"",paymentType:"",dateFrom:"",dateTo:"",priceMin:null,priceMax:null}),g=_({sortBy:"",paymentType:"",dateFrom:"",dateTo:"",priceMin:null,priceMax:null}),I=D(()=>x.value.map(o=>{const e=Array.isArray(o.promo)&&o.promo.length>0?o.promo[0]:null;return{orderId:o.id,customer:o.customer_name,user:o.user?.name||"—",type:o.payment?.payment_type||"—",serviceCharges:Number(o.service_charges||0),deliveryCharges:Number(o.delivery_charges||0),tax:Number(o.tax||0),amountReceived:Number(o.sub_total||0),promoDiscount:e?Number(e.discount_amount||0):0,salesDiscount:Number(o.sales_discount||0),approvedDiscount:Number(o.approved_discounts||0),grandTotal:Number(o.total_amount||0),promoName:e?e.promo_name:"—",paidAt:o.payment?.payment_date||null,status:o.status}})),B=D(()=>{const o=C.value.trim().toLowerCase();let e=[...I.value];if(o&&(e=e.filter(a=>[String(a.orderId),a.customer||"",a.user||"",a.type||"",String(a.grandTotal),q(a.paidAt)].join(" ").toLowerCase().includes(o))),s.value.paymentType&&(e=e.filter(a=>(a.type??"").toLowerCase()===s.value.paymentType.toLowerCase())),s.value.priceMin!==null&&s.value.priceMin!==""&&(e=e.filter(a=>(Number(a.grandTotal)||0)>=Number(s.value.priceMin))),s.value.priceMax!==null&&s.value.priceMax!==""&&(e=e.filter(a=>(Number(a.grandTotal)||0)<=Number(s.value.priceMax))),s.value.dateFrom&&(e=e.filter(a=>{if(!a.paidAt)return!1;const n=new Date(a.paidAt),c=new Date(s.value.dateFrom);return c.setHours(0,0,0,0),n>=c})),s.value.dateTo&&(e=e.filter(a=>{if(!a.paidAt)return!1;const n=new Date(a.paidAt),c=new Date(s.value.dateTo);return c.setHours(23,59,59,999),n<=c})),s.value.sortBy)switch(e=[...e],s.value.sortBy){case"date_desc":e.sort((a,n)=>new Date(n.paidAt)-new Date(a.paidAt));break;case"date_asc":e.sort((a,n)=>new Date(a.paidAt)-new Date(n.paidAt));break;case"amount_desc":e.sort((a,n)=>Number(n.grandTotal)-Number(a.grandTotal));break;case"amount_asc":e.sort((a,n)=>Number(a.grandTotal)-Number(n.grandTotal));break;case"order_asc":e.sort((a,n)=>Number(a.orderId)-Number(n.orderId));break;case"order_desc":e.sort((a,n)=>Number(n.orderId)-Number(a.orderId));break}return e}),H=o=>{s.value={...s.value,...o},o.value={...s.value}},U=()=>{s.value={sortBy:"",paymentType:"",dateFrom:"",dateTo:"",priceMin:null,priceMax:null},g.value={sortBy:"",paymentType:"",dateFrom:"",dateTo:"",priceMin:null,priceMax:null}},L=D(()=>({sortOptions:[{value:"date_desc",label:"Date: Newest First"},{value:"date_asc",label:"Date: Oldest First"},{value:"amount_desc",label:"Amount: High to Low"},{value:"amount_asc",label:"Amount: Low to High"},{value:"order_asc",label:"Order ID: Low to High"},{value:"order_desc",label:"Order ID: High to Low"}],paymentTypeOptions:[{value:"Cash",label:"Cash"},{value:"Card",label:"Card"},{value:"Split",label:"Split"},{value:"QR",label:"QR"},{value:"Bank",label:"Bank"}]})),W=D(()=>I.value.length),X=D(()=>{const o=new Date,e=new Date(o.getFullYear(),o.getMonth(),o.getDate()),a=new Date(o.getFullYear(),o.getMonth(),o.getDate()+1);return x.value.filter(n=>{if(!n.created_at||!n.payment)return!1;const c=new Date(n.created_at);return c>=e&&c<a}).length}),Y=D(()=>I.value.reduce((o,e)=>o+Number(e.grandTotal||0),0));function q(o){return o?new Date(o).toLocaleString("en-GB",{day:"2-digit",month:"short",year:"numeric",hour:"numeric",minute:"2-digit",hour12:!0}):"—"}V(()=>window.feather?.replace()),ae(()=>window.feather?.replace());const k=o=>{if(!x.value||x.value.length===0){v.error("No payment data to download");return}const e=x.value.filter(a=>a.payment);if(e.length===0){v.error("No payments found to download");return}try{o==="pdf"?K(e):o==="excel"?J(e):o==="csv"?Q(e):v.error("Invalid download type")}catch(a){console.error("Download failed:",a),v.error(`Download failed: ${a.message}`)}},Q=o=>{try{const e=["Order ID","Date","Customer","Order Type","Payment Type","Amount Received","Cash Amount","Card Amount","Card Brand","Last 4 Digits","Currency","Order Total","Status"],a=o.map(m=>{const p=m.payment||{};return[`"${m.id||""}"`,`"${F(m.created_at)}"`,`"${m.customer_name||"Walk In"}"`,`"${m.type?.order_type||"-"}"`,`"${p.payment_type||"-"}"`,`"${Number(p.amount_received||0).toFixed(2)}"`,`"${Number(p.cash_amount||0).toFixed(2)}"`,`"${Number(p.card_amount||0).toFixed(2)}"`,`"${p.brand||"-"}"`,`"${p.last_digits||"-"}"`,`"${p.currency_code||"GBP"}"`,`"${Number(m.total_amount||0).toFixed(2)}"`,`"${m.status||""}"`]}),n=[e.join(","),...a.map(m=>m.join(","))].join(`
`),c=new Blob([n],{type:"text/csv;charset=utf-8;"}),T=URL.createObjectURL(c),f=document.createElement("a");f.setAttribute("href",T),f.setAttribute("download",`Payments_${new Date().toISOString().split("T")[0]}.csv`),document.body.appendChild(f),f.click(),document.body.removeChild(f),v.success("Payments CSV downloaded successfully")}catch(e){console.error("CSV generation error:",e),v.error(`CSV generation failed: ${e.message}`)}},K=o=>{try{const e=new me("l","mm","a4");e.setFontSize(18),e.setFont("helvetica","bold"),e.text("Payments Report",14,20),e.setFontSize(10),e.setFont("helvetica","normal");const a=new Date().toLocaleString();e.text(`Generated on: ${a}`,14,28),e.text(`Total Payments: ${o.length}`,14,34);const n=o.reduce((r,u)=>r+Number(u.total_amount||0),0),c=o.reduce((r,u)=>r+Number(u.payment?.cash_amount||0),0),T=o.reduce((r,u)=>r+Number(u.payment?.card_amount||0),0);e.text(`Total Revenue: £${n.toFixed(2)}`,14,40),e.text(`Cash: £${c.toFixed(2)} | Card: £${T.toFixed(2)}`,14,46);const f=["Order ID","Date","Customer","Order Type","Payment Type","Amount","Cash","Card","Brand","Status"],m=o.map(r=>{const u=r.payment||{};return[r.id||"",F(r.created_at),r.customer_name||"Walk In",r.type?.order_type||"-",u.payment_type||"-",`£${Number(u.amount_received||0).toFixed(2)}`,`£${Number(u.cash_amount||0).toFixed(2)}`,`£${Number(u.card_amount||0).toFixed(2)}`,u.brand||"-",r.status||""]});pe(e,{head:[f],body:m,startY:52,styles:{fontSize:8,cellPadding:2,halign:"left",lineColor:[0,0,0],lineWidth:.1},headStyles:{fillColor:[41,128,185],textColor:255,fontStyle:"bold"},alternateRowStyles:{fillColor:[245,245,245]},margin:{left:14,right:14},didDrawPage:r=>{const u=e.internal.getNumberOfPages(),$=e.internal.pageSize.height;e.setFontSize(8),e.text(`Page ${r.pageNumber} of ${u}`,r.settings.margin.left,$-10)}});const p=`Payments_${new Date().toISOString().split("T")[0]}.pdf`;e.save(p),v.success("Payments PDF downloaded successfully")}catch(e){console.error("PDF generation error:",e),v.error(`PDF generation failed: ${e.message}`)}},J=o=>{try{if(typeof ye>"u")throw new Error("XLSX library is not loaded");const e=o.map(l=>{const i=l.payment||{};return{"Order ID":l.id||"",Date:F(l.created_at),Time:l.created_at,Customer:l.customer_name||"Walk In","Order Type":l.type?.order_type||"-","Table Number":l.type?.table_number||"-","Payment Type":i.payment_type||"-","Amount Received":Number(i.amount_received||0).toFixed(2),"Cash Amount":Number(i.cash_amount||0).toFixed(2),"Card Amount":Number(i.card_amount||0).toFixed(2),"Card Brand":i.brand||"-","Last 4 Digits":i.last_digits||"-","Exp Month":i.exp_month||"-","Exp Year":i.exp_year||"-",Currency:i.currency_code||"GBP","Order Total":Number(l.total_amount||0).toFixed(2),Status:l.status||"","Refund Status":i.refund_status||"None"}}),a=N.book_new(),n=N.json_to_sheet(e);n["!cols"]=[{wch:10},{wch:12},{wch:15},{wch:20},{wch:12},{wch:12},{wch:12},{wch:15},{wch:12},{wch:12},{wch:12},{wch:12},{wch:10},{wch:10},{wch:10},{wch:12},{wch:10},{wch:15}],N.book_append_sheet(a,n,"Payments");const c=o.reduce((l,i)=>l+Number(i.total_amount||0),0),T=o.reduce((l,i)=>l+Number(i.payment?.cash_amount||0),0),f=o.reduce((l,i)=>l+Number(i.payment?.card_amount||0),0),m=o.filter(l=>l.payment?.payment_type?.toLowerCase()==="cash").length,p=o.filter(l=>l.payment?.payment_type?.toLowerCase()==="card").length,r=o.filter(l=>l.payment?.payment_type?.toLowerCase()==="split").length,u=[{Info:"Generated On",Value:new Date().toLocaleString()},{Info:"Total Payments",Value:o.length},{Info:"Total Revenue",Value:`£${c.toFixed(2)}`},{Info:"Total Cash",Value:`£${T.toFixed(2)}`},{Info:"Total Card",Value:`£${f.toFixed(2)}`},{Info:"Cash Payments Count",Value:m},{Info:"Card Payments Count",Value:p},{Info:"Split Payments Count",Value:r},{Info:"Exported By",Value:"Payment Management System"}],$=N.json_to_sheet(u);N.book_append_sheet(a,$,"Summary");const Z=`Payments_${new Date().toISOString().split("T")[0]}.xlsx`;he(a,Z),v.success("Payments Excel file downloaded successfully")}catch(e){console.error("Excel generation error:",e),v.error(`Excel generation failed: ${e.message}`)}};return(o,e)=>(h(),oe(ie,null,{default:E(()=>[j(y(ne),{title:"Payment"}),t("div",ve,[e[21]||(e[21]=t("h4",{class:"fw-semibold mb-3"},"Overall Payments",-1)),t("div",be,[t("div",fe,[t("div",we,[t("div",ge,[t("div",null,[t("h3",_e,d(W.value),1),e[6]||(e[6]=t("p",{class:"text-muted mb-0 small"},"Total Payments",-1))]),e[7]||(e[7]=t("div",{class:"rounded-circle p-3 bg-primary-subtle text-primary d-flex align-items-center justify-content-center",style:{width:"56px",height:"56px"}},[t("i",{class:"bi bi-list-check fs-4"})],-1))])])]),t("div",xe,[t("div",De,[t("div",Ce,[t("div",null,[t("h3",Te,d(X.value),1),e[8]||(e[8]=t("p",{class:"text-muted mb-0 small"},"Today's Payments",-1))]),e[9]||(e[9]=t("div",{class:"rounded-circle p-3 bg-success-subtle text-success d-flex align-items-center justify-content-center",style:{width:"56px",height:"56px"}},[t("i",{class:"bi bi-calendar-day fs-4"})],-1))])])]),t("div",Ne,[t("div",Fe,[t("div",Pe,[t("div",null,[t("h3",Se,d(y(b)(Y.value,"GBP")),1),e[10]||(e[10]=t("p",{class:"text-muted mb-0 small"},"Total Amount",-1))]),e[11]||(e[11]=t("div",{class:"rounded-circle p-3 bg-warning-subtle text-warning d-flex align-items-center justify-content-center",style:{width:"56px",height:"56px"}},[t("i",{class:"bi bi-currency-pound fs-4"})],-1))])])])]),t("div",Ie,[t("div",ke,[t("div",$e,[e[17]||(e[17]=t("h5",{class:"mb-0 fw-semibold"},"Payments",-1)),t("div",Ae,[t("div",Me,[e[12]||(e[12]=t("i",{class:"bi bi-search"},null,-1)),e[13]||(e[13]=t("input",{type:"email",name:"email",autocomplete:"email",style:{position:"absolute",left:"-9999px",width:"1px",height:"1px"},tabindex:"-1","aria-hidden":"true"},null,-1)),O.value?R((h(),w("input",{id:S,"onUpdate:modelValue":e[0]||(e[0]=a=>C.value=a),key:M.value,class:"form-control search-input",placeholder:"Search by Order ID",type:"search",autocomplete:"new-password",name:S,role:"presentation",onFocus:e[1]||(e[1]=(...a)=>o.handleFocus&&o.handleFocus(...a))},null,32)),[[se,C.value]]):(h(),w("input",Oe))]),j(ce,{modelValue:s.value,"onUpdate:modelValue":e[2]||(e[2]=a=>s.value=a),title:"Payments","modal-id":"paymentFilterModal","modal-size":"modal-lg","sort-options":L.value.sortOptions,"show-price-range":!0,"show-date-range":!0,"show-stock-status":!1,"price-label":"Amount Range",onApply:H,onClear:U},{customFilters:E(({filters:a})=>[t("div",Be,[e[15]||(e[15]=t("label",{class:"form-label fw-semibold text-dark"},[t("i",{class:"fas fa-credit-card me-2 text-muted"}),le("Payment Type ")],-1)),R(t("select",{"onUpdate:modelValue":n=>a.paymentType=n,class:"form-select"},[e[14]||(e[14]=t("option",{value:""},"All",-1)),(h(!0),w(A,null,z(L.value.paymentTypeOptions,n=>(h(),w("option",{key:n.value,value:n.value},d(n.label),9,Ve))),128))],8,Le),[[re,a.paymentType]])])]),_:1},8,["modelValue","sort-options"]),t("div",Ee,[e[16]||(e[16]=t("button",{class:"btn btn-outline-secondary rounded-pill px-4 dropdown-toggle","data-bs-toggle":"dropdown"}," Export ",-1)),t("ul",je,[t("li",null,[t("a",{class:"dropdown-item py-2",href:"javascript:;",onClick:e[3]||(e[3]=a=>k("pdf"))}," Export as PDF ")]),t("li",null,[t("a",{class:"dropdown-item py-2",href:"javascript:;",onClick:e[4]||(e[4]=a=>k("excel"))}," Export as Excel ")]),t("li",null,[t("a",{class:"dropdown-item py-2",href:"javascript:;",onClick:e[5]||(e[5]=a=>k("csv"))}," Export as CSV ")])])])])]),t("div",Re,[t("table",ze,[e[20]||(e[20]=t("thead",{class:"border-top small text-muted"},[t("tr",null,[t("th",null,"S. #"),t("th",null,"Order ID"),t("th",null,"Actual Payment"),t("th",null,"Promo Name"),t("th",null,"Promo Discount"),t("th",null,"Sales Discount"),t("th",null,"Approved Discount"),t("th",null,"Tax"),t("th",null,"Service Charges"),t("th",null,"Delivery Charges"),t("th",null,"Grand Total"),t("th",null,"Payment Date"),t("th",null,"Payment Type")])],-1)),t("tbody",null,[P.value?(h(),w("tr",Ge,[...e[18]||(e[18]=[t("td",{colspan:"11",class:"text-center py-5"},[t("div",{class:"d-flex flex-column align-items-center justify-content-center"},[t("div",{class:"spinner-border mb-3",role:"status",style:{color:"#1B1670",width:"3rem",height:"3rem","border-width":"0.3em"}},[t("span",{class:"visually-hidden"},"Loading...")]),t("div",{class:"fw-semibold text-muted"},"Loading Payments...")])],-1)])])):(h(),w(A,{key:1},[(h(!0),w(A,null,z(B.value,(a,n)=>(h(),w("tr",{key:a.orderId},[t("td",null,d(n+1),1),t("td",null,d(a.orderId),1),t("td",null,d(y(b)(a.amountReceived)),1),t("td",null,d(a.promoName),1),t("td",He,d(a.promoDiscount?y(b)(a.promoDiscount):"—"),1),t("td",Ue,d(a.salesDiscount?y(b)(a.salesDiscount):"—"),1),t("td",We,d(a.approvedDiscount?y(b)(a.approvedDiscount):"—"),1),t("td",null,d(y(b)(a.tax)),1),t("td",null,d(y(b)(a.serviceCharges)),1),t("td",null,d(y(b)(a.deliveryCharges)),1),t("td",null,d(y(b)(a.grandTotal)),1),t("td",null,d(y(F)(a.paidAt)),1),t("td",Xe,d(a.type),1)]))),128)),!P.value&&B.value.length===0?(h(),w("tr",Ye,[...e[19]||(e[19]=[t("td",{colspan:"13",class:"text-center text-muted py-4"}," No payments found. ",-1)])])):de("",!0)],64))])])])])])])]),_:1}))}},rt=ee(qe,[["__scopeId","data-v-9cdf9084"]]);export{rt as default};

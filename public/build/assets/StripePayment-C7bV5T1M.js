import{_,q as v,r as i,j as f,k as T,m as l,g as m,o as u,b as a,t as w,f as N,A as x}from"./app-CKq2yLFP.js";const P={class:"mt-3 mb-2"},D=["disabled"],k={key:0},C={key:1,class:"d-inline-flex align-items-center gap-2"},I="#1C0D82",F={__name:"StripePayment",props:{order_code:String,show:Boolean,customer:String,orderType:String,selectedTable:Object,orderItems:Array,grandTotal:Number,money:Function,cashReceived:Number,cardPayment:Number,subTotal:Number,tax:Number,serviceCharges:Number,deliveryCharges:Number,note:[String,null],kitchenNote:[String,null],orderDate:String,orderTime:String,paymentMethod:String,paymentType:String,change:Number,type:String,cardCharge:Number,promoDiscount:{type:Number,default:0},promoId:{type:[Number,String,null],default:null},promoName:{type:[String,null],default:null},promoType:{type:[String,null],default:null},promoDiscountAmount:{type:Number,default:0}},setup(y){const e=y,b=v(),n=i(null),s=i(null),g=i(null),c=i(!1),o=i(!1);let d=null;async function S(){try{const r={amount:e.grandTotal??0,currency:"gbp",order_code:e.order_code??null},{data:t}=await x.post(route("stripe.pi.create"),r,{headers:{"X-Idempotency-Key":crypto.randomUUID?.()??String(Date.now())}});g.value=t.client_secret}catch(r){throw console.error(r),l.error("Could not start card payment. Please try again."),r}}async function p(){n.value=window.Stripe(b.props.stripe_public_key),await S();const r={theme:"stripe",variables:{colorPrimary:I,colorText:"#0b1020",colorTextPlaceholder:"#98A2B3",colorBackground:"#FFFFFF",colorDanger:"#E5484D",borderRadius:"12px",fontFamily:'Inter, Poppins, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial'},rules:{".Label":{fontWeight:"600"},".Input":{boxShadow:"0 1px 2px rgba(0,0,0,.06)",padding:"12px"},".Tab, .Block":{borderRadius:"12px"},".Error":{color:"#E5484D"}}};s.value=n.value.elements({clientSecret:g.value,appearance:r}),d&&d.unmount?.(),d=s.value.create("payment"),d.mount("#payment-element"),c.value=!0}async function h(){if(!n.value||!s.value||!c.value){l.error("Payment is not ready yet. Please wait a moment.");return}o.value=!0;const r=new URLSearchParams({order_code:e.order_code??"",customer_name:e.customer??"",sub_total:String(e.subTotal??e.grandTotal??0),total_amount:String(e.grandTotal??0),promo_discount:String(e.promoDiscount??0),promo_id:String(e.promoId??""),promo_name:String(e.promoName??""),promo_type:String(e.promoType??""),cardCharge:String(e.cardCharge??0),type:String(e.type??0),tax:String(e.tax??0),service_charges:String(e.serviceCharges??0),delivery_charges:String(e.deliveryCharges??0),note:e.note??"",kitchen_note:e.kitchenNote??"",order_date:e.orderDate??new Date().toISOString().split("T")[0],order_time:e.orderTime??new Date().toTimeString().split(" ")[0],order_type:e.orderType==="Dine_in"?"Dine In":e.orderType==="Delivery"?"Delivery":e.orderType==="Takeaway"?"Takeaway":"Collection",table_number:e.selectedTable?.name??"",payment_method:e.paymentMethod??"Stripe",payment_type:e.paymentType??e.paymentMethod,cash_received:String(e.cashReceived??e.grandTotal??0),card_payment:String(e.cardPayment??0),change:String(e.change??0),items:JSON.stringify((e.orderItems??[]).map(t=>({product_id:t.id,title:t.title,quantity:t.qty,price:t.price,note:t.note??null,kitchen_note:t.kitchenNote??null})))});try{const{error:t}=await n.value.confirmPayment({elements:s.value,confirmParams:{return_url:`${window.location.origin}/pos/place-stripe-order?${r.toString()}`}});if(t){l.error(t.message||"Payment failed. Please try again."),o.value=!1;return}}catch(t){console.error(t),l.error("Something went wrong while confirming payment."),o.value=!1}}return f(()=>e.grandTotal,async(r,t)=>{r!==t&&n.value&&(c.value=!1,await p())}),T(async()=>{if(window.Stripe)await p();else{const r=document.createElement("script");r.src="https://js.stripe.com/v3/",r.addEventListener("load",p),r.addEventListener("error",()=>l.error("Could not load Stripe. Check your network and try again.")),document.body.appendChild(r)}}),(r,t)=>(u(),m("div",P,[t[1]||(t[1]=a("div",{class:"pay-header d-flex align-items-center gap-2 mb-3"},[a("i",{class:"bi bi-credit-card-2-front-fill"}),a("h6",{class:"m-0"},"Pay with Card")],-1)),t[2]||(t[2]=a("div",{id:"payment-element",class:"stripe-box rounded-4 p-3"},null,-1)),a("button",{type:"button",class:"btn btn-primary pay-btn rounded-pill mt-3 d-inline-flex align-items-center justify-content-center",disabled:!c.value||o.value,onClick:h},[o.value?(u(),m("span",C,[...t[0]||(t[0]=[N(" Processing… ",-1),a("span",{class:"spinner-border spinner-border-sm",role:"status","aria-hidden":"true"},null,-1)])])):(u(),m("span",k,"Pay £"+w((y.grandTotal??0).toFixed(2)),1))],8,D)]))}},E=_(F,[["__scopeId","data-v-1e4f3ecd"]]);export{E as default};
